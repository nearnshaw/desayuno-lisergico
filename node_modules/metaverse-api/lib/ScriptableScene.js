"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
const _1 = require(".");
const future_1 = require("./utils/future");
exports.defer = Promise.resolve().then.bind(Promise.resolve());
/** Managed queue of dirty components to be re-rendered */
let items = [];
function enqueueRender(scene) {
    if (!scene._dirty) {
        scene._dirty = true;
        if (items.push(scene) === 1) {
            exports.defer(rerender);
        }
    }
}
function rerender() {
    let p;
    const list = items;
    items = [];
    // tslint:disable-next-line:no-conditional-assignment
    while ((p = list.pop())) {
        if (p._dirty)
            renderScriptableScene(p);
    }
}
function filterNonFalsy($) {
    return !!$;
}
function recursiveRender(tree) {
    if (typeof tree === 'string') {
        // tslint:disable-next-line:no-console
        console.error('Warning, you are trying to render a text');
        return null;
    }
    if (typeof tree.tag === 'function') {
        const hoc = tree.tag;
        if (hoc.prototype && hoc.prototype.render) {
            throw new Error('Only function components are allowed');
        }
        return hoc(Object.assign({}, tree.attrs, { children: tree.children }));
    }
    if (!tree || !tree.tag)
        return null;
    return {
        tag: tree.tag,
        attrs: tree.attrs,
        children: tree.children.map(recursiveRender).filter(filterNonFalsy)
    };
}
exports.recursiveRender = recursiveRender;
/**
 * Render a ScriptableScene, triggering necessary lifecycle events and taking High-Order ScriptableScenes into account.
 * @param {ScriptableScene} scene
 * @internal
 */
function renderScriptableScene(scene, force) {
    let props = scene.props;
    let state = scene.state;
    let previousProps = scene.prevProps || props;
    let previousState = scene.prevState || state;
    let skip = false;
    const isUpdate = !!scene._component;
    // if updating
    if (isUpdate) {
        scene.props = previousProps;
        scene.state = previousState;
        if (!force && scene.shouldSceneUpdate && scene.shouldSceneUpdate(props, state) === false) {
            skip = true;
        }
        scene.props = props;
        scene.state = state;
    }
    scene.prevProps = scene.prevState = null;
    scene._dirty = false;
    if (!skip) {
        let rendererResult = scene.render(props, state);
        if (!('then' in rendererResult && 'catch' in rendererResult)) {
            rendererResult = Promise.resolve(rendererResult);
        }
        rendererResult
            .then(recursiveRender)
            .then(async (rendered) => {
            if (!rendered) {
                throw new Error('the async render() method yielded an empty result');
            }
            scene._component = rendered;
            if (scene.sceneDidUpdate) {
                await scene.sceneDidUpdate(previousProps, previousState);
            }
            await scene.connectionFuture;
            try {
                // TODO(agus): diff/patch
                await scene.entityController.render(rendered);
            }
            catch (e) {
                if (e.message === _1.Constants.ReplaceWholeTreeException) {
                    await scene.entityController.render(rendered);
                }
                else {
                    throw e;
                }
            }
        })
            .catch(err => {
            // tslint:disable-next-line:no-console
            console.error(err);
        });
    }
}
exports.renderScriptableScene = renderScriptableScene;
/**
 * Base Scene class.
 * Provides `setState()` and `forceUpdate()`, which trigger rendering.
 * @public
 *
 * @example
 * class MyFoo extends ScriptableScene {
 *   async render() {
 *     return <sphere />;
 *   }
 * }
 */
class ScriptableScene extends _1.Script {
    constructor() {
        super(...arguments);
        this._dirty = true;
        this.prevProps = null;
        this.prevState = null;
        this._component = null;
        this.state = {};
        this.connectionFuture = future_1.future();
    }
    /**
     * Update scene state by copying properties from `state` to `this.state`.
     * @param {object} state A hash of state properties to update with new values
     */
    setState(state) {
        let s = this.state;
        if (!this.prevState)
            this.prevState = Object.assign({}, s);
        Object.assign(s, typeof state === 'function' ? state(s, this.props) : state);
        enqueueRender(this);
    }
    /**
     * Immediately perform a synchronous re-render of the component.
     */
    forceUpdate() {
        renderScriptableScene(this, true);
    }
    /**
     * It makes a subscription to remote events, those events occur in the context of the game and are sent thru the wire
     * protocol.
     *
     * @param event name of the remote event to listen
     * @param handler an async
     */
    subscribeTo(event, handler) {
        // tslint:disable-next-line:no-floating-promises
        this.connectionFuture.then(() => {
            this.eventSubscriber.on(event, x => {
                const ret = handler(x.data);
                if (ret && 'catch' in ret && typeof ret.catch === 'function') {
                    ret.catch(err => this.emit('error', err));
                }
            });
        });
    }
    async systemDidEnable() {
        this.props = (await this.entityController.getOwnAttributes());
        // we create an event subscriber
        this.eventSubscriber = new _1.EventSubscriber(this.entityController);
        this.on('SIGKILL', () => {
            if (this.sceneWillUnmount) {
                this.sceneWillUnmount();
            }
        });
        this.subscribeTo('setAttributes', newProps => {
            this.prevProps = this.props;
            this.props = newProps;
            enqueueRender(this);
        });
        this.connectionFuture.resolve(this);
        renderScriptableScene(this, true);
        if (this.sceneDidMount) {
            await this.sceneDidMount();
        }
    }
}
__decorate([
    _1.inject('EntityController'),
    __metadata("design:type", Object)
], ScriptableScene.prototype, "entityController", void 0);
exports.ScriptableScene = ScriptableScene;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2NyaXB0YWJsZVNjZW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL1NjcmlwdGFibGVTY2VuZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBLHdCQUF1SDtBQUV2SCwyQ0FBdUM7QUFFMUIsUUFBQSxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUE7QUFFbkUsMERBQTBEO0FBRTFELElBQUksS0FBSyxHQUFnQyxFQUFFLENBQUE7QUFFM0MsdUJBQTZCLEtBQTRCO0lBQ3ZELElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFO1FBQ2pCLEtBQUssQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFBO1FBQ25CLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDM0IsYUFBSyxDQUFDLFFBQVEsQ0FBQyxDQUFBO1NBQ2hCO0tBQ0Y7QUFDSCxDQUFDO0FBRUQ7SUFDRSxJQUFJLENBQThCLENBQUE7SUFDbEMsTUFBTSxJQUFJLEdBQXNCLEtBQUssQ0FBQTtJQUNyQyxLQUFLLEdBQUcsRUFBRSxDQUFBO0lBQ1YscURBQXFEO0lBQ3JELE9BQU8sQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUU7UUFDdkIsSUFBSSxDQUFDLENBQUMsTUFBTTtZQUFFLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxDQUFBO0tBQ3ZDO0FBQ0gsQ0FBQztBQUVELHdCQUF3QixDQUFNO0lBQzVCLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQTtBQUNaLENBQUM7QUFFRCx5QkFBZ0MsSUFBcUI7SUFDbkQsSUFBSSxPQUFPLElBQUksS0FBSyxRQUFRLEVBQUU7UUFDNUIsc0NBQXNDO1FBQ3RDLE9BQU8sQ0FBQyxLQUFLLENBQUMsMENBQTBDLENBQUMsQ0FBQTtRQUN6RCxPQUFP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RUFBRSxDQUFBO2FBQ3hCO1FBQ0gsQ0FBQyxDQUFDLENBQUE7UUFFRixJQUFJLENBQUMsV0FBVyxDQUFDLGVBQWUsRUFBRSxRQUFRLENBQUMsRUFBRTtZQUMzQyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUE7WUFDM0IsSUFBSSxDQUFDLEtBQUssR0FBRyxRQUFpQixDQUFBO1lBQzlCLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUNyQixDQUFDLENBQUMsQ0FBQTtRQUVGLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUE7UUFFbkMscUJBQXFCLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFBO1FBRWpDLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRTtZQUN0QixNQUFNLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQTtTQUMzQjtJQUNILENBQUM7Q0FDRjtBQXZGNkI7SUFBM0IsU0FBTSxDQUFDLGtCQUFrQixDQUFDOzt5REFBb0M7QUFEakUsMENBd0ZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2NyaXB0LCBpbmplY3QsIEVudGl0eUNvbnRyb2xsZXIsIElTaW1wbGlmaWVkTm9kZSwgRXZlbnRTdWJzY3JpYmVyLCBDb25zdGFudHMsIElFdmVudE5hbWVzLCBJRXZlbnRzIH0gZnJvbSAnLidcblxuaW1wb3J0IHsgZnV0dXJlIH0gZnJvbSAnLi91dGlscy9mdXR1cmUnXG5cbmV4cG9ydCBjb25zdCBkZWZlciA9IFByb21pc2UucmVzb2x2ZSgpLnRoZW4uYmluZChQcm9taXNlLnJlc29sdmUoKSlcblxuLyoqIE1hbmFnZWQgcXVldWUgb2YgZGlydHkgY29tcG9uZW50cyB0byBiZSByZS1yZW5kZXJlZCAqL1xuXG5sZXQgaXRlbXM6IFNjcmlwdGFibGVTY2VuZTxhbnksIGFueT5bXSA9IFtdXG5cbmZ1bmN0aW9uIGVucXVldWVSZW5kZXI8RCwgVD4oc2NlbmU6IFNjcmlwdGFibGVTY2VuZTxELCBUPikge1xuICBpZiAoIXNjZW5lLl9kaXJ0eSkge1xuICAgIHNjZW5lLl9kaXJ0eSA9IHRydWVcbiAgICBpZiAoaXRlbXMucHVzaChzY2VuZSkgPT09IDEpIHtcbiAgICAgIGRlZmVyKHJlcmVuZGVyKVxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiByZXJlbmRlcigpIHtcbiAgbGV0IHA6IFNjcmlwdGFibGVTY2VuZSB8IHVuZGVmaW5lZFxuICBjb25zdCBsaXN0OiBTY3JpcHRhYmxlU2NlbmVbXSA9IGl0ZW1zXG4gIGl0ZW1zID0gW11cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWNvbmRpdGlvbmFsLWFzc2lnbm1lbnRcbiAgd2hpbGUgKChwID0gbGlzdC5wb3AoKSkpIHtcbiAgICBpZiAocC5fZGlydHkpIHJlbmRlclNjcmlwdGFibGVTY2VuZShwKVxuICB9XG59XG5cbmZ1bmN0aW9uIGZpbHRlck5vbkZhbHN5KCQ6IGFueSk6ICQgaXMgdHJ1ZSB7XG4gIHJldHVybiAhISRcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlY3Vyc2l2ZVJlbmRlcih0cmVlOiBJU2ltcGxpZmllZE5vZGUpOiBJU2ltcGxpZmllZE5vZGUgfCBudWxsIHtcbiAgaWYgKHR5cGVvZiB0cmVlID09PSAnc3RyaW5nJykge1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25zb2xlXG4gICAgY29uc29sZS5lcnJvcignV2FybmluZywgeW91IGFyZSB0cnlpbmcgdG8gcmVuZGVyIGEgdGV4dCcpXG4gICAgcmV0dXJuIG51bGxcbiAgfVxuXG4gIGlmICh0eXBlb2YgKHRyZWUudGFnIGFzIGFueSkgPT09ICdmdW5jdGlvbicpIHtcbiAgICBjb25zdCBob2MgPSAodHJlZS50YWcgYXMgYW55KSBhcyBGdW5jdGlvblxuICAgIGlmIChob2MucHJvdG90eXBlICYmIGhvYy5wcm90b3R5cGUucmVuZGVyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ09ubHkgZnVuY3Rpb24gY29tcG9uZW50cyBhcmUgYWxsb3dlZCcpXG4gICAgfVxuICAgIHJldHVybiBob2MoeyAuLi50cmVlLmF0dHJzLCBjaGlsZHJlbjogdHJlZS5jaGlsZHJlbiB9KVxuICB9XG5cbiAgaWYgKCF0cmVlIHx8ICF0cmVlLnRhZykgcmV0dXJuIG51bGxcblxuICByZXR1cm4ge1xuICAgIHRhZzogdHJlZS50YWcsXG4gICAgYXR0cnM6IHRyZWUuYXR0cnMsXG4gICAgY2hpbGRyZW46ICh0cmVlLmNoaWxkcmVuLm1hcChyZWN1cnNpdmVSZW5kZXIpLmZpbHRlcihmaWx0ZXJOb25GYWxzeSkgYXMgYW55KSBhcyBJU2ltcGxpZmllZE5vZGVbXVxuICB9XG59XG5cbi8qKlxuICogUmVuZGVyIGEgU2NyaXB0YWJsZVNjZW5lLCB0cmlnZ2VyaW5nIG5lY2Vzc2FyeSBsaWZlY3ljbGUgZXZlbnRzIGFuZCB0YWtpbmcgSGlnaC1PcmRlciBTY3JpcHRhYmxlU2NlbmVzIGludG8gYWNjb3VudC5cbiAqIEBwYXJhbSB7U2NyaXB0YWJsZVNjZW5lfSBzY2VuZVxuICogQGludGVybmFsXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZW5kZXJTY3JpcHRhYmxlU2NlbmU8UHJvcHMsIFN0YXRlPihzY2VuZTogU2NyaXB0YWJsZVNjZW5lPFByb3BzLCBTdGF0ZT4sIGZvcmNlPzogYm9vbGVhbikge1xuICBsZXQgcHJvcHMgPSBzY2VuZS5wcm9wc1xuICBsZXQgc3RhdGUgPSBzY2VuZS5zdGF0ZVxuICBsZXQgcHJldmlvdXNQcm9wcyA9IHNjZW5lLnByZXZQcm9wcyB8fCBwcm9wc1xuICBsZXQgcHJldmlvdXNTdGF0ZSA9IHNjZW5lLnByZXZTdGF0ZSB8fCBzdGF0ZVxuICBsZXQgc2tpcCA9IGZhbHNlXG4gIGNvbnN0IGlzVXBkYXRlID0gISFzY2VuZS5fY29tcG9uZW50XG5cbiAgLy8gaWYgdXBkYXRpbmdcbiAgaWYgKGlzVXBkYXRlKSB7XG4gICAgc2NlbmUucHJvcHMgPSBwcmV2aW91c1Byb3BzXG4gICAgc2NlbmUuc3RhdGUgPSBwcmV2aW91c1N0YXRlXG4gICAgaWYgKCFmb3JjZSAmJiBzY2VuZS5zaG91bGRTY2VuZVVwZGF0ZSAmJiBzY2VuZS5zaG91bGRTY2VuZVVwZGF0ZShwcm9wcywgc3RhdGUpID09PSBmYWxzZSkge1xuICAgICAgc2tpcCA9IHRydWVcbiAgICB9XG4gICAgc2NlbmUucHJvcHMgPSBwcm9wc1xuICAgIHNjZW5lLnN0YXRlID0gc3RhdGVcbiAgfVxuXG4gIHNjZW5lLnByZXZQcm9wcyA9IHNjZW5lLnByZXZTdGF0ZSA9IG51bGxcbiAgc2NlbmUuX2RpcnR5ID0gZmFsc2VcblxuICBpZiAoIXNraXApIHtcbiAgICBsZXQgcmVuZGVyZXJSZXN1bHQgPSBzY2VuZS5yZW5kZXIocHJvcHMsIHN0YXRlKVxuXG4gICAgaWYgKCEoJ3RoZW4nIGluIHJlbmRlcmVyUmVzdWx0ICYmICdjYXRjaCcgaW4gcmVuZGVyZXJSZXN1bHQpKSB7XG4gICAgICByZW5kZXJlclJlc3VsdCA9IFByb21pc2UucmVzb2x2ZShyZW5kZXJlclJlc3VsdClcbiAgICB9XG5cbiAgICByZW5kZXJlclJlc3VsdFxuICAgICAgLnRoZW4ocmVjdXJzaXZlUmVuZGVyKVxuICAgICAgLnRoZW4oYXN5bmMgcmVuZGVyZWQgPT4ge1xuICAgICAgICBpZiAoIXJlbmRlcmVkKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCd0aGUgYXN5bmMgcmVuZGVyKCkgbWV0aG9kIHlpZWxkZWQgYW4gZW1wdHkgcmVzdWx0JylcbiAgICAgICAgfVxuXG4gICAgICAgIHNjZW5lLl9jb21wb25lbnQgPSByZW5kZXJlZFxuXG4gICAgICAgIGlmIChzY2VuZS5zY2VuZURpZFVwZGF0ZSkge1xuICAgICAgICAgIGF3YWl0IHNjZW5lLnNjZW5lRGlkVXBkYXRlKHByZXZpb3VzUHJvcHMsIHByZXZpb3VzU3RhdGUpXG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCBzY2VuZS5jb25uZWN0aW9uRnV0dXJlXG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAvLyBUT0RPKGFndXMpOiBkaWZmL3BhdGNoXG4gICAgICAgICAgYXdhaXQgc2NlbmUuZW50aXR5Q29udHJvbGxlci5yZW5kZXIocmVuZGVyZWQpXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICBpZiAoZS5tZXNzYWdlID09PSBDb25zdGFudHMuUmVwbGFjZVdob2xlVHJlZUV4Y2VwdGlvbikge1xuICAgICAgICAgICAgYXdhaXQgc2NlbmUuZW50aXR5Q29udHJvbGxlci5yZW5kZXIocmVuZGVyZWQpXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IGVcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWNvbnNvbGVcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnIpXG4gICAgICB9KVxuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2NyaXB0YWJsZVNjZW5lPFByb3BzLCBTdGF0ZT4ge1xuICBwcm9wczogUHJvcHNcbiAgc3RhdGU6IFN0YXRlXG5cbiAgLyoqXG4gICAqIENhbGxlZCB0byBkZXRlcm1pbmUgd2hldGhlciB0aGUgY2hhbmdlIGluIHByb3BzIGFuZCBzdGF0ZSBzaG91bGQgdHJpZ2dlciBhIHJlLXJlbmRlci5cbiAgICpcbiAgICogSWYgZmFsc2UgaXMgcmV0dXJuZWQsIGBTY3JpcHRhYmxlU2NlbmUjcmVuZGVyYCwgYW5kIGBzY2VuZURpZFVwZGF0ZWAgd2lsbCBub3QgYmUgY2FsbGVkLlxuICAgKi9cbiAgc2hvdWxkU2NlbmVVcGRhdGU/KG5leHRQcm9wczogUHJvcHMsIG5leHRTdGF0ZTogU3RhdGUpOiBQcm9taXNlPGJvb2xlYW4+IHwgYm9vbGVhblxuXG4gIC8qKlxuICAgKiBDYWxsZWQgaW1tZWRpYXRlbHkgYmVmb3JlIGEgc2NlbmUgaXMgZGVzdHJveWVkLiBQZXJmb3JtIGFueSBuZWNlc3NhcnkgY2xlYW51cCBpbiB0aGlzIG1ldGhvZCwgc3VjaCBhc1xuICAgKiBjYW5jZWxsZWQgbmV0d29yayByZXF1ZXN0cywgb3IgY2xlYW5pbmcgdXAgYW55IGVsZW1lbnRzIGNyZWF0ZWQgaW4gYHNjZW5lRGlkTW91bnRgLlxuICAgKi9cbiAgc2NlbmVXaWxsVW5tb3VudD8oKTogUHJvbWlzZTx2b2lkPiB8IHZvaWRcblxuICAvKipcbiAgICogQ2FsbGVkIGltbWVkaWF0ZWx5IGFmdGVyIGEgY29tcG9tZW50IGlzIG1vdW50ZWQuIFNldHRpbmcgc3RhdGUgaGVyZSB3aWxsIHRyaWdnZXIgcmUtcmVuZGVyaW5nLlxuICAgKi9cbiAgc2NlbmVEaWRNb3VudD8oKTogUHJvbWlzZTx2b2lkPiB8IHZvaWRcblxuICAvKipcbiAgICogQ2FsbGVkIGltbWVkaWF0ZWx5IGFmdGVyIHVwZGF0aW5nIG9jY3Vycy4gTm90IGNhbGxlZCBmb3IgdGhlIGluaXRpYWwgcmVuZGVyLlxuICAgKi9cbiAgc2NlbmVEaWRVcGRhdGU/KHByZXZQcm9wczogUmVhZG9ubHk8UHJvcHM+LCBwcmV2U3RhdGU6IFJlYWRvbmx5PFN0YXRlPik6IFByb21pc2U8dm9pZD4gfCB2b2lkXG59XG5cbi8qKlxuICogQmFzZSBTY2VuZSBjbGFzcy5cbiAqIFByb3ZpZGVzIGBzZXRTdGF0ZSgpYCBhbmQgYGZvcmNlVXBkYXRlKClgLCB3aGljaCB0cmlnZ2VyIHJlbmRlcmluZy5cbiAqIEBwdWJsaWNcbiAqXG4gKiBAZXhhbXBsZVxuICogY2xhc3MgTXlGb28gZXh0ZW5kcyBTY3JpcHRhYmxlU2NlbmUge1xuICogICBhc3luYyByZW5kZXIoKSB7XG4gKiAgICAgcmV0dXJuIDxzcGhlcmUgLz47XG4gKiAgIH1cbiAqIH1cbiAqL1xuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFNjcmlwdGFibGVTY2VuZTxQcm9wcyA9IHt9LCBTdGF0ZSA9IHt9PiBleHRlbmRzIFNjcmlwdCB7XG4gIEBpbmplY3QoJ0VudGl0eUNvbnRyb2xsZXInKSBlbnRpdHlDb250cm9sbGVyITogRW50aXR5Q29udHJvbGxlclxuXG4gIGV2ZW50U3Vic2NyaWJlciE6IEV2ZW50U3Vic2NyaWJlclxuXG4gIF9kaXJ0eSA9IHRydWVcblxuICBwcmV2UHJvcHM6IFByb3BzIHwgbnVsbCA9IG51bGxcbiAgcHJldlN0YXRlOiBTdGF0ZSB8IG51bGwgPSBudWxsXG4gIF9jb21wb25lbnQ6IElTaW1wbGlmaWVkTm9kZSB8IG51bGwgPSBudWxsXG5cbiAgc3RhdGU6IFN0YXRlID0ge30gYXMgU3RhdGVcblxuICBjb25uZWN0aW9uRnV0dXJlID0gZnV0dXJlPFNjcmlwdD4oKVxuXG4gIHByb3BzITogUHJvcHNcblxuICAvKipcbiAgICogVXBkYXRlIHNjZW5lIHN0YXRlIGJ5IGNvcHlpbmcgcHJvcGVydGllcyBmcm9tIGBzdGF0ZWAgdG8gYHRoaXMuc3RhdGVgLlxuICAgKiBAcGFyYW0ge29iamVjdH0gc3RhdGUgQSBoYXNoIG9mIHN0YXRlIHByb3BlcnRpZXMgdG8gdXBkYXRlIHdpdGggbmV3IHZhbHVlc1xuICAgKi9cbiAgc2V0U3RhdGUoc3RhdGU6IFBhcnRpYWw8U3RhdGU+IHwgKChzdGF0ZTogU3RhdGUsIHByb3BzOiBQcm9wcykgPT4gUGFydGlhbDxTdGF0ZT4pKTogdm9pZCB7XG4gICAgbGV0IHMgPSB0aGlzLnN0YXRlXG4gICAgaWYgKCF0aGlzLnByZXZTdGF0ZSkgdGhpcy5wcmV2U3RhdGUgPSBPYmplY3QuYXNzaWduKHt9LCBzKVxuICAgIE9iamVjdC5hc3NpZ24ocywgdHlwZW9mIHN0YXRlID09PSAnZnVuY3Rpb24nID8gc3RhdGUocywgdGhpcy5wcm9wcykgOiBzdGF0ZSlcbiAgICBlbnF1ZXVlUmVuZGVyKHRoaXMpXG4gIH1cblxuICAvKipcbiAgICogSW1tZWRpYXRlbHkgcGVyZm9ybSBhIHN5bmNocm9ub3VzIHJlLXJlbmRlciBvZiB0aGUgY29tcG9uZW50LlxuICAgKi9cbiAgZm9yY2VVcGRhdGUoKSB7XG4gICAgcmVuZGVyU2NyaXB0YWJsZVNjZW5lKHRoaXMsIHRydWUpXG4gIH1cblxuICAvKipcbiAgICogQWNjZXB0cyBgcHJvcHNgIGFuZCBgc3RhdGVgLCBhbmQgcmV0dXJucyBhIG5ldyBWaXJ0dWFsIERPTSB0cmVlIHRvIGJ1aWxkLlxuICAgKiBWaXJ0dWFsIERPTSBpcyBnZW5lcmFsbHkgY29uc3RydWN0ZWQgdmlhIFtKU1hdKGh0dHA6Ly9qYXNvbmZvcm1hdC5jb20vd3RmLWlzLWpzeCkuXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBwcm9wcyAgICBQcm9wcyAoZWc6IEpTWCBhdHRyaWJ1dGVzKSByZWNlaXZlZCBmcm9tIHBhcmVudCBlbGVtZW50L2NvbXBvbmVudFxuICAgKiBAcGFyYW0ge29iamVjdH0gc3RhdGUgICAgVGhlIGNvbXBvbmVudCdzIGN1cnJlbnQgc3RhdGVcbiAgICovXG4gIGFic3RyYWN0IGFzeW5jIHJlbmRlcihwcm9wczogUHJvcHMsIHN0YXRlOiBTdGF0ZSk6IFByb21pc2U8SVNpbXBsaWZpZWROb2RlPlxuXG4gIC8qKlxuICAgKiBJdCBtYWtlcyBhIHN1YnNjcmlwdGlvbiB0byByZW1vdGUgZXZlbnRzLCB0aG9zZSBldmVudHMgb2NjdXIgaW4gdGhlIGNvbnRleHQgb2YgdGhlIGdhbWUgYW5kIGFyZSBzZW50IHRocnUgdGhlIHdpcmVcbiAgICogcHJvdG9jb2wuXG4gICAqXG4gICAqIEBwYXJhbSBldmVudCBuYW1lIG9mIHRoZSByZW1vdGUgZXZlbnQgdG8gbGlzdGVuXG4gICAqIEBwYXJhbSBoYW5kbGVyIGFuIGFzeW5jXG4gICAqL1xuICBzdWJzY3JpYmVUbzxUIGV4dGVuZHMgSUV2ZW50TmFtZXM+KGV2ZW50OiBULCBoYW5kbGVyOiAoZGF0YTogSUV2ZW50c1tUXSkgPT4gdm9pZCB8IFByb21pc2U8dm9pZD4pIHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICB0aGlzLmNvbm5lY3Rpb25GdXR1cmUudGhlbigoKSA9PiB7XG4gICAgICB0aGlzLmV2ZW50U3Vic2NyaWJlci5vbihldmVudCwgeCA9PiB7XG4gICAgICAgIGNvbnN0IHJldCA9IGhhbmRsZXIoeC5kYXRhKVxuICAgICAgICBpZiAocmV0ICYmICdjYXRjaCcgaW4gcmV0ICYmIHR5cGVvZiByZXQuY2F0Y2ggPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICByZXQuY2F0Y2goZXJyID0+IHRoaXMuZW1pdCgnZXJyb3InLCBlcnIpKVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0pXG4gIH1cblxuICBhc3luYyBzeXN0ZW1EaWRFbmFibGUoKSB7XG4gICAgdGhpcy5wcm9wcyA9IChhd2FpdCB0aGlzLmVudGl0eUNvbnRyb2xsZXIuZ2V0T3duQXR0cmlidXRlcygpKSBhcyBQcm9wc1xuXG4gICAgLy8gd2UgY3JlYXRlIGFuIGV2ZW50IHN1YnNjcmliZXJcbiAgICB0aGlzLmV2ZW50U3Vic2NyaWJlciA9IG5ldyBFdmVudFN1YnNjcmliZXIodGhpcy5lbnRpdHlDb250cm9sbGVyKVxuXG4gICAgdGhpcy5vbignU0lHS0lMTCcsICgpID0+IHtcbiAgICAgIGlmICh0aGlzLnNjZW5lV2lsbFVubW91bnQpIHtcbiAgICAgICAgdGhpcy5zY2VuZVdpbGxVbm1vdW50KClcbiAgICAgIH1cbiAgICB9KVxuXG4gICAgdGhpcy5zdWJzY3JpYmVUbygnc2V0QXR0cmlidXRlcycsIG5ld1Byb3BzID0+IHtcbiAgICAgIHRoaXMucHJldlByb3BzID0gdGhpcy5wcm9wc1xuICAgICAgdGhpcy5wcm9wcyA9IG5ld1Byb3BzIGFzIFByb3BzXG4gICAgICBlbnF1ZXVlUmVuZGVyKHRoaXMpXG4gICAgfSlcblxuICAgIHRoaXMuY29ubmVjdGlvbkZ1dHVyZS5yZXNvbHZlKHRoaXMpXG5cbiAgICByZW5kZXJTY3JpcHRhYmxlU2NlbmUodGhpcywgdHJ1ZSlcblxuICAgIGlmICh0aGlzLnNjZW5lRGlkTW91bnQpIHtcbiAgICAgIGF3YWl0IHRoaXMuc2NlbmVEaWRNb3VudCgpXG4gICAgfVxuICB9XG59XG4iXX0=