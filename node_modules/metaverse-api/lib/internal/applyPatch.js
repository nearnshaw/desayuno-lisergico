"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const types_1 = require("./types");
function applyPatch(tree, diffs, createEntity) {
    let length = diffs.length;
    if (length === 0) {
        return true;
    }
    for (let i = 0; i < length; i++) {
        if (!applyDiff(tree, diffs[i], createEntity)) {
            return false;
        }
    }
    return true;
}
exports.applyPatch = applyPatch;
function getNodeFromRoute(tree, route) {
    const _route = route.slice();
    let node = tree;
    while (_route.length > 0 && node) {
        let index = _route.shift();
        node = node.getChildByIndex(index);
    }
    return node;
}
function applyDiff(tree, diff, createEntity) {
    let node = getNodeFromRoute(tree, diff[types_1.Actions.route]);
    let route;
    switch (diff[types_1.Actions.action]) {
        case types_1.Actions.addAttribute:
            if (!node) {
                return false;
            }
            // do nothing, the actual change happens inside modifyAttribute
            break;
        case types_1.Actions.modifyAttribute:
            if (!node) {
                return false;
            }
            node.setAttributes({ [diff[types_1.Actions.name]]: diff[types_1.Actions.newValue] });
            break;
        case types_1.Actions.removeAttribute:
            if (!node || !node.removeAttribute) {
                return false;
            }
            node.removeAttribute(diff[types_1.Actions.name]);
            break;
        case types_1.Actions.replaceElement:
            node.replaceBy(createEntity(diff[types_1.Actions.newValue]));
            break;
        case types_1.Actions.relocateGroup:
            const nodeArray = node
                .childEntities()
                .splice(diff[types_1.Actions.from], diff[types_1.Actions.groupLength])
                .reverse();
            const target = node.getChildByIndex(diff[types_1.Actions.to]);
            for (let i = 0; i < nodeArray.length; i++) {
                node.insertAfter(nodeArray[i], target);
            }
            break;
        case types_1.Actions.removeElement:
            node.removeFromParent();
            break;
        case types_1.Actions.addElement:
            route = diff[types_1.Actions.route].slice();
            const position = route.pop();
            node = getNodeFromRoute(tree, route);
            if (node) {
                const entity = createEntity(diff[types_1.Actions.element]);
                const beforeEntity = node.getChildByIndex(position);
                if (beforeEntity) {
                    node.insertBefore(entity, beforeEntity);
                }
                else {
                    node.add(entity);
                }
            }
            else
                return false;
            break;
        default:
            // tslint:disable-next-line:no-console
            console.log('unknown action');
    }
    return true;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwbHlQYXRjaC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9pbnRlcm5hbC9hcHBseVBhdGNoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUNBQXdDO0FBc0R4QyxvQkFBb0IsSUFBYSxFQUFFLEtBQWMsRUFBRSxZQUFnRDtJQUNqRyxJQUFJLE1BQU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFBO0lBRXpCLElBQUksTUFBTSxLQUFLLENBQUMsRUFBRTtRQUNoQixPQUFPLElBQUksQ0FBQTtLQUNaO0lBRUQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUMvQixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsWUFBWSxDQUFDLEVBQUU7WUFDNUMsT0FBTyxLQUFLLENBQUE7U0FDYjtLQUNGO0lBRUQsT0FBTyxJQUFJLENBQUE7QUFDYixDQUFDO0FBZ0ZpQixnQ0FBVTtBQTlFNUIsMEJBQTBCLElBQWEsRUFBRSxLQUFlO0lBQ3RELE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQTtJQUM1QixJQUFJLElBQUksR0FBRyxJQUFJLENBQUE7SUFDZixPQUFPLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLElBQUksRUFBRTtRQUNoQyxJQUFJLEtBQUssR0FBVyxNQUFNLENBQUMsS0FBSyxFQUFTLENBQUE7UUFDekMsSUFBSSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUE7S0FDbkM7SUFDRCxPQUFPLElBQUksQ0FBQTtBQUNiLENBQUM7QUFFRCxtQkFBbUIsSUFBYSxFQUFFLElBQVcsRUFBRSxZQUFnRDtJQUM3RixJQUFJLElBQUksR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLGVBQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFBO0lBQ3RELElBQUksS0FBWSxDQUFBO0lBRWhCLFFBQVEsSUFBSSxDQUFDLGVBQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTtRQUM1QixLQUFLLGVBQU8sQ0FBQyxZQUFZO1lBQ3ZCLElBQUksQ0FBQyxJQUFJLEVBQUU7Z0JBQ1QsT0FBTyxLQUFLLENBQUE7YUFDYjtZQUNELCtEQUErRDtZQUMvRCxNQUFLO1FBQ1AsS0FBSyxlQUFPLENBQUMsZUFBZTtZQUMxQixJQUFJLENBQUMsSUFBSSxFQUFFO2dCQUNULE9BQU8sS0FBSyxDQUFBO2FBQ2I7WUFDRCxJQUFJLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsZUFBTyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLGVBQU8sQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUE7WUFDcEUsTUFBSztRQUNQLEtBQUssZUFBTyxDQUFDLGVBQWU7WUFDMUIsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUU7Z0JBQ2xDLE9BQU8sS0FBSyxDQUFBO2FBQ2I7WUFDRCxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxlQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQTtZQUN4QyxNQUFLO1FBQ1AsS0FBSyxlQUFPLENBQUMsY0FBYztZQUN6QixJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsZUFBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUNwRCxNQUFLO1FBQ1AsS0FBSyxlQUFPLENBQUMsYUFBYTtZQUN4QixNQUFNLFNBQVMsR0FBRyxJQUFJO2lCQUNuQixhQUFhLEVBQUU7aUJBQ2YsTUFBTSxDQUFDLElBQUksQ0FBQyxlQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLGVBQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztpQkFDckQsT0FBTyxFQUFFLENBQUE7WUFFWixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxlQUFPLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtZQUVyRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsU0FBUyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDekMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUE7YUFDdkM7WUFDRCxNQUFLO1FBQ1AsS0FBSyxlQUFPLENBQUMsYUFBYTtZQUN4QixJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQTtZQUN2QixNQUFLO1FBQ1AsS0FBSyxlQUFPLENBQUMsVUFBVTtZQUNyQixLQUFLLEdBQUcsSUFBSSxDQUFDLGVBQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQTtZQUNuQyxNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUE7WUFDNUIsSUFBSSxHQUFHLGdCQUFnQixDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQTtZQUVwQyxJQUFJLElBQUksRUFBRTtnQkFDUixNQUFNLE1BQU0sR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLGVBQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFBO2dCQUVsRCxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFBO2dCQUVuRCxJQUFJLFlBQVksRUFBRTtvQkFDaEIsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsWUFBWSxDQUFDLENBQUE7aUJBQ3hDO3FCQUFNO29CQUNMLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUE7aUJBQ2pCO2FBQ0Y7O2dCQUFNLE9BQU8sS0FBSyxDQUFBO1lBQ25CLE1BQUs7UUFDUDtZQUNFLHNDQUFzQztZQUN0QyxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLENBQUE7S0FDaEM7SUFFRCxPQUFPLElBQUksQ0FBQTtBQUNiLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBY3Rpb25zLCBJRGlmZiB9IGZyb20gJy4vdHlwZXMnXG5pbXBvcnQgeyBJU2ltcGxpZmllZE5vZGUgfSBmcm9tICcuLidcblxudHlwZSBJRW50aXR5PFQgZXh0ZW5kcyBJU2ltcGxpZmllZE5vZGUgPSBhbnk+ID0ge1xuICAvKipcbiAgICogUmVjZWl2ZXMgYSBkaWN0aW9uYXJ5IG9mIGF0dHJpYnV0ZXMgYW5kIHZhbHVlcy5cbiAgICogSXQgaW5pdGlhbGl6ZXMgYW5kIHVwZGF0ZXMgdGhlIGNvbXBvbmVudHMuXG4gICAqL1xuICBzZXRBdHRyaWJ1dGVzKGF0dHJzOiB7IFthdHRyTmFtZTogc3RyaW5nXTogYW55IH0pOiB2b2lkXG5cbiAgLyoqXG4gICAqIFJlbW92ZXMgYW4gYXR0cmlidXRlLCBpZiBhIGNvbXBvbmVudCBpcyBhdHRhY2hlZCB0byB0aGUgYXR0cmlidXRlLCBpdCBhbHNvIHRlYXIgZG93biB0aGUgY29tcG9uZW50LlxuICAgKi9cbiAgcmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZU5hbWU6IHN0cmluZyk6IHZvaWRcblxuICAvKipcbiAgICogUmVtb3ZlcyB0aGUgZW50aXR5IGZyb20gaXQncyBwYXJlbnQgYW5kIGFsc28gY2xlYW5zIHVwIGFuZFxuICAgKiByZWxlYXNlcyBhbGwgdGhlIHJlc291cmNlcyByZWN1cnNpdmVseVxuICAgKi9cbiAgcmVtb3ZlRnJvbVBhcmVudCgpOiB2b2lkXG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIGxpc3Qgb2YgY2hpbGRyZW4gZW50aXRpZXNcbiAgICovXG4gIGNoaWxkRW50aXRpZXMoKTogSUVudGl0eVtdXG5cbiAgLyoqXG4gICAqIEFwcGVuZHMgYW4gZW50aXR5IHRvIHRoaXMgZW50aXR5LlxuICAgKiBJZiB0aGUgZW50aXR5IGhhcyBhbm90aGVyIHBhcmVudCwgaXQgZmlyc3Qgc2FmZWx5IHJlbW92ZXMgaXQgZnJvbSBpdHMgcGFyZW50LlxuICAgKi9cbiAgYWRkKGVudGl0eTogVCk6IHZvaWRcblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgbnRoLWNoaWxkIGVudGl0eVxuICAgKi9cbiAgZ2V0Q2hpbGRCeUluZGV4KGluZGV4OiBudW1iZXIpOiBUIHwgbnVsbFxuXG4gIC8qKlxuICAgKiBSZXBsYWNlcyB0aGlzIGVudGl0eSBieSB0aGUgbmV3IG9uZS5cbiAgICogVGhlIGVudGl0eSB0aGF0IGlzIHJlbW92ZWQgaXMgcmVsZWFzZWQgYW5kIGNhbm5vdCBiZSByZWF0dGFjaGVkIHRvIHRoZSBlbnRpdHkgdHJlZS5cbiAgICovXG4gIHJlcGxhY2VCeShlbnRpdHk6IFQpOiB2b2lkXG5cbiAgLyoqXG4gICAqIEZpbmRzIGFuIGVudGl0eSBpbiB0aGlzIGVudGl0aWVzIGNoaWxkcmVuIGFuZCBpbnNlcnRzIHRoZSBmaXJzdCBhcmd1bWVudCBiZWZvcmUgdGhlIHNlY29uZCBvbmUgKHJlZmVyZW5jZSlcbiAgICovXG4gIGluc2VydEJlZm9yZShuZXdJdGVtOiBULCByZWY6IFQpOiB2b2lkXG5cbiAgLyoqXG4gICAqIEZpbmRzIGFuIGVudGl0eSBpbiB0aGlzIGVudGl0aWVzIGNoaWxkcmVuIGFuZCBpbnNlcnRzIHRoZSBmaXJzdCBhcmd1bWVudCBhZnRlciB0aGUgc2Vjb25kIG9uZSAocmVmZXJlbmNlKVxuICAgKi9cbiAgaW5zZXJ0QWZ0ZXIobmV3SXRlbTogVCwgcmVmOiBUKTogdm9pZFxufVxuXG5mdW5jdGlvbiBhcHBseVBhdGNoKHRyZWU6IElFbnRpdHksIGRpZmZzOiBJRGlmZltdLCBjcmVhdGVFbnRpdHk6IChub2RlOiBJU2ltcGxpZmllZE5vZGUpID0+IElFbnRpdHkpIHtcbiAgbGV0IGxlbmd0aCA9IGRpZmZzLmxlbmd0aFxuXG4gIGlmIChsZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gdHJ1ZVxuICB9XG5cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykge1xuICAgIGlmICghYXBwbHlEaWZmKHRyZWUsIGRpZmZzW2ldLCBjcmVhdGVFbnRpdHkpKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gIH1cblxuICByZXR1cm4gdHJ1ZVxufVxuXG5mdW5jdGlvbiBnZXROb2RlRnJvbVJvdXRlKHRyZWU6IElFbnRpdHksIHJvdXRlOiBudW1iZXJbXSk6IElFbnRpdHkge1xuICBjb25zdCBfcm91dGUgPSByb3V0ZS5zbGljZSgpXG4gIGxldCBub2RlID0gdHJlZVxuICB3aGlsZSAoX3JvdXRlLmxlbmd0aCA+IDAgJiYgbm9kZSkge1xuICAgIGxldCBpbmRleDogbnVtYmVyID0gX3JvdXRlLnNoaWZ0KCkgYXMgYW55XG4gICAgbm9kZSA9IG5vZGUuZ2V0Q2hpbGRCeUluZGV4KGluZGV4KVxuICB9XG4gIHJldHVybiBub2RlXG59XG5cbmZ1bmN0aW9uIGFwcGx5RGlmZih0cmVlOiBJRW50aXR5LCBkaWZmOiBJRGlmZiwgY3JlYXRlRW50aXR5OiAobm9kZTogSVNpbXBsaWZpZWROb2RlKSA9PiBJRW50aXR5KSB7XG4gIGxldCBub2RlID0gZ2V0Tm9kZUZyb21Sb3V0ZSh0cmVlLCBkaWZmW0FjdGlvbnMucm91dGVdKVxuICBsZXQgcm91dGU6IGFueVtdXG5cbiAgc3dpdGNoIChkaWZmW0FjdGlvbnMuYWN0aW9uXSkge1xuICAgIGNhc2UgQWN0aW9ucy5hZGRBdHRyaWJ1dGU6XG4gICAgICBpZiAoIW5vZGUpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICB9XG4gICAgICAvLyBkbyBub3RoaW5nLCB0aGUgYWN0dWFsIGNoYW5nZSBoYXBwZW5zIGluc2lkZSBtb2RpZnlBdHRyaWJ1dGVcbiAgICAgIGJyZWFrXG4gICAgY2FzZSBBY3Rpb25zLm1vZGlmeUF0dHJpYnV0ZTpcbiAgICAgIGlmICghbm9kZSkge1xuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH1cbiAgICAgIG5vZGUuc2V0QXR0cmlidXRlcyh7IFtkaWZmW0FjdGlvbnMubmFtZV1dOiBkaWZmW0FjdGlvbnMubmV3VmFsdWVdIH0pXG4gICAgICBicmVha1xuICAgIGNhc2UgQWN0aW9ucy5yZW1vdmVBdHRyaWJ1dGU6XG4gICAgICBpZiAoIW5vZGUgfHwgIW5vZGUucmVtb3ZlQXR0cmlidXRlKSB7XG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgfVxuICAgICAgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoZGlmZltBY3Rpb25zLm5hbWVdKVxuICAgICAgYnJlYWtcbiAgICBjYXNlIEFjdGlvbnMucmVwbGFjZUVsZW1lbnQ6XG4gICAgICBub2RlLnJlcGxhY2VCeShjcmVhdGVFbnRpdHkoZGlmZltBY3Rpb25zLm5ld1ZhbHVlXSkpXG4gICAgICBicmVha1xuICAgIGNhc2UgQWN0aW9ucy5yZWxvY2F0ZUdyb3VwOlxuICAgICAgY29uc3Qgbm9kZUFycmF5ID0gbm9kZVxuICAgICAgICAuY2hpbGRFbnRpdGllcygpXG4gICAgICAgIC5zcGxpY2UoZGlmZltBY3Rpb25zLmZyb21dLCBkaWZmW0FjdGlvbnMuZ3JvdXBMZW5ndGhdKVxuICAgICAgICAucmV2ZXJzZSgpXG5cbiAgICAgIGNvbnN0IHRhcmdldCA9IG5vZGUuZ2V0Q2hpbGRCeUluZGV4KGRpZmZbQWN0aW9ucy50b10pXG5cbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZUFycmF5Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIG5vZGUuaW5zZXJ0QWZ0ZXIobm9kZUFycmF5W2ldLCB0YXJnZXQpXG4gICAgICB9XG4gICAgICBicmVha1xuICAgIGNhc2UgQWN0aW9ucy5yZW1vdmVFbGVtZW50OlxuICAgICAgbm9kZS5yZW1vdmVGcm9tUGFyZW50KClcbiAgICAgIGJyZWFrXG4gICAgY2FzZSBBY3Rpb25zLmFkZEVsZW1lbnQ6XG4gICAgICByb3V0ZSA9IGRpZmZbQWN0aW9ucy5yb3V0ZV0uc2xpY2UoKVxuICAgICAgY29uc3QgcG9zaXRpb24gPSByb3V0ZS5wb3AoKVxuICAgICAgbm9kZSA9IGdldE5vZGVGcm9tUm91dGUodHJlZSwgcm91dGUpXG5cbiAgICAgIGlmIChub2RlKSB7XG4gICAgICAgIGNvbnN0IGVudGl0eSA9IGNyZWF0ZUVudGl0eShkaWZmW0FjdGlvbnMuZWxlbWVudF0pXG5cbiAgICAgICAgY29uc3QgYmVmb3JlRW50aXR5ID0gbm9kZS5nZXRDaGlsZEJ5SW5kZXgocG9zaXRpb24pXG5cbiAgICAgICAgaWYgKGJlZm9yZUVudGl0eSkge1xuICAgICAgICAgIG5vZGUuaW5zZXJ0QmVmb3JlKGVudGl0eSwgYmVmb3JlRW50aXR5KVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG5vZGUuYWRkKGVudGl0eSlcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHJldHVybiBmYWxzZVxuICAgICAgYnJlYWtcbiAgICBkZWZhdWx0OlxuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWNvbnNvbGVcbiAgICAgIGNvbnNvbGUubG9nKCd1bmtub3duIGFjdGlvbicpXG4gIH1cblxuICByZXR1cm4gdHJ1ZVxufVxuXG4vLy8gLS0tIEVYUE9SVFMgLS0tXG5cbmV4cG9ydCB7IElFbnRpdHksIGFwcGx5UGF0Y2ggfVxuIl19