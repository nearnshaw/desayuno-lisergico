#!/usr/bin/env node
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const webpack = require("webpack");
const globPkg = require("glob");
const rimraf = require("rimraf");
const fs = require("fs");
const path_1 = require("path");
const TsconfigPathsPlugin = require('tsconfig-paths-webpack-plugin');
const child_process_1 = require("child_process");
const os_1 = require("os");
const ProgressBar = require("progress");
const chalk_1 = require("chalk");
const packageJson = JSON.parse(fs.readFileSync(require.resolve('../package.json')).toString());
const isWatching = process.argv.some($ => $ === '--watch');
const instrumentCoverage = process.argv.some($ => $ === '--coverage') || process.env.NODE_ENV === 'coverage';
const isProduction = process.env.NODE_ENV !== 'development' && !isWatching && !instrumentCoverage;
const webWorkerTransport = path_1.resolve(__dirname, '../lib/common/transports/WebWorker');
const entryPointWebWorker = (filename) => `
import { WebWorkerTransport } from ${JSON.stringify(webWorkerTransport)}
const imported = require(${JSON.stringify(filename)})

if (imported && imported.__esModule && imported['default']) {
  new imported['default'](WebWorkerTransport(self))
}
`;
console.log('metaverse-compiler version: ' + chalk_1.default.green(packageJson.version));
function findConfigFile(baseDir, configFileName) {
    let configFilePath = path_1.resolve(baseDir, configFileName);
    if (fs.existsSync(configFilePath)) {
        return configFilePath;
    }
    if (baseDir.length === path_1.dirname(baseDir).length) {
        return null;
    }
    return findConfigFile(path_1.resolve(baseDir, '../'), configFileName);
}
exports.findConfigFile = findConfigFile;
function compile(opt) {
    return __awaiter(this, void 0, void 0, function* () {
        return new Promise((onSuccess, onError) => {
            let entry = opt.files;
            const extensions = ['.ts', '.tsx', '.js', '.json'];
            if (opt.target === 'webworker') {
                entry = entry.map($ => {
                    const file = path_1.resolve(os_1.tmpdir(), Math.random().toString() + '.WebWorker.js');
                    fs.writeFileSync(file, entryPointWebWorker($));
                    return file;
                });
            }
            entry = entry.reduce((obj, $, $$) => {
                let name = path_1.relative(opt.rootFolder, opt.files[$$]);
                extensions.forEach($ => {
                    if (name.endsWith($)) {
                        name = name.substr(0, name.length - $.length);
                    }
                });
                let target = name;
                if (target.endsWith('.js')) {
                    target = target.substr(0, target.length - 3);
                }
                obj[target] = $;
                return obj;
            }, {});
            console.log([
                `     files:`,
                ...Object.keys(entry).map(($, $$) => `            (root)/${path_1.relative(opt.rootFolder, opt.files[$$])} -> (outDir)/${$}.js`)
            ].join('\n'));
            const options = {
                entry,
                mode: isProduction ? 'production' : 'development',
                optimization: {
                    nodeEnv: isProduction ? 'production' : 'development',
                    namedModules: !isProduction,
                    minimize: isProduction
                },
                output: {
                    path: opt.outDir,
                    libraryTarget: opt.target === 'webworker' ? 'this' : 'umd'
                },
                resolve: {
                    extensions,
                    plugins: [new TsconfigPathsPlugin({ configFile: opt.tsconfig })]
                },
                watch: isWatching,
                module: {
                    rules: [
                        {
                            test: /\.(jpe?g|png|gif|svg)$/i,
                            use: [
                                {
                                    loader: require.resolve('url-loader'),
                                    options: {
                                        limit: 512000
                                    }
                                }
                            ]
                        },
                        {
                            test: /\.tsx?$/,
                            loader: require.resolve('ts-loader'),
                            options: {
                                configFile: opt.tsconfig
                            }
                        }
                    ]
                },
                target: opt.target,
                plugins: [ProgressBarPlugin({})]
            };
            if (opt.coverage) {
                ;
                options.module.rules.push({
                    test: /\.[jt]sx?$/,
                    use: {
                        loader: 'istanbul-instrumenter-loader',
                        options: { esModules: true, sourceMaps: true }
                    },
                    enforce: 'post',
                    exclude: /node_modules|\.spec\.js$/
                });
            }
            const compiler = webpack(options);
            if (!isWatching) {
                compiler.run((err, stats) => {
                    if (err) {
                        onError(err);
                    }
                    else {
                        onSuccess(stats);
                    }
                });
            }
            else {
                compiler.watch({ ignored: /node_modules/, aggregateTimeout: 1000 }, (err, stats) => {
                    if (stats.hasErrors() || stats.hasWarnings()) {
                        console.log(stats.toString({
                            colors: true,
                            errors: true,
                            warnings: true
                        }));
                    }
                    else {
                        console.log('OK ' + opt.outDir);
                    }
                    if (!err) {
                        onSuccess(stats);
                    }
                });
            }
        });
    });
}
exports.compile = compile;
function tsc(tsconfig) {
    return __awaiter(this, void 0, void 0, function* () {
        const tscLocation = require.resolve('typescript/lib/tsc');
        console.log(`
    Executing "tsc -p ${path_1.basename(tsconfig)}" in ${path_1.dirname(tsconfig)}
  `.trim());
        const args = [tscLocation, '-p', path_1.basename(tsconfig)];
        if (isWatching) {
            args.push('--watch');
        }
        const childProcess = child_process_1.spawn('node', args, {
            cwd: path_1.dirname(tsconfig)
        });
        if (isWatching) {
            return true;
        }
        let resolve = a => void 0;
        let reject = a => void 0;
        const semaphore = new Promise((ok, err) => {
            resolve = ok;
            reject = err;
        });
        childProcess.stdout.on('data', data => {
            console.log(`tsc stdout: ${data}`);
        });
        childProcess.stderr.on('data', data => {
            console.log(`tsc stderr: ${data}`);
        });
        childProcess.on('close', exitCode => {
            if (exitCode) {
                reject(exitCode);
            }
            else {
                resolve(exitCode);
            }
        });
        yield semaphore;
    });
}
exports.tsc = tsc;
function processFile(opt) {
    return __awaiter(this, void 0, void 0, function* () {
        const baseFiles = (opt.file && [opt.file]) || (opt.files && opt.files[0]) || [];
        if (!baseFiles.length) {
            throw new Error(`Unable to find a file to compile`);
        }
        const baseFile = baseFiles[0];
        if (baseFile.endsWith('.json')) {
            return processJson(baseFile);
        }
        const parsed = path_1.parse(baseFile);
        const configFile = findConfigFile(path_1.dirname(baseFile), 'tsconfig.json');
        if (!configFile) {
            throw new Error(`Unable to find a tsconfig.json file for ${opt.file}`);
        }
        const rootFolder = path_1.dirname(configFile);
        const parsedTsConfig = require(configFile);
        let outFile = opt.outFile
            ? path_1.resolve(process.cwd(), opt.outFile)
            : parsedTsConfig.compilerOptions.outFile
                ? path_1.resolve(path_1.dirname(configFile), parsedTsConfig.compilerOptions.outFile)
                : parsed.name + '.js';
        const outDir = parsedTsConfig.compilerOptions.outDir
            ? path_1.resolve(path_1.dirname(configFile), parsedTsConfig.compilerOptions.outDir)
            : path_1.dirname(outFile);
        if (outFile.startsWith(outDir)) {
            outFile = outFile.replace(outDir + '/', '');
        }
        const coverage = !isWatching && (opt.coverage || instrumentCoverage);
        const options = {
            files: opt.files || [opt.file],
            outDir,
            tsconfig: configFile,
            coverage: coverage,
            target: opt.target || 'web',
            rootFolder
        };
        console.log(`
      root: ${options.rootFolder}
    outDir: ${options.outDir}
   options: { coverage: ${coverage}, production: ${isProduction}, watch: ${isWatching} }`);
        const result = yield compile(options);
        if (result.hasErrors() || result.hasWarnings()) {
            console.log(result.toString({
                assets: true,
                colors: true,
                entrypoints: true,
                env: true,
                errors: true,
                publicPath: true
            }));
        }
    });
}
exports.processFile = processFile;
function glob(path) {
    return __awaiter(this, void 0, void 0, function* () {
        return new Promise((onSuccess, onFailure) => {
            globPkg(path, { absolute: true }, (err, values) => {
                if (err) {
                    onFailure(err);
                }
                else {
                    onSuccess(values);
                }
            });
        });
    });
}
exports.glob = glob;
function cli(args) {
    return __awaiter(this, void 0, void 0, function* () {
        const files = yield glob(process.argv[2]);
        yield Promise.all(files.map($ => processFile({ file: $, outFile: args[3] })));
    });
}
exports.cli = cli;
function processJson(file) {
    return __awaiter(this, void 0, void 0, function* () {
        const config = require(file);
        if (!config || !(config instanceof Array)) {
            throw new Error(`Config file ${file} is not a valid sequence of steps`);
        }
        if (config.length === 0) {
            throw new Error(`Config file ${file} describes no compilation steps`);
        }
        for (let i = 0; i < config.length; i++) {
            const $ = config[i];
            if ($.kind === 'RM') {
                if (!isWatching) {
                    console.log(`
          Deleting folder: ${$.path}
        `.trim());
                    rimraf.sync($.path);
                }
            }
            else if ($.kind === 'Webpack') {
                const files = yield glob($.file);
                yield processFile(Object.assign({}, $, { files }));
            }
            else if ($.kind === 'TSC') {
                if (!$.config) {
                    throw new Error(`Missing config in: ${JSON.stringify($, null, 2)}`);
                }
                yield tsc($.config);
            }
            else {
                console.error(`Unknown compilation step ${JSON.stringify($, null, 2)}`);
            }
        }
    });
}
exports.processJson = processJson;
cli(process.argv)
    .then(() => {
    if (isWatching) {
        console.log('The compiler is watching file changes...');
        process.stdin.resume();
    }
})
    .catch(err => {
    console.error(err);
    process.exit(1);
});
process.on('unhandledRejection', e => {
    throw e;
});
function ProgressBarPlugin(options) {
    options = options || {};
    let stream = options.stream || process.stderr;
    let enabled = stream && stream.isTTY;
    if (!enabled) {
        return function () {
        };
    }
    let barLeft = chalk_1.default.bold('[');
    let barRight = chalk_1.default.bold(']');
    let preamble = chalk_1.default.cyan.bold('  build ') + barLeft;
    let barFormat = options.format || preamble + ':bar' + barRight + chalk_1.default.green.bold(' :percent');
    let summary = options.summary !== false;
    let summaryContent = options.summaryContent;
    let customSummary = options.customSummary;
    delete options.format;
    delete options.total;
    delete options.summary;
    delete options.summaryContent;
    delete options.customSummary;
    let barOptions = Object.assign({
        complete: '=',
        incomplete: ' ',
        width: 20,
        total: 100,
        clear: true
    }, options);
    let bar = new ProgressBar(barFormat, barOptions);
    let running = false;
    let startTime = new Date();
    let lastPercent = 0;
    return new webpack.ProgressPlugin(function (percent, msg) {
        if (!running && lastPercent !== 0 && !customSummary) {
            stream.write('\n');
        }
        let newPercent = Math.ceil(percent * barOptions.width);
        if (lastPercent !== newPercent) {
            bar.update(percent, {
                msg: msg
            });
            lastPercent = newPercent;
        }
        if (!running) {
            running = true;
            startTime = new Date();
            lastPercent = 0;
        }
        else if (percent === 1) {
            let now = new Date();
            let buildTime = (now.getTime() - startTime.getTime()) / 1000 + 's';
            bar.terminate();
            if (summary) {
                stream.write(chalk_1.default.green.bold('Build completed in ' + buildTime + '\n\n'));
            }
            else if (summaryContent) {
                stream.write('    ' + summaryContent + '(' + buildTime + ')\n\n');
            }
            if (customSummary) {
                customSummary(buildTime);
            }
            running = false;
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGlsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvbXBpbGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFJQSxtQ0FBa0M7QUFDbEMsZ0NBQStCO0FBQy9CLGlDQUFnQztBQUNoQyx5QkFBd0I7QUFDeEIsK0JBQStFO0FBQy9FLE1BQU0sbUJBQW1CLEdBQUcsT0FBTyxDQUFDLCtCQUErQixDQUFDLENBQUE7QUFDcEUsaURBQXFDO0FBQ3JDLDJCQUEyQjtBQUMzQix3Q0FBd0M7QUFDeEMsaUNBQXlCO0FBRXpCLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFBO0FBQzlGLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLFNBQVMsQ0FBQyxDQUFBO0FBQzFELE1BQU0sa0JBQWtCLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssWUFBWSxDQUFDLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEtBQUssVUFBVSxDQUFBO0FBQzVHLE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxLQUFLLGFBQWEsSUFBSSxDQUFDLFVBQVUsSUFBSSxDQUFDLGtCQUFrQixDQUFBO0FBQ2pHLE1BQU0sa0JBQWtCLEdBQUcsY0FBTyxDQUFDLFNBQVMsRUFBRSxvQ0FBb0MsQ0FBQyxDQUFBO0FBRW5GLE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxRQUFnQixFQUFFLEVBQUUsQ0FBQztxQ0FDYixJQUFJLENBQUMsU0FBUyxDQUFDLGtCQUFrQixDQUFDOzJCQUM1QyxJQUFJLENBQUMsU0FBUyxDQUFDLFFB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SUFBSSxJQUFJLEVBQUUsQ0FBQTtZQUN0QixXQUFXLEdBQUcsQ0FBQyxDQUFBO1NBQ2hCO2FBQU0sSUFBSSxPQUFPLEtBQUssQ0FBQyxFQUFFO1lBQ3hCLElBQUksR0FBRyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUE7WUFDcEIsSUFBSSxTQUFTLEdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLEdBQUcsU0FBUyxDQUFDLE9BQU8sRUFBRSxDQUFDLEdBQUcsSUFBSSxHQUFHLEdBQUcsQ0FBQTtZQUVsRSxHQUFHLENBQUMsU0FBUyxFQUFFLENBQUE7WUFFZixJQUFJLE9BQU8sRUFBRTtnQkFDWCxNQUFNLENBQUMsS0FBSyxDQUFDLGVBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLHFCQUFxQixHQUFHLFNBQVMsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFBO2FBQzNFO2lCQUFNLElBQUksY0FBYyxFQUFFO2dCQUN6QixNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxjQUFjLEdBQUcsR0FBRyxHQUFHLFNBQVMsR0FBRyxPQUFPLENBQUMsQ0FBQTthQUNsRTtZQUVELElBQUksYUFBYSxFQUFFO2dCQUNqQixhQUFhLENBQUMsU0FBUyxDQUFDLENBQUE7YUFDekI7WUFFRCxPQUFPLEdBQUcsS0FBSyxDQUFBO1NBQ2hCO0lBQ0gsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiIyEvdXNyL2Jpbi9lbnYgbm9kZVxuXG4vLyBUaGlzIHN0YXJ0ZWQgYXMgc29tZXRoaW5nIGRpZmZlcmVudCBhcyBpdCBpcyByaWdodCBub3cuIEl0IGJlY2FtZSBndWxwLlxuXG5pbXBvcnQgKiBhcyB3ZWJwYWNrIGZyb20gJ3dlYnBhY2snXG5pbXBvcnQgKiBhcyBnbG9iUGtnIGZyb20gJ2dsb2InXG5pbXBvcnQgKiBhcyByaW1yYWYgZnJvbSAncmltcmFmJ1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnXG5pbXBvcnQgeyByZXNvbHZlLCBwYXJzZSBhcyBwYXJzZVBhdGgsIGRpcm5hbWUsIGJhc2VuYW1lLCByZWxhdGl2ZSB9IGZyb20gJ3BhdGgnXG5jb25zdCBUc2NvbmZpZ1BhdGhzUGx1Z2luID0gcmVxdWlyZSgndHNjb25maWctcGF0aHMtd2VicGFjay1wbHVnaW4nKVxuaW1wb3J0IHsgc3Bhd24gfSBmcm9tICdjaGlsZF9wcm9jZXNzJ1xuaW1wb3J0IHsgdG1wZGlyIH0gZnJvbSAnb3MnXG5pbXBvcnQgUHJvZ3Jlc3NCYXIgPSByZXF1aXJlKCdwcm9ncmVzcycpXG5pbXBvcnQgY2hhbGsgZnJvbSAnY2hhbGsnXG5cbmNvbnN0IHBhY2thZ2VKc29uID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMocmVxdWlyZS5yZXNvbHZlKCcuLi9wYWNrYWdlLmpzb24nKSkudG9TdHJpbmcoKSlcbmNvbnN0IGlzV2F0Y2hpbmcgPSBwcm9jZXNzLmFyZ3Yuc29tZSgkID0+ICQgPT09ICctLXdhdGNoJylcbmNvbnN0IGluc3RydW1lbnRDb3ZlcmFnZSA9IHByb2Nlc3MuYXJndi5zb21lKCQgPT4gJCA9PT0gJy0tY292ZXJhZ2UnKSB8fCBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ2NvdmVyYWdlJ1xuY29uc3QgaXNQcm9kdWN0aW9uID0gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdkZXZlbG9wbWVudCcgJiYgIWlzV2F0Y2hpbmcgJiYgIWluc3RydW1lbnRDb3ZlcmFnZVxuY29uc3Qgd2ViV29ya2VyVHJhbnNwb3J0ID0gcmVzb2x2ZShfX2Rpcm5hbWUsICcuLi9saWIvY29tbW9uL3RyYW5zcG9ydHMvV2ViV29ya2VyJylcblxuY29uc3QgZW50cnlQb2ludFdlYldvcmtlciA9IChmaWxlbmFtZTogc3RyaW5nKSA9PiBgXG5pbXBvcnQgeyBXZWJXb3JrZXJUcmFuc3BvcnQgfSBmcm9tICR7SlNPTi5zdHJpbmdpZnkod2ViV29ya2VyVHJhbnNwb3J0KX1cbmNvbnN0IGltcG9ydGVkID0gcmVxdWlyZSgke0pTT04uc3RyaW5naWZ5KGZpbGVuYW1lKX0pXG5cbmlmIChpbXBvcnRlZCAmJiBpbXBvcnRlZC5fX2VzTW9kdWxlICYmIGltcG9ydGVkWydkZWZhdWx0J10pIHtcbiAgbmV3IGltcG9ydGVkWydkZWZhdWx0J10oV2ViV29ya2VyVHJhbnNwb3J0KHNlbGYpKVxufVxuYFxuXG5jb25zb2xlLmxvZygnbWV0YXZlcnNlLWNvbXBpbGVyIHZlcnNpb246ICcgKyBjaGFsay5ncmVlbihwYWNrYWdlSnNvbi52ZXJzaW9uKSlcblxuZXhwb3J0IGZ1bmN0aW9uIGZpbmRDb25maWdGaWxlKGJhc2VEaXI6IHN0cmluZywgY29uZmlnRmlsZU5hbWU6IHN0cmluZyk6IHN0cmluZyB8IG51bGwge1xuICBsZXQgY29uZmlnRmlsZVBhdGggPSByZXNvbHZlKGJhc2VEaXIsIGNvbmZpZ0ZpbGVOYW1lKVxuXG4gIGlmIChmcy5leGlzdHNTeW5jKGNvbmZpZ0ZpbGVQYXRoKSkge1xuICAgIHJldHVybiBjb25maWdGaWxlUGF0aFxuICB9XG5cbiAgaWYgKGJhc2VEaXIubGVuZ3RoID09PSBkaXJuYW1lKGJhc2VEaXIpLmxlbmd0aCkge1xuICAgIHJldHVybiBudWxsXG4gIH1cblxuICByZXR1cm4gZmluZENvbmZpZ0ZpbGUocmVzb2x2ZShiYXNlRGlyLCAnLi4vJyksIGNvbmZpZ0ZpbGVOYW1lKVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElDb21waWxlck9wdGlvbnMge1xuICBmaWxlczogc3RyaW5nW11cbiAgb3V0RGlyOiBzdHJpbmdcbiAgdHNjb25maWc6IHN0cmluZ1xuICB0YXJnZXQ/OiAnd2ViJyB8ICd3ZWJ3b3JrZXInIHwgJ25vZGUnXG4gIGNvdmVyYWdlPzogYm9vbGVhblxuICByb290Rm9sZGVyOiBzdHJpbmdcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNvbXBpbGUob3B0OiBJQ29tcGlsZXJPcHRpb25zKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZTx3ZWJwYWNrLlN0YXRzPigob25TdWNjZXNzLCBvbkVycm9yKSA9PiB7XG4gICAgbGV0IGVudHJ5OiB3ZWJwYWNrLkVudHJ5IHwgc3RyaW5nW10gPSBvcHQuZmlsZXNcblxuICAgIGNvbnN0IGV4dGVuc2lvbnMgPSBbJy50cycsICcudHN4JywgJy5qcycsICcuanNvbiddXG5cbiAgICBpZiAob3B0LnRhcmdldCA9PT0gJ3dlYndvcmtlcicpIHtcbiAgICAgIGVudHJ5ID0gZW50cnkubWFwKCQgPT4ge1xuICAgICAgICBjb25zdCBmaWxlID0gcmVzb2x2ZSh0bXBkaXIoKSwgTWF0aC5yYW5kb20oKS50b1N0cmluZygpICsgJy5XZWJXb3JrZXIuanMnKVxuICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGZpbGUsIGVudHJ5UG9pbnRXZWJXb3JrZXIoJCkpXG4gICAgICAgIHJldHVybiBmaWxlXG4gICAgICB9KVxuICAgIH1cblxuICAgIGVudHJ5ID0gZW50cnkucmVkdWNlKFxuICAgICAgKG9iaiwgJCwgJCQpID0+IHtcbiAgICAgICAgbGV0IG5hbWUgPSByZWxhdGl2ZShvcHQucm9vdEZvbGRlciwgb3B0LmZpbGVzWyQkXSlcbiAgICAgICAgZXh0ZW5zaW9ucy5mb3JFYWNoKCQgPT4ge1xuICAgICAgICAgIGlmIChuYW1lLmVuZHNXaXRoKCQpKSB7XG4gICAgICAgICAgICBuYW1lID0gbmFtZS5zdWJzdHIoMCwgbmFtZS5sZW5ndGggLSAkLmxlbmd0aClcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICAgIGxldCB0YXJnZXQgPSBuYW1lXG4gICAgICAgIGlmICh0YXJnZXQuZW5kc1dpdGgoJy5qcycpKSB7XG4gICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0LnN1YnN0cigwLCB0YXJnZXQubGVuZ3RoIC0gMylcbiAgICAgICAgfVxuICAgICAgICBvYmpbdGFyZ2V0XSA9ICRcbiAgICAgICAgcmV0dXJuIG9ialxuICAgICAgfSxcbiAgICAgIHt9IGFzIHdlYnBhY2suRW50cnlcbiAgICApXG5cbiAgICBjb25zb2xlLmxvZyhcbiAgICAgIFtcbiAgICAgICAgYCAgICAgZmlsZXM6YCxcbiAgICAgICAgLi4uT2JqZWN0LmtleXMoZW50cnkpLm1hcChcbiAgICAgICAgICAoJCwgJCQpID0+IGAgICAgICAgICAgICAocm9vdCkvJHtyZWxhdGl2ZShvcHQucm9vdEZvbGRlciwgb3B0LmZpbGVzWyQkXSl9IC0+IChvdXREaXIpLyR7JH0uanNgXG4gICAgICAgIClcbiAgICAgIF0uam9pbignXFxuJylcbiAgICApXG5cbiAgICBjb25zdCBvcHRpb25zOiB3ZWJwYWNrLkNvbmZpZ3VyYXRpb24gPSB7XG4gICAgICBlbnRyeSxcbiAgICAgIG1vZGU6IGlzUHJvZHVjdGlvbiA/ICdwcm9kdWN0aW9uJyA6ICdkZXZlbG9wbWVudCcsXG4gICAgICBvcHRpbWl6YXRpb246IHtcbiAgICAgICAgbm9kZUVudjogaXNQcm9kdWN0aW9uID8gJ3Byb2R1Y3Rpb24nIDogJ2RldmVsb3BtZW50JyxcbiAgICAgICAgbmFtZWRNb2R1bGVzOiAhaXNQcm9kdWN0aW9uLFxuICAgICAgICBtaW5pbWl6ZTogaXNQcm9kdWN0aW9uXG4gICAgICB9LFxuICAgICAgb3V0cHV0OiB7XG4gICAgICAgIHBhdGg6IG9wdC5vdXREaXIsXG4gICAgICAgIGxpYnJhcnlUYXJnZXQ6IG9wdC50YXJnZXQgPT09ICd3ZWJ3b3JrZXInID8gJ3RoaXMnIDogJ3VtZCdcbiAgICAgIH0sXG5cbiAgICAgIHJlc29sdmU6IHtcbiAgICAgICAgLy8gQWRkICcudHMnIGFuZCAnLnRzeCcgYXMgcmVzb2x2YWJsZSBleHRlbnNpb25zLlxuICAgICAgICBleHRlbnNpb25zLFxuICAgICAgICBwbHVnaW5zOiBbbmV3IFRzY29uZmlnUGF0aHNQbHVnaW4oeyBjb25maWdGaWxlOiBvcHQudHNjb25maWcgfSldXG4gICAgICB9LFxuICAgICAgd2F0Y2g6IGlzV2F0Y2hpbmcsXG4gICAgICBtb2R1bGU6IHtcbiAgICAgICAgcnVsZXM6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICB0ZXN0OiAvXFwuKGpwZT9nfHBuZ3xnaWZ8c3ZnKSQvaSxcbiAgICAgICAgICAgIHVzZTogW1xuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbG9hZGVyOiByZXF1aXJlLnJlc29sdmUoJ3VybC1sb2FkZXInKSxcbiAgICAgICAgICAgICAgICBvcHRpb25zOiB7XG4gICAgICAgICAgICAgICAgICBsaW1pdDogNTEyMDAwXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICBdXG4gICAgICAgICAgfSxcbiAgICAgICAgICAvLyBBbGwgZmlsZXMgd2l0aCBhICcudHMnIG9yICcudHN4JyBleHRlbnNpb24gd2lsbCBiZSBoYW5kbGVkIGJ5ICdhd2Vzb21lLXR5cGVzY3JpcHQtbG9hZGVyJy5cbiAgICAgICAgICB7XG4gICAgICAgICAgICB0ZXN0OiAvXFwudHN4PyQvLFxuICAgICAgICAgICAgbG9hZGVyOiByZXF1aXJlLnJlc29sdmUoJ3RzLWxvYWRlcicpLFxuICAgICAgICAgICAgb3B0aW9uczoge1xuICAgICAgICAgICAgICBjb25maWdGaWxlOiBvcHQudHNjb25maWdcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIF1cbiAgICAgIH0sXG4gICAgICB0YXJnZXQ6IG9wdC50YXJnZXQsXG4gICAgICBwbHVnaW5zOiBbUHJvZ3Jlc3NCYXJQbHVnaW4oe30pXVxuICAgIH1cblxuICAgIGlmIChvcHQuY292ZXJhZ2UpIHtcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpzZW1pY29sb25cbiAgICAgIDsob3B0aW9ucy5tb2R1bGUgYXMgYW55KS5ydWxlcy5wdXNoKHtcbiAgICAgICAgdGVzdDogL1xcLltqdF1zeD8kLyxcbiAgICAgICAgdXNlOiB7XG4gICAgICAgICAgbG9hZGVyOiAnaXN0YW5idWwtaW5zdHJ1bWVudGVyLWxvYWRlcicsXG4gICAgICAgICAgb3B0aW9uczogeyBlc01vZHVsZXM6IHRydWUsIHNvdXJjZU1hcHM6IHRydWUgfVxuICAgICAgICB9LFxuICAgICAgICBlbmZvcmNlOiAncG9zdCcsXG4gICAgICAgIGV4Y2x1ZGU6IC9ub2RlX21vZHVsZXN8XFwuc3BlY1xcLmpzJC9cbiAgICAgIH0pXG4gICAgfVxuXG4gICAgY29uc3QgY29tcGlsZXIgPSB3ZWJwYWNrKG9wdGlvbnMpXG5cbiAgICBpZiAoIWlzV2F0Y2hpbmcpIHtcbiAgICAgIGNvbXBpbGVyLnJ1bigoZXJyLCBzdGF0cykgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgb25FcnJvcihlcnIpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgb25TdWNjZXNzKHN0YXRzKVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICBjb21waWxlci53YXRjaCh7IGlnbm9yZWQ6IC9ub2RlX21vZHVsZXMvLCBhZ2dyZWdhdGVUaW1lb3V0OiAxMDAwIH0sIChlcnIsIHN0YXRzKSA9PiB7XG4gICAgICAgIGlmIChzdGF0cy5oYXNFcnJvcnMoKSB8fCBzdGF0cy5oYXNXYXJuaW5ncygpKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgICBzdGF0cy50b1N0cmluZyh7XG4gICAgICAgICAgICAgIGNvbG9yczogdHJ1ZSxcbiAgICAgICAgICAgICAgZXJyb3JzOiB0cnVlLFxuICAgICAgICAgICAgICB3YXJuaW5nczogdHJ1ZVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICApXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ09LICcgKyBvcHQub3V0RGlyKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFlcnIpIHtcbiAgICAgICAgICBvblN1Y2Nlc3Moc3RhdHMpXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfVxuICB9KVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdHNjKHRzY29uZmlnOiBzdHJpbmcpIHtcbiAgY29uc3QgdHNjTG9jYXRpb24gPSByZXF1aXJlLnJlc29sdmUoJ3R5cGVzY3JpcHQvbGliL3RzYycpXG5cbiAgY29uc29sZS5sb2coXG4gICAgYFxuICAgIEV4ZWN1dGluZyBcInRzYyAtcCAke2Jhc2VuYW1lKHRzY29uZmlnKX1cIiBpbiAke2Rpcm5hbWUodHNjb25maWcpfVxuICBgLnRyaW0oKVxuICApXG5cbiAgY29uc3QgYXJncyA9IFt0c2NMb2NhdGlvbiwgJy1wJywgYmFzZW5hbWUodHNjb25maWcpXVxuXG4gIGlmIChpc1dhdGNoaW5nKSB7XG4gICAgYXJncy5wdXNoKCctLXdhdGNoJylcbiAgfVxuXG4gIGNvbnN0IGNoaWxkUHJvY2VzcyA9IHNwYXduKCdub2RlJywgYXJncywge1xuICAgIGN3ZDogZGlybmFtZSh0c2NvbmZpZylcbiAgfSlcblxuICBpZiAoaXNXYXRjaGluZykge1xuICAgIHJldHVybiB0cnVlXG4gIH1cblxuICBsZXQgcmVzb2x2ZTogKHg6IGFueSkgPT4gYW55ID0gYSA9PiB2b2lkIDBcbiAgbGV0IHJlamVjdDogKHg6IGFueSkgPT4gYW55ID0gYSA9PiB2b2lkIDBcblxuICBjb25zdCBzZW1hcGhvcmUgPSBuZXcgUHJvbWlzZSgob2ssIGVycikgPT4ge1xuICAgIHJlc29sdmUgPSBva1xuICAgIHJlamVjdCA9IGVyclxuICB9KVxuXG4gIGNoaWxkUHJvY2Vzcy5zdGRvdXQub24oJ2RhdGEnLCBkYXRhID0+IHtcbiAgICBjb25zb2xlLmxvZyhgdHNjIHN0ZG91dDogJHtkYXRhfWApXG4gIH0pXG5cbiAgY2hpbGRQcm9jZXNzLnN0ZGVyci5vbignZGF0YScsIGRhdGEgPT4ge1xuICAgIGNvbnNvbGUubG9nKGB0c2Mgc3RkZXJyOiAke2RhdGF9YClcbiAgfSlcblxuICBjaGlsZFByb2Nlc3Mub24oJ2Nsb3NlJywgZXhpdENvZGUgPT4ge1xuICAgIGlmIChleGl0Q29kZSkge1xuICAgICAgcmVqZWN0KGV4aXRDb2RlKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXNvbHZlKGV4aXRDb2RlKVxuICAgIH1cbiAgfSlcblxuICBhd2FpdCBzZW1hcGhvcmVcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHByb2Nlc3NGaWxlKG9wdDoge1xuICBmaWxlPzogc3RyaW5nXG4gIGZpbGVzPzogc3RyaW5nW11cbiAgb3V0RmlsZT86IHN0cmluZ1xuICB3YXRjaD86IGJvb2xlYW5cbiAgdGFyZ2V0Pzogc3RyaW5nXG4gIGNvdmVyYWdlPzogYm9vbGVhblxufSkge1xuICBjb25zdCBiYXNlRmlsZXMgPSAob3B0LmZpbGUgJiYgW29wdC5maWxlXSkgfHwgKG9wdC5maWxlcyAmJiBvcHQuZmlsZXNbMF0pIHx8IFtdXG5cbiAgaWYgKCFiYXNlRmlsZXMubGVuZ3RoKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gZmluZCBhIGZpbGUgdG8gY29tcGlsZWApXG4gIH1cblxuICBjb25zdCBiYXNlRmlsZSA9IGJhc2VGaWxlc1swXVxuXG4gIGlmIChiYXNlRmlsZS5lbmRzV2l0aCgnLmpzb24nKSkge1xuICAgIHJldHVybiBwcm9jZXNzSnNvbihiYXNlRmlsZSlcbiAgfVxuXG4gIGNvbnN0IHBhcnNlZCA9IHBhcnNlUGF0aChiYXNlRmlsZSlcblxuICBjb25zdCBjb25maWdGaWxlID0gZmluZENvbmZpZ0ZpbGUoZGlybmFtZShiYXNlRmlsZSksICd0c2NvbmZpZy5qc29uJylcblxuICBpZiAoIWNvbmZpZ0ZpbGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBmaW5kIGEgdHNjb25maWcuanNvbiBmaWxlIGZvciAke29wdC5maWxlfWApXG4gIH1cblxuICBjb25zdCByb290Rm9sZGVyID0gZGlybmFtZShjb25maWdGaWxlKVxuXG4gIGNvbnN0IHBhcnNlZFRzQ29uZmlnID0gcmVxdWlyZShjb25maWdGaWxlKVxuXG4gIGxldCBvdXRGaWxlID0gb3B0Lm91dEZpbGVcbiAgICA/IHJlc29sdmUocHJvY2Vzcy5jd2QoKSwgb3B0Lm91dEZpbGUpXG4gICAgOiBwYXJzZWRUc0NvbmZpZy5jb21waWxlck9wdGlvbnMub3V0RmlsZVxuICAgICAgPyByZXNvbHZlKGRpcm5hbWUoY29uZmlnRmlsZSksIHBhcnNlZFRzQ29uZmlnLmNvbXBpbGVyT3B0aW9ucy5vdXRGaWxlKVxuICAgICAgOiBwYXJzZWQubmFtZSArICcuanMnXG5cbiAgY29uc3Qgb3V0RGlyID0gcGFyc2VkVHNDb25maWcuY29tcGlsZXJPcHRpb25zLm91dERpclxuICAgID8gcmVzb2x2ZShkaXJuYW1lKGNvbmZpZ0ZpbGUpLCBwYXJzZWRUc0NvbmZpZy5jb21waWxlck9wdGlvbnMub3V0RGlyKVxuICAgIDogZGlybmFtZShvdXRGaWxlKVxuXG4gIGlmIChvdXRGaWxlLnN0YXJ0c1dpdGgob3V0RGlyKSkge1xuICAgIG91dEZpbGUgPSBvdXRGaWxlLnJlcGxhY2Uob3V0RGlyICsgJy8nLCAnJylcbiAgfVxuXG4gIGNvbnN0IGNvdmVyYWdlID0gIWlzV2F0Y2hpbmcgJiYgKG9wdC5jb3ZlcmFnZSB8fCBpbnN0cnVtZW50Q292ZXJhZ2UpXG5cbiAgY29uc3Qgb3B0aW9uczogSUNvbXBpbGVyT3B0aW9ucyA9IHtcbiAgICBmaWxlczogb3B0LmZpbGVzIHx8IFtvcHQuZmlsZSBhcyBzdHJpbmddLFxuICAgIG91dERpcixcbiAgICB0c2NvbmZpZzogY29uZmlnRmlsZSxcbiAgICBjb3ZlcmFnZTogY292ZXJhZ2UsXG4gICAgdGFyZ2V0OiAob3B0LnRhcmdldCBhcyBhbnkpIHx8ICd3ZWInLFxuICAgIHJvb3RGb2xkZXJcbiAgfVxuXG4gIGNvbnNvbGUubG9nKGBcbiAgICAgIHJvb3Q6ICR7b3B0aW9ucy5yb290Rm9sZGVyfVxuICAgIG91dERpcjogJHtvcHRpb25zLm91dERpcn1cbiAgIG9wdGlvbnM6IHsgY292ZXJhZ2U6ICR7Y292ZXJhZ2V9LCBwcm9kdWN0aW9uOiAke2lzUHJvZHVjdGlvbn0sIHdhdGNoOiAke2lzV2F0Y2hpbmd9IH1gKVxuXG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGNvbXBpbGUob3B0aW9ucylcblxuICBpZiAocmVzdWx0Lmhhc0Vycm9ycygpIHx8IHJlc3VsdC5oYXNXYXJuaW5ncygpKSB7XG4gICAgY29uc29sZS5sb2coXG4gICAgICByZXN1bHQudG9TdHJpbmcoe1xuICAgICAgICBhc3NldHM6IHRydWUsXG4gICAgICAgIGNvbG9yczogdHJ1ZSxcbiAgICAgICAgZW50cnlwb2ludHM6IHRydWUsXG4gICAgICAgIGVudjogdHJ1ZSxcbiAgICAgICAgZXJyb3JzOiB0cnVlLFxuICAgICAgICBwdWJsaWNQYXRoOiB0cnVlXG4gICAgICB9KVxuICAgIClcbiAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2xvYihwYXRoOiBzdHJpbmcpIHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlPHN0cmluZ1tdPigob25TdWNjZXNzLCBvbkZhaWx1cmUpID0+IHtcbiAgICBnbG9iUGtnKHBhdGgsIHsgYWJzb2x1dGU6IHRydWUgfSwgKGVyciwgdmFsdWVzKSA9PiB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIG9uRmFpbHVyZShlcnIpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvblN1Y2Nlc3ModmFsdWVzKVxuICAgICAgfVxuICAgIH0pXG4gIH0pXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjbGkoYXJnczogc3RyaW5nW10pIHtcbiAgY29uc3QgZmlsZXMgPSBhd2FpdCBnbG9iKHByb2Nlc3MuYXJndlsyXSlcblxuICBhd2FpdCBQcm9taXNlLmFsbChmaWxlcy5tYXAoJCA9PiBwcm9jZXNzRmlsZSh7IGZpbGU6ICQsIG91dEZpbGU6IGFyZ3NbM10gfSkpKVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcHJvY2Vzc0pzb24oZmlsZTogc3RyaW5nKSB7XG4gIGNvbnN0IGNvbmZpZzogYW55W10gPSByZXF1aXJlKGZpbGUpXG5cbiAgaWYgKCFjb25maWcgfHwgIShjb25maWcgaW5zdGFuY2VvZiBBcnJheSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENvbmZpZyBmaWxlICR7ZmlsZX0gaXMgbm90IGEgdmFsaWQgc2VxdWVuY2Ugb2Ygc3RlcHNgKVxuICB9XG5cbiAgaWYgKGNvbmZpZy5sZW5ndGggPT09IDApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENvbmZpZyBmaWxlICR7ZmlsZX0gZGVzY3JpYmVzIG5vIGNvbXBpbGF0aW9uIHN0ZXBzYClcbiAgfVxuXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgY29uZmlnLmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3QgJCA9IGNvbmZpZ1tpXVxuXG4gICAgaWYgKCQua2luZCA9PT0gJ1JNJykge1xuICAgICAgaWYgKCFpc1dhdGNoaW5nKSB7XG4gICAgICAgIC8vIGRlbGV0ZSBhIGZvbGRlclxuICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICBgXG4gICAgICAgICAgRGVsZXRpbmcgZm9sZGVyOiAkeyQucGF0aH1cbiAgICAgICAgYC50cmltKClcbiAgICAgICAgKVxuICAgICAgICByaW1yYWYuc3luYygkLnBhdGgpXG4gICAgICB9XG4gICAgfSBlbHNlIGlmICgkLmtpbmQgPT09ICdXZWJwYWNrJykge1xuICAgICAgLy8gY29tcGlsZSBUU1xuICAgICAgY29uc3QgZmlsZXMgPSBhd2FpdCBnbG9iKCQuZmlsZSlcblxuICAgICAgYXdhaXQgcHJvY2Vzc0ZpbGUoeyAuLi4kLCBmaWxlcyB9KVxuICAgIH0gZWxzZSBpZiAoJC5raW5kID09PSAnVFNDJykge1xuICAgICAgaWYgKCEkLmNvbmZpZykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE1pc3NpbmcgY29uZmlnIGluOiAke0pTT04uc3RyaW5naWZ5KCQsIG51bGwsIDIpfWApXG4gICAgICB9XG5cbiAgICAgIGF3YWl0IHRzYygkLmNvbmZpZylcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5lcnJvcihgVW5rbm93biBjb21waWxhdGlvbiBzdGVwICR7SlNPTi5zdHJpbmdpZnkoJCwgbnVsbCwgMil9YClcbiAgICB9XG4gIH1cbn1cblxuY2xpKHByb2Nlc3MuYXJndilcbiAgLnRoZW4oKCkgPT4ge1xuICAgIGlmIChpc1dhdGNoaW5nKSB7XG4gICAgICBjb25zb2xlLmxvZygnVGhlIGNvbXBpbGVyIGlzIHdhdGNoaW5nIGZpbGUgY2hhbmdlcy4uLicpXG4gICAgICBwcm9jZXNzLnN0ZGluLnJlc3VtZSgpXG4gICAgfVxuICB9KVxuICAuY2F0Y2goZXJyID0+IHtcbiAgICBjb25zb2xlLmVycm9yKGVycilcbiAgICBwcm9jZXNzLmV4aXQoMSlcbiAgfSlcblxucHJvY2Vzcy5vbigndW5oYW5kbGVkUmVqZWN0aW9uJywgZSA9PiB7XG4gIHRocm93IGVcbn0pXG5cbmZ1bmN0aW9uIFByb2dyZXNzQmFyUGx1Z2luKG9wdGlvbnM6IGFueSkge1xuICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fVxuXG4gIGxldCBzdHJlYW0gPSBvcHRpb25zLnN0cmVhbSB8fCBwcm9jZXNzLnN0ZGVyclxuICBsZXQgZW5hYmxlZCA9IHN0cmVhbSAmJiBzdHJlYW0uaXNUVFlcblxuICBpZiAoIWVuYWJsZWQpIHtcbiAgICByZXR1cm4gZnVuY3Rpb24oKSB7XG4gICAgICAvLyBzdHViXG4gICAgfVxuICB9XG5cbiAgbGV0IGJhckxlZnQgPSBjaGFsay5ib2xkKCdbJylcbiAgbGV0IGJhclJpZ2h0ID0gY2hhbGsuYm9sZCgnXScpXG4gIGxldCBwcmVhbWJsZSA9IGNoYWxrLmN5YW4uYm9sZCgnICBidWlsZCAnKSArIGJhckxlZnRcbiAgbGV0IGJhckZvcm1hdCA9IG9wdGlvbnMuZm9ybWF0IHx8IHByZWFtYmxlICsgJzpiYXInICsgYmFyUmlnaHQgKyBjaGFsay5ncmVlbi5ib2xkKCcgOnBlcmNlbnQnKVxuICBsZXQgc3VtbWFyeSA9IG9wdGlvbnMuc3VtbWFyeSAhPT0gZmFsc2VcbiAgbGV0IHN1bW1hcnlDb250ZW50ID0gb3B0aW9ucy5zdW1tYXJ5Q29udGVudFxuICBsZXQgY3VzdG9tU3VtbWFyeSA9IG9wdGlvbnMuY3VzdG9tU3VtbWFyeVxuXG4gIGRlbGV0ZSBvcHRpb25zLmZvcm1hdFxuICBkZWxldGUgb3B0aW9ucy50b3RhbFxuICBkZWxldGUgb3B0aW9ucy5zdW1tYXJ5XG4gIGRlbGV0ZSBvcHRpb25zLnN1bW1hcnlDb250ZW50XG4gIGRlbGV0ZSBvcHRpb25zLmN1c3RvbVN1bW1hcnlcblxuICBsZXQgYmFyT3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oXG4gICAge1xuICAgICAgY29tcGxldGU6ICc9JyxcbiAgICAgIGluY29tcGxldGU6ICcgJyxcbiAgICAgIHdpZHRoOiAyMCxcbiAgICAgIHRvdGFsOiAxMDAsXG4gICAgICBjbGVhcjogdHJ1ZVxuICAgIH0sXG4gICAgb3B0aW9uc1xuICApXG5cbiAgbGV0IGJhciA9IG5ldyBQcm9ncmVzc0JhcihiYXJGb3JtYXQsIGJhck9wdGlvbnMpXG5cbiAgbGV0IHJ1bm5pbmcgPSBmYWxzZVxuICBsZXQgc3RhcnRUaW1lOiBEYXRlID0gbmV3IERhdGUoKVxuICBsZXQgbGFzdFBlcmNlbnQgPSAwXG5cbiAgcmV0dXJuIG5ldyB3ZWJwYWNrLlByb2dyZXNzUGx1Z2luKGZ1bmN0aW9uKHBlcmNlbnQsIG1zZykge1xuICAgIGlmICghcnVubmluZyAmJiBsYXN0UGVyY2VudCAhPT0gMCAmJiAhY3VzdG9tU3VtbWFyeSkge1xuICAgICAgc3RyZWFtLndyaXRlKCdcXG4nKVxuICAgIH1cblxuICAgIGxldCBuZXdQZXJjZW50ID0gTWF0aC5jZWlsKHBlcmNlbnQgKiBiYXJPcHRpb25zLndpZHRoKVxuXG4gICAgaWYgKGxhc3RQZXJjZW50ICE9PSBuZXdQZXJjZW50KSB7XG4gICAgICBiYXIudXBkYXRlKHBlcmNlbnQsIHtcbiAgICAgICAgbXNnOiBtc2dcbiAgICAgIH0pXG4gICAgICBsYXN0UGVyY2VudCA9IG5ld1BlcmNlbnRcbiAgICB9XG5cbiAgICBpZiAoIXJ1bm5pbmcpIHtcbiAgICAgIHJ1bm5pbmcgPSB0cnVlXG4gICAgICBzdGFydFRpbWUgPSBuZXcgRGF0ZSgpXG4gICAgICBsYXN0UGVyY2VudCA9IDBcbiAgICB9IGVsc2UgaWYgKHBlcmNlbnQgPT09IDEpIHtcbiAgICAgIGxldCBub3cgPSBuZXcgRGF0ZSgpXG4gICAgICBsZXQgYnVpbGRUaW1lID0gKG5vdy5nZXRUaW1lKCkgLSBzdGFydFRpbWUuZ2V0VGltZSgpKSAvIDEwMDAgKyAncydcblxuICAgICAgYmFyLnRlcm1pbmF0ZSgpXG5cbiAgICAgIGlmIChzdW1tYXJ5KSB7XG4gICAgICAgIHN0cmVhbS53cml0ZShjaGFsay5ncmVlbi5ib2xkKCdCdWlsZCBjb21wbGV0ZWQgaW4gJyArIGJ1aWxkVGltZSArICdcXG5cXG4nKSlcbiAgICAgIH0gZWxzZSBpZiAoc3VtbWFyeUNvbnRlbnQpIHtcbiAgICAgICAgc3RyZWFtLndyaXRlKCcgICAgJyArIHN1bW1hcnlDb250ZW50ICsgJygnICsgYnVpbGRUaW1lICsgJylcXG5cXG4nKVxuICAgICAgfVxuXG4gICAgICBpZiAoY3VzdG9tU3VtbWFyeSkge1xuICAgICAgICBjdXN0b21TdW1tYXJ5KGJ1aWxkVGltZSlcbiAgICAgIH1cblxuICAgICAgcnVubmluZyA9IGZhbHNlXG4gICAgfVxuICB9KVxufVxuIl19