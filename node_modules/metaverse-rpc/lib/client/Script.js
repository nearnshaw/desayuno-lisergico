import { Client } from '../common/json-rpc/Client';
import { getApi } from '../common/json-rpc/API';
import { isPromiseLike } from '../common/core/isPromiseLike';
const loadAPIsNotificationName = 'LoadComponents';
const hasSymbol = typeof Symbol === 'function' && Symbol.for;
const injectedAPISymbol = hasSymbol ? Symbol('injectedAPIs') : 0xfea0;
export function inject(apiName) {
    if (apiName !== undefined && !apiName) {
        throw new TypeError('API name cannot be null / empty');
    }
    return function (target, propertyKey) {
        if (typeof propertyKey === 'string') {
            getInjectedAPIs(target).set(propertyKey, apiName || propertyKey);
        }
        else
            throw new TypeError('Cannot inject APIs with non-string names');
    };
}
export function getInjectedAPIs(instance) {
    const instanceAny = instance;
    instanceAny[injectedAPISymbol] = instanceAny[injectedAPISymbol] || new Map();
    return instanceAny[injectedAPISymbol];
}
async function _injectAPIs(target) {
    const injectedMap = getInjectedAPIs(target);
    if (injectedMap.size === 0)
        return;
    await target.loadAPIs(Array.from(injectedMap.values()));
    injectedMap.forEach(function (apiName, property) {
        target[property] = target.loadedAPIs[apiName];
    });
}
export class Script extends Client {
    constructor(transport, opt) {
        super(opt);
        this.transport = transport;
        this.loadedAPIs = {};
        this.started = false;
        if (transport.onError) {
            transport.onError(e => {
                this.emit('error', e);
            });
        }
        if (transport.onClose) {
            transport.onClose(() => {
                this.emit('transportClosed');
            });
        }
        transport.onMessage(message => {
            this.processMessage(message);
        });
        if (transport.onConnect) {
            transport.onConnect(() => {
                this.didConnect();
            });
        }
        else {
            this.didConnect();
        }
    }
    sendMessage(message) {
        this.transport.sendMessage(message);
    }
    async loadAPIs(apiName) {
        const loadedKeys = Object.keys(this.loadedAPIs);
        const keysToRequest = apiName.filter(function ($) {
            return !loadedKeys.includes($);
        });
        if (keysToRequest.length) {
            await this.call(loadAPIsNotificationName, [keysToRequest]);
            keysToRequest.forEach(async (apiName) => {
                this.loadedAPIs[apiName] = getApi(this, apiName);
            });
        }
        return this.loadedAPIs;
    }
    didConnect() {
        const injection = _injectAPIs(this);
        super.didConnect();
        injection
            .then(() => {
            if (this.systemDidEnable && !this.started) {
                this.started = true;
                try {
                    const r = this.systemDidEnable();
                    if (r && isPromiseLike(r)) {
                        r.catch(e => this.emit('error', e));
                    }
                }
                catch (e) {
                    this.emit('error', e);
                }
            }
        })
            .catch(e => this.emit('error', e));
    }
}
Script.inject = inject;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2NyaXB0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NsaWVudC9TY3JpcHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLDJCQUEyQixDQUFBO0FBQ2xELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQTtBQUUvQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sOEJBQThCLENBQUE7QUFHNUQsTUFBTSx3QkFBd0IsR0FBRyxnQkFBZ0IsQ0FBQTtBQU1qRCxNQUFNLFNBQVMsR0FBRyxPQUFPLE1BQU0sS0FBSyxVQUFVLElBQUksTUFBTSxDQUFDLEdBQUcsQ0FBQTtBQUU1RCxNQUFNLGlCQUFpQixHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUE7QUFZckUsTUFBTSxpQkFBaUIsT0FBZ0I7SUFDckMsSUFBSSxPQUFPLEtBQUssU0FBUyxJQUFJLENBQUMsT0FBTyxFQUFFO1FBQ3JDLE1BQU0sSUFBSSxTQUFTLENBQUMsaUNBQWlDLENBQUMsQ0FBQTtLQUN2RDtJQUNELE9BQU8sVUFBMkIsTUFBUyxFQUFFLFdBQW9CO1FBQy9ELElBQUksT0FBTyxXQUFXLEtBQUssUUFBUSxFQUFFO1lBQ25DLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLE9BQU8sSUFBSSxXQUFXLENBQUMsQ0FBQTtTQUNqRTs7WUFBTSxNQUFNLElBQUksU0FBUyxDQUFDLDBDQUEwQyxDQUFDLENBQUE7SUFDeEUsQ0FBQyxDQUFBO0FBQ0gsQ0FBQztBQU1ELE1BQU0sMEJBQTRDLFFBQVc7SUFDM0QsTUFBTSxXQUFXLEdBQVEsUUFBUSxDQUFBO0lBQ2pDLFdBQVcsQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLElBQUksR0FBRyxFQUFFLENBQUE7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UUFFbEIsU0FBUzthQUNOLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDVCxJQUFJLElBQUksQ0FBQyxlQUFlLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFO2dCQUN6QyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQTtnQkFDbkIsSUFBSTtvQkFDRixNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUE7b0JBQ2hDLElBQUksQ0FBQyxJQUFJLGFBQWEsQ0FBQyxDQUFDLENBQUMsRUFBRTt3QkFDekIsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUE7cUJBQ3BDO2lCQUNGO2dCQUFDLE9BQU8sQ0FBQyxFQUFFO29CQUNWLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFBO2lCQUN0QjthQUNGO1FBQ0gsQ0FBQyxDQUFDO2FBQ0QsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUN0QyxDQUFDOztBQXBGTSxhQUFNLEdBQUcsTUFBTSxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2xpZW50IH0gZnJvbSAnLi4vY29tbW9uL2pzb24tcnBjL0NsaWVudCdcbmltcG9ydCB7IGdldEFwaSB9IGZyb20gJy4uL2NvbW1vbi9qc29uLXJwYy9BUEknXG5pbXBvcnQgeyBJTG9nT3B0cywgU2NyaXB0aW5nVHJhbnNwb3J0IH0gZnJvbSAnLi4vY29tbW9uL2pzb24tcnBjL3R5cGVzJ1xuaW1wb3J0IHsgaXNQcm9taXNlTGlrZSB9IGZyb20gJy4uL2NvbW1vbi9jb3JlL2lzUHJvbWlzZUxpa2UnXG5cbi8qKiB0aGlzIGlzIGRlZmluZWQgaW4gdGhlIGNvbnN0cnVjdG9yIFNjcmlwdGluZ0hvc3QoKSAqL1xuY29uc3QgbG9hZEFQSXNOb3RpZmljYXRpb25OYW1lID0gJ0xvYWRDb21wb25lbnRzJ1xuXG4vLyBJZiB0aGVyZSBpcyBubyBuYXRpdmUgU3ltYm9sXG4vLyBub3IgcG9seWZpbGwsIHRoZW4gYSBwbGFpbiBudW1iZXIgaXMgdXNlZCBmb3IgcGVyZm9ybWFuY2UuXG5cbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZVxuY29uc3QgaGFzU3ltYm9sID0gdHlwZW9mIFN5bWJvbCA9PT0gJ2Z1bmN0aW9uJyAmJiBTeW1ib2wuZm9yXG5cbmNvbnN0IGluamVjdGVkQVBJU3ltYm9sID0gaGFzU3ltYm9sID8gU3ltYm9sKCdpbmplY3RlZEFQSXMnKSA6IDB4ZmVhMFxuXG5leHBvcnQgaW50ZXJmYWNlIFNjcmlwdCB7XG4gIHN5c3RlbURpZEVuYWJsZT8oKTogUHJvbWlzZTx2b2lkPiB8IHZvaWRcbn1cblxuZXhwb3J0IHR5cGUgQVBJID0gYW55XG5cbi8qKlxuICogVGhpcyBmdW5jdGlvbiBkZWNvcmF0ZXMgcGFyYW1ldGVycyB0byBsb2FkIEFQSXNcbiAqIEBwYXJhbSBhcGlOYW1lIG5hbWUgb2YgdGhlIEFQSSB0byBsb2FkXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpbmplY3QoYXBpTmFtZT86IHN0cmluZykge1xuICBpZiAoYXBpTmFtZSAhPT0gdW5kZWZpbmVkICYmICFhcGlOYW1lKSB7XG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQVBJIG5hbWUgY2Fubm90IGJlIG51bGwgLyBlbXB0eScpXG4gIH1cbiAgcmV0dXJuIGZ1bmN0aW9uPFQgZXh0ZW5kcyBTY3JpcHQ+KHRhcmdldDogVCwgcHJvcGVydHlLZXk6IGtleW9mIFQpIHtcbiAgICBpZiAodHlwZW9mIHByb3BlcnR5S2V5ID09PSAnc3RyaW5nJykge1xuICAgICAgZ2V0SW5qZWN0ZWRBUElzKHRhcmdldCkuc2V0KHByb3BlcnR5S2V5LCBhcGlOYW1lIHx8IHByb3BlcnR5S2V5KVxuICAgIH0gZWxzZSB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgaW5qZWN0IEFQSXMgd2l0aCBub24tc3RyaW5nIG5hbWVzJylcbiAgfVxufVxuXG4vKipcbiAqIEdldHMgYWxsIHRoZSBpbmplY3RlZCBBUElzIG9mIGEgc2NyaXB0XG4gKiBAcGFyYW0gaW5zdGFuY2UgQSBzY3JpcHQgdG8gZ2V0IHRoZSBBUElzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRJbmplY3RlZEFQSXM8VCBleHRlbmRzIFNjcmlwdD4oaW5zdGFuY2U6IFQpOiBNYXA8a2V5b2YgVCwgc3RyaW5nPiB7XG4gIGNvbnN0IGluc3RhbmNlQW55OiBhbnkgPSBpbnN0YW5jZVxuICBpbnN0YW5jZUFueVtpbmplY3RlZEFQSVN5bWJvbF0gPSBpbnN0YW5jZUFueVtpbmplY3RlZEFQSVN5bWJvbF0gfHwgbmV3IE1hcCgpXG4gIHJldHVybiBpbnN0YW5jZUFueVtpbmplY3RlZEFQSVN5bWJvbF1cbn1cblxuYXN5bmMgZnVuY3Rpb24gX2luamVjdEFQSXModGFyZ2V0OiBTY3JpcHQpIHtcbiAgY29uc3QgaW5qZWN0ZWRNYXAgPSBnZXRJbmplY3RlZEFQSXModGFyZ2V0KVxuXG4gIGlmIChpbmplY3RlZE1hcC5zaXplID09PSAwKSByZXR1cm5cblxuICBhd2FpdCB0YXJnZXQubG9hZEFQSXMoQXJyYXkuZnJvbShpbmplY3RlZE1hcC52YWx1ZXMoKSkpXG5cbiAgaW5qZWN0ZWRNYXAuZm9yRWFjaChmdW5jdGlvbihhcGlOYW1lOiBzdHJpbmcsIHByb3BlcnR5KSB7XG4gICAgdGFyZ2V0W3Byb3BlcnR5XSA9IHRhcmdldC5sb2FkZWRBUElzW2FwaU5hbWVdXG4gIH0pXG59XG5cbmV4cG9ydCBjbGFzcyBTY3JpcHQgZXh0ZW5kcyBDbGllbnQge1xuICBzdGF0aWMgaW5qZWN0ID0gaW5qZWN0XG5cbiAgbG9hZGVkQVBJczogeyBba2V5OiBzdHJpbmddOiBBUEkgfSA9IHt9XG5cbiAgcHJvdGVjdGVkIHN0YXJ0ZWQgPSBmYWxzZVxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgdHJhbnNwb3J0OiBTY3JpcHRpbmdUcmFuc3BvcnQsIG9wdD86IElMb2dPcHRzKSB7XG4gICAgc3VwZXIob3B0KVxuXG4gICAgaWYgKHRyYW5zcG9ydC5vbkVycm9yKSB7XG4gICAgICB0cmFuc3BvcnQub25FcnJvcihlID0+IHtcbiAgICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIGUpXG4gICAgICB9KVxuICAgIH1cblxuICAgIGlmICh0cmFuc3BvcnQub25DbG9zZSkge1xuICAgICAgdHJhbnNwb3J0Lm9uQ2xvc2UoKCkgPT4ge1xuICAgICAgICB0aGlzLmVtaXQoJ3RyYW5zcG9ydENsb3NlZCcpXG4gICAgICB9KVxuICAgIH1cblxuICAgIHRyYW5zcG9ydC5vbk1lc3NhZ2UobWVzc2FnZSA9PiB7XG4gICAgICB0aGlzLnByb2Nlc3NNZXNzYWdlKG1lc3NhZ2UpXG4gICAgfSlcblxuICAgIGlmICh0cmFuc3BvcnQub25Db25uZWN0KSB7XG4gICAgICB0cmFuc3BvcnQub25Db25uZWN0KCgpID0+IHtcbiAgICAgICAgdGhpcy5kaWRDb25uZWN0KClcbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZGlkQ29ubmVjdCgpXG4gICAgfVxuICB9XG5cbiAgc2VuZE1lc3NhZ2UobWVzc2FnZTogc3RyaW5nKSB7XG4gICAgdGhpcy50cmFuc3BvcnQuc2VuZE1lc3NhZ2UobWVzc2FnZSlcbiAgfVxuXG4gIC8qKlxuICAgKiBQcm92aWRlIGEgZ2xvYmFsIHBvaW50IG9mIGFjY2VzcyB0byBhIHNlcnZpY2Ugd2l0aG91dFxuICAgKiBjb3VwbGluZyB1c2VycyB0byB0aGUgY29uY3JldGUgY2xhc3MgdGhhdCBpbXBsZW1lbnRzIGl0LlxuICAgKlxuICAgKiBAcGFyYW0gYXBpTmFtZSBOYW1lIG9mIHRoZSBwbHVnaW4gd2UgYXJlIHRyeWluZyB0byBvYnRhaW5cbiAgICogQHJldHVybnMge29iamVjdH0gbG9hZGVkQVBJc1xuICAgKi9cbiAgYXN5bmMgbG9hZEFQSXMoYXBpTmFtZTogc3RyaW5nW10pOiBQcm9taXNlPHsgW2tleTogc3RyaW5nXTogYW55IH0+IHtcbiAgICBjb25zdCBsb2FkZWRLZXlzID0gT2JqZWN0LmtleXModGhpcy5sb2FkZWRBUElzKVxuXG4gICAgY29uc3Qga2V5c1RvUmVxdWVzdCA9IGFwaU5hbWUuZmlsdGVyKGZ1bmN0aW9uKCQpIHtcbiAgICAgIHJldHVybiAhbG9hZGVkS2V5cy5pbmNsdWRlcygkKVxuICAgIH0pXG5cbiAgICBpZiAoa2V5c1RvUmVxdWVzdC5sZW5ndGgpIHtcbiAgICAgIGF3YWl0IHRoaXMuY2FsbChsb2FkQVBJc05vdGlmaWNhdGlvbk5hbWUsIFtrZXlzVG9SZXF1ZXN0XSlcblxuICAgICAgLy8gTG9hZCAvIHJlcXVlc3QgdGhlIEFQSVxuICAgICAga2V5c1RvUmVxdWVzdC5mb3JFYWNoKGFzeW5jIGFwaU5hbWUgPT4ge1xuICAgICAgICB0aGlzLmxvYWRlZEFQSXNbYXBpTmFtZV0gPSBnZXRBcGkodGhpcywgYXBpTmFtZSlcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMubG9hZGVkQVBJc1xuICB9XG5cbiAgcHJvdGVjdGVkIGRpZENvbm5lY3QoKSB7XG4gICAgY29uc3QgaW5qZWN0aW9uID0gX2luamVjdEFQSXModGhpcylcblxuICAgIHN1cGVyLmRpZENvbm5lY3QoKVxuXG4gICAgaW5qZWN0aW9uXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLnN5c3RlbURpZEVuYWJsZSAmJiAhdGhpcy5zdGFydGVkKSB7XG4gICAgICAgICAgdGhpcy5zdGFydGVkID0gdHJ1ZVxuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCByID0gdGhpcy5zeXN0ZW1EaWRFbmFibGUoKVxuICAgICAgICAgICAgaWYgKHIgJiYgaXNQcm9taXNlTGlrZShyKSkge1xuICAgICAgICAgICAgICByLmNhdGNoKGUgPT4gdGhpcy5lbWl0KCdlcnJvcicsIGUpKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRoaXMuZW1pdCgnZXJyb3InLCBlKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIC5jYXRjaChlID0+IHRoaXMuZW1pdCgnZXJyb3InLCBlKSlcbiAgfVxufVxuIl19