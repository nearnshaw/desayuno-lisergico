const eventSplitter = /\s+/g;
export class EventDispatcherBinding {
    constructor(id, cb, event, sharedList, object) {
        this.id = id;
        this.cb = cb;
        this.event = event;
        this.sharedList = sharedList;
        this.object = object;
        this.enabled = true;
    }
    off() {
        if (this.object) {
            this.cb && this.object.off(this);
            this.cb = null;
            this.object = null;
            if (this.sharedList) {
                delete this.sharedList;
            }
        }
    }
    enable() {
        if (this.sharedList) {
            for (let i = 0; i < this.sharedList.length; i++) {
                this.sharedList[i].enabled = true;
            }
        }
        else
            this.enabled = true;
    }
    disable() {
        if (this.sharedList) {
            for (let i = 0; i < this.sharedList.length; i++) {
                this.sharedList[i].enabled = false;
            }
        }
        else {
            this.enabled = false;
        }
    }
}
function turnOffCallback(f) {
    delete f.cb;
}
export class EventDispatcher {
    constructor() {
        this.edBindings = {};
        this.edBindCount = 0;
    }
    on(event, callback, once) {
        this.edBindCount++;
        let events = event.split(eventSplitter);
        let bindList = [];
        let latest = null;
        for (let evt of events) {
            let tmp = new EventDispatcherBinding(this.edBindCount, null, evt, bindList, this);
            bindList && bindList.push(tmp);
            if (once) {
                tmp.cb = function () {
                    callback.apply(this, arguments);
                    tmp.cb = null;
                }.bind(this);
            }
            else {
                tmp.cb = callback.bind(this);
            }
            this.edBindings[evt] = this.edBindings[evt] || [];
            this.edBindings[evt].push(tmp);
            latest = tmp;
        }
        return latest;
    }
    once(event, callback) {
        return this.on(event, callback, true);
    }
    off(arg0, arg1) {
        if (arguments.length === 0) {
            for (let i in this.edBindings) {
                for (let e in this.edBindings[i]) {
                    delete this.edBindings[i][e].cb;
                }
                this.edBindings[i].length = 0;
            }
        }
        else if (arg0 instanceof EventDispatcherBinding) {
            arg0.cb = null;
            arg0.sharedList && arg0.sharedList.length && arg0.sharedList.forEach(turnOffCallback);
        }
        else if (typeof arg0 === 'string') {
            if (typeof arg1 === 'function') {
                for (let i in this.edBindings[arg0]) {
                    if (this.edBindings[arg0][i].cb === arg1) {
                        this.edBindings[arg0][i].cb = null;
                    }
                }
            }
            else if (typeof arg0 === 'string') {
                this.edBindings[arg0] = [];
            }
        }
        else if (typeof arg0 === 'function') {
            for (let evt in this.edBindings) {
                for (let i in this.edBindings[evt]) {
                    if (this.edBindings[evt][i].cb === arg0) {
                        this.edBindings[evt][i].cb = null;
                    }
                }
            }
        }
    }
    emit(event) {
        if (event in this.edBindings) {
            if (arguments.length === 1) {
                for (let i = 0; i < this.edBindings[event].length; i++) {
                    let e = this.edBindings[event][i];
                    e && e.cb && e.enabled && e.cb();
                }
            }
            else if (arguments.length === 2) {
                for (let i = 0; i < this.edBindings[event].length; i++) {
                    let e = this.edBindings[event][i];
                    e && e.cb && e.enabled && e.cb(arguments[1]);
                }
            }
            else if (arguments.length === 3) {
                for (let i = 0; i < this.edBindings[event].length; i++) {
                    let e = this.edBindings[event][i];
                    e && e.cb && e.enabled && e.cb(arguments[1], arguments[2]);
                }
            }
            else if (arguments.length === 4) {
                for (let i = 0; i < this.edBindings[event].length; i++) {
                    let e = this.edBindings[event][i];
                    e && e.cb && e.enabled && e.cb(arguments[1], arguments[2], arguments[3]);
                }
            }
            else if (arguments.length === 5) {
                for (let i = 0; i < this.edBindings[event].length; i++) {
                    let e = this.edBindings[event][i];
                    e && e.cb && e.enabled && e.cb(arguments[1], arguments[2], arguments[3], arguments[4]);
                }
            }
            else if (arguments.length > 4) {
                let args = Array.prototype.slice.call(arguments, 1);
                for (let i = 0; i < this.edBindings[event].length; i++) {
                    let e = this.edBindings[event][i];
                    e && e.cb && e.enabled && e.cb.apply(this, args);
                }
            }
        }
        else if (event === 'error') {
            const firstArgument = arguments[1];
            let error = null;
            if (firstArgument instanceof Error) {
                error = firstArgument;
            }
            else {
                error = Object.assign(new Error('EventDispatcher: Unhandled "error" event'), { data: arguments });
            }
            console.error(error);
            console.trace(arguments);
            throw error;
        }
    }
    getEventBindings(event) {
        return (this.edBindings[event] || []).filter($ => $ && $.enabled);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRXZlbnREaXNwYXRjaGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbW1vbi9jb3JlL0V2ZW50RGlzcGF0Y2hlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFJQSxNQUFNLGFBQWEsR0FBRyxNQUFNLENBQUE7QUFFNUIsTUFBTTtJQUVKLFlBQ1MsRUFBVSxFQUNWLEVBQW1CLEVBQ25CLEtBQWEsRUFDYixVQUFvQyxFQUNwQyxNQUFtQztRQUpuQyxPQUFFLEdBQUYsRUFBRSxDQUFRO1FBQ1YsT0FBRSxHQUFGLEVBQUUsQ0FBaUI7UUFDbkIsVUFBSyxHQUFMLEtBQUssQ0FBUTtRQUNiLGVBQVUsR0FBVixVQUFVLENBQTBCO1FBQ3BDLFdBQU0sR0FBTixNQUFNLENBQTZCO1FBTjVDLFlBQU8sR0FBWSxJQUFJLENBQUE7SUFPcEIsQ0FBQztJQUVKLEdBQUc7UUFDRCxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDZixJQUFJLENBQUMsRUFBRSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFBO1lBQ2hDLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFBO1lBQ2QsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUE7WUFDbEIsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFO2dCQUNuQixPQUFPLElBQUksQ0FBQyxVQUFVLENBQUE7YUFDdkI7U0FDRjtJQUNILENBQUM7SUFFRCxNQUFNO1FBQ0osSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ25CLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDL0MsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFBO2FBQ2xDO1NBQ0Y7O1lBQU0sSUFBSSxDQUFDLE9BQU8sR0FB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SUFBSSxTQUFTLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtnQkFDMUIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUN0RCxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO29CQUNqQyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsT0FBTyxJQUFJLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQTtpQkFDakM7YUFDRjtpQkFBTSxJQUFJLFNBQVMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUNqQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7b0JBQ3RELElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7b0JBQ2pDLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxPQUFPLElBQUksQ0FBQyxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtpQkFDN0M7YUFDRjtpQkFBTSxJQUFJLFNBQVMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUNqQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7b0JBQ3RELElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7b0JBQ2pDLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxJ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QyxVQUFVLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUNuRSxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJleHBvcnQgaW50ZXJmYWNlIERpY3Rpb25hcnk8VCA9IGFueT4ge1xuICBba2V5OiBzdHJpbmddOiBUXG59XG5cbmNvbnN0IGV2ZW50U3BsaXR0ZXIgPSAvXFxzKy9nXG5cbmV4cG9ydCBjbGFzcyBFdmVudERpc3BhdGNoZXJCaW5kaW5nIHtcbiAgZW5hYmxlZDogYm9vbGVhbiA9IHRydWVcbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIGlkOiBudW1iZXIsXG4gICAgcHVibGljIGNiOiBGdW5jdGlvbiB8IG51bGwsXG4gICAgcHVibGljIGV2ZW50OiBzdHJpbmcsXG4gICAgcHVibGljIHNoYXJlZExpc3Q6IEV2ZW50RGlzcGF0Y2hlckJpbmRpbmdbXSxcbiAgICBwdWJsaWMgb2JqZWN0OiBFdmVudERpc3BhdGNoZXI8YW55PiB8IG51bGxcbiAgKSB7fVxuXG4gIG9mZigpIHtcbiAgICBpZiAodGhpcy5vYmplY3QpIHtcbiAgICAgIHRoaXMuY2IgJiYgdGhpcy5vYmplY3Qub2ZmKHRoaXMpXG4gICAgICB0aGlzLmNiID0gbnVsbFxuICAgICAgdGhpcy5vYmplY3QgPSBudWxsXG4gICAgICBpZiAodGhpcy5zaGFyZWRMaXN0KSB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLnNoYXJlZExpc3RcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBlbmFibGUoKSB7XG4gICAgaWYgKHRoaXMuc2hhcmVkTGlzdCkge1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnNoYXJlZExpc3QubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgdGhpcy5zaGFyZWRMaXN0W2ldLmVuYWJsZWQgPSB0cnVlXG4gICAgICB9XG4gICAgfSBlbHNlIHRoaXMuZW5hYmxlZCA9IHRydWVcbiAgfVxuXG4gIGRpc2FibGUoKSB7XG4gICAgaWYgKHRoaXMuc2hhcmVkTGlzdCkge1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnNoYXJlZExpc3QubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgdGhpcy5zaGFyZWRMaXN0W2ldLmVuYWJsZWQgPSBmYWxzZVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmVuYWJsZWQgPSBmYWxzZVxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiB0dXJuT2ZmQ2FsbGJhY2soZjogRXZlbnREaXNwYXRjaGVyQmluZGluZykge1xuICBkZWxldGUgZi5jYlxufVxuXG5leHBvcnQgaW50ZXJmYWNlIEV2ZW50RGlzcGF0Y2hlckV2ZW50c0Jhc2Uge1xuICBba2V5OiBzdHJpbmddOiBGdW5jdGlvblxufVxuXG5leHBvcnQgY2xhc3MgRXZlbnREaXNwYXRjaGVyPFQgPSBFdmVudERpc3BhdGNoZXJFdmVudHNCYXNlPiB7XG4gIHByaXZhdGUgZWRCaW5kaW5nczogRGljdGlvbmFyeTxFdmVudERpc3BhdGNoZXJCaW5kaW5nW10+ID0ge31cbiAgcHJpdmF0ZSBlZEJpbmRDb3VudCA9IDBcblxuICBvbjxLIGV4dGVuZHMga2V5b2YgVD4oZXZlbnQ6IEssIGNhbGxiYWNrOiBUW0tdLCBvbmNlPzogYm9vbGVhbik6IEV2ZW50RGlzcGF0Y2hlckJpbmRpbmdcbiAgb24oZXZlbnQ6IHN0cmluZywgY2FsbGJhY2s6ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCwgb25jZT86IGJvb2xlYW4pOiBFdmVudERpc3BhdGNoZXJCaW5kaW5nXG4gIG9uKGV2ZW50OiBzdHJpbmcsIGNhbGxiYWNrOiBhbnksIG9uY2U/OiBib29sZWFuKTogRXZlbnREaXNwYXRjaGVyQmluZGluZyB7XG4gICAgdGhpcy5lZEJpbmRDb3VudCsrXG5cbiAgICBsZXQgZXZlbnRzID0gZXZlbnQuc3BsaXQoZXZlbnRTcGxpdHRlcilcblxuICAgIGxldCBiaW5kTGlzdDogRXZlbnREaXNwYXRjaGVyQmluZGluZ1tdID0gW11cbiAgICBsZXQgbGF0ZXN0OiBFdmVudERpc3BhdGNoZXJCaW5kaW5nIHwgbnVsbCA9IG51bGxcblxuICAgIGZvciAobGV0IGV2dCBvZiBldmVudHMpIHtcbiAgICAgIGxldCB0bXAgPSBuZXcgRXZlbnREaXNwYXRjaGVyQmluZGluZyh0aGlzLmVkQmluZENvdW50LCBudWxsLCBldnQsIGJpbmRMaXN0LCB0aGlzKVxuXG4gICAgICBiaW5kTGlzdCAmJiBiaW5kTGlzdC5wdXNoKHRtcClcblxuICAgICAgaWYgKG9uY2UpIHtcbiAgICAgICAgdG1wLmNiID0gZnVuY3Rpb24odGhpczogRXZlbnREaXNwYXRjaGVyPFQ+KSB7XG4gICAgICAgICAgY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKVxuICAgICAgICAgIHRtcC5jYiA9IG51bGxcbiAgICAgICAgfS5iaW5kKHRoaXMpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0bXAuY2IgPSBjYWxsYmFjay5iaW5kKHRoaXMpXG4gICAgICB9XG5cbiAgICAgIHRoaXMuZWRCaW5kaW5nc1tldnRdID0gdGhpcy5lZEJpbmRpbmdzW2V2dF0gfHwgW11cbiAgICAgIHRoaXMuZWRCaW5kaW5nc1tldnRdLnB1c2godG1wKVxuXG4gICAgICBsYXRlc3QgPSB0bXBcbiAgICB9XG5cbiAgICByZXR1cm4gbGF0ZXN0IGFzIEV2ZW50RGlzcGF0Y2hlckJpbmRpbmdcbiAgfVxuXG4gIG9uY2U8SyBleHRlbmRzIGtleW9mIFQ+KGV2ZW50OiBLLCBjYWxsYmFjazogVFtLXSk6IEV2ZW50RGlzcGF0Y2hlckJpbmRpbmdcbiAgb25jZShldmVudDogc3RyaW5nLCBjYWxsYmFjazogRnVuY3Rpb24pOiBFdmVudERpc3BhdGNoZXJCaW5kaW5nXG4gIG9uY2UoZXZlbnQ6IHN0cmluZywgY2FsbGJhY2s6IGFueSkge1xuICAgIHJldHVybiB0aGlzLm9uKGV2ZW50LCBjYWxsYmFjaywgdHJ1ZSlcbiAgfVxuXG4gIG9mZihiaW5kaW5nOiBFdmVudERpc3BhdGNoZXJCaW5kaW5nKTogdm9pZFxuICBvZmYoZXZlbnROYW1lOiBzdHJpbmcsIGJvdW5kQ2FsbGJhY2s/OiBGdW5jdGlvbik6IHZvaWRcbiAgb2ZmKGJvdW5kQ2FsbGJhY2s6IEZ1bmN0aW9uKTogdm9pZFxuICBvZmYoYXJnMD86IHN0cmluZyB8IEZ1bmN0aW9uIHwgRXZlbnREaXNwYXRjaGVyQmluZGluZywgYXJnMT86IEZ1bmN0aW9uKTogdm9pZCB7XG4gICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHtcbiAgICAgIGZvciAobGV0IGkgaW4gdGhpcy5lZEJpbmRpbmdzKSB7XG4gICAgICAgIGZvciAobGV0IGUgaW4gdGhpcy5lZEJpbmRpbmdzW2ldKSB7XG4gICAgICAgICAgZGVsZXRlIHRoaXMuZWRCaW5kaW5nc1tpXVtlXS5jYlxuICAgICAgICB9XG4gICAgICAgIHRoaXMuZWRCaW5kaW5nc1tpXS5sZW5ndGggPSAwXG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChhcmcwIGluc3RhbmNlb2YgRXZlbnREaXNwYXRjaGVyQmluZGluZykge1xuICAgICAgYXJnMC5jYiA9IG51bGxcbiAgICAgIGFyZzAuc2hhcmVkTGlzdCAmJiBhcmcwLnNoYXJlZExpc3QubGVuZ3RoICYmIGFyZzAuc2hhcmVkTGlzdC5mb3JFYWNoKHR1cm5PZmZDYWxsYmFjaylcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmcwID09PSAnc3RyaW5nJykge1xuICAgICAgaWYgKHR5cGVvZiBhcmcxID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGZvciAobGV0IGkgaW4gdGhpcy5lZEJpbmRpbmdzW2FyZzBdKSB7XG4gICAgICAgICAgaWYgKHRoaXMuZWRCaW5kaW5nc1thcmcwXVtpXS5jYiA9PT0gYXJnMSkge1xuICAgICAgICAgICAgdGhpcy5lZEJpbmRpbmdzW2FyZzBdW2ldLmNiID0gbnVsbFxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmICh0eXBlb2YgKGFyZzAgYXMgYW55KSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgdGhpcy5lZEJpbmRpbmdzW2FyZzBdID0gW11cbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmcwID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBmb3IgKGxldCBldnQgaW4gdGhpcy5lZEJpbmRpbmdzKSB7XG4gICAgICAgIGZvciAobGV0IGkgaW4gdGhpcy5lZEJpbmRpbmdzW2V2dF0pIHtcbiAgICAgICAgICBpZiAodGhpcy5lZEJpbmRpbmdzW2V2dF1baV0uY2IgPT09IGFyZzApIHtcbiAgICAgICAgICAgIHRoaXMuZWRCaW5kaW5nc1tldnRdW2ldLmNiID0gbnVsbFxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGVtaXQoZXZlbnQ6ICdlcnJvcicsIGVycm9yOiBhbnkpOiB2b2lkXG4gIGVtaXQ8SyBleHRlbmRzIGtleW9mIFQ+KGV2ZW50OiBLLCAuLi5wYXJhbXM6IGFueVtdKTogdm9pZFxuICBlbWl0KGV2ZW50OiBzdHJpbmcsIC4uLnBhcmFtczogYW55W10pOiB2b2lkXG4gIGVtaXQoZXZlbnQ6IHN0cmluZykge1xuICAgIGlmIChldmVudCBpbiB0aGlzLmVkQmluZGluZ3MpIHtcbiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5lZEJpbmRpbmdzW2V2ZW50XS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIGxldCBlID0gdGhpcy5lZEJpbmRpbmdzW2V2ZW50XVtpXVxuICAgICAgICAgIGUgJiYgZS5jYiAmJiBlLmVuYWJsZWQgJiYgZS5jYigpXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuZWRCaW5kaW5nc1tldmVudF0ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBsZXQgZSA9IHRoaXMuZWRCaW5kaW5nc1tldmVudF1baV1cbiAgICAgICAgICBlICYmIGUuY2IgJiYgZS5lbmFibGVkICYmIGUuY2IoYXJndW1lbnRzWzFdKVxuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDMpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmVkQmluZGluZ3NbZXZlbnRdLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgbGV0IGUgPSB0aGlzLmVkQmluZGluZ3NbZXZlbnRdW2ldXG4gICAgICAgICAgZSAmJiBlLmNiICYmIGUuZW5hYmxlZCAmJiBlLmNiKGFyZ3VtZW50c1sxXSwgYXJndW1lbnRzWzJdKVxuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDQpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmVkQmluZGluZ3NbZXZlbnRdLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgbGV0IGUgPSB0aGlzLmVkQmluZGluZ3NbZXZlbnRdW2ldXG4gICAgICAgICAgZSAmJiBlLmNiICYmIGUuZW5hYmxlZCAmJiBlLmNiKGFyZ3VtZW50c1sxXSwgYXJndW1lbnRzWzJdLCBhcmd1bWVudHNbM10pXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gNSkge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuZWRCaW5kaW5nc1tldmVudF0ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBsZXQgZSA9IHRoaXMuZWRCaW5kaW5nc1tldmVudF1baV1cbiAgICAgICAgICBlICYmIGUuY2IgJiYgZS5lbmFibGVkICYmIGUuY2IoYXJndW1lbnRzWzFdLCBhcmd1bWVudHNbMl0sIGFyZ3VtZW50c1szXSwgYXJndW1lbnRzWzRdKVxuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiA0KSB7XG4gICAgICAgIGxldCBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKVxuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5lZEJpbmRpbmdzW2V2ZW50XS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIGxldCBlID0gdGhpcy5lZEJpbmRpbmdzW2V2ZW50XVtpXVxuICAgICAgICAgIGUgJiYgZS5jYiAmJiBlLmVuYWJsZWQgJiYgZS5jYi5hcHBseSh0aGlzLCBhcmdzKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChldmVudCA9PT0gJ2Vycm9yJykge1xuICAgICAgY29uc3QgZmlyc3RBcmd1bWVudDogYW55ID0gYXJndW1lbnRzWzFdXG4gICAgICBsZXQgZXJyb3I6IEVycm9yIHwgbnVsbCA9IG51bGxcblxuICAgICAgaWYgKGZpcnN0QXJndW1lbnQgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgICAgICBlcnJvciA9IGZpcnN0QXJndW1lbnRcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGVycm9yID0gT2JqZWN0LmFzc2lnbihuZXcgRXJyb3IoJ0V2ZW50RGlzcGF0Y2hlcjogVW5oYW5kbGVkIFwiZXJyb3JcIiBldmVudCcpLCB7IGRhdGE6IGFyZ3VtZW50cyB9KVxuICAgICAgfVxuXG4gICAgICBjb25zb2xlLmVycm9yKGVycm9yKVxuICAgICAgY29uc29sZS50cmFjZShhcmd1bWVudHMpXG5cbiAgICAgIHRocm93IGVycm9yXG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIGdldEV2ZW50QmluZGluZ3MoZXZlbnQ6IHN0cmluZykge1xuICAgIHJldHVybiAodGhpcy5lZEJpbmRpbmdzW2V2ZW50XSB8fCBbXSkuZmlsdGVyKCQgPT4gJCAmJiAkLmVuYWJsZWQpXG4gIH1cbn1cbiJdfQ==