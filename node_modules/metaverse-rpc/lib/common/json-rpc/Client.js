import { EventDispatcher } from '../core/EventDispatcher';
import { createCodec, encode, decode } from 'msgpack-lite';
const codec = createCodec();
export class Client extends EventDispatcher {
    constructor(opts) {
        super();
        this.sendEncoding = 'JSON';
        this._responsePromiseMap = new Map();
        this._nextMessageId = 0;
        this._consoleLog = false;
        this._requestQueue = [];
        this._connected = false;
        this.setLogging(opts);
    }
    processMessage(messageStr) {
        let message;
        if (typeof messageStr === 'string' && messageStr.charAt(0) === '{') {
            this._logMessage(messageStr, 'receive');
            try {
                message = JSON.parse(messageStr);
            }
            catch (e) {
                return this.emit('error', e);
            }
        }
        else if (typeof messageStr === 'string' ||
            messageStr instanceof Uint8Array ||
            (typeof Buffer !== 'undefined' && messageStr instanceof Buffer) ||
            messageStr instanceof Array) {
            message = decode(messageStr, { codec });
        }
        else {
            message = messageStr;
        }
        if (!message) {
            this.emit('error', new Error(`Message cannot be null, empty or undefined`));
        }
        else if (message.id) {
            if (this._responsePromiseMap.has(message.id)) {
                const promise = this._responsePromiseMap.get(message.id);
                this._responsePromiseMap.delete(message.id);
                if ('result' in message) {
                    promise.resolve(message.result);
                }
                else if ('error' in message) {
                    const error = Object.assign(new Error('Remote error'), message.error, (message.error && message.error.data) || {});
                    promise.reject(error);
                }
                else {
                    promise.reject(Object.assign(new Error(`Response must have result or error: ${messageStr}`), {
                        code: -32700
                    }));
                }
            }
            else {
                this.emit('error', new Error(`Response with id:${message.id} has no pending request`));
            }
        }
        else if (message.method) {
            this.emit(message.method, message.params);
        }
        else {
            this.emit('error', new Error(`Invalid message: ${messageStr}`));
        }
    }
    setLogging({ logConsole } = {}) {
        this._consoleLog = !!logConsole;
    }
    call(method, params) {
        if (typeof params !== 'undefined' && typeof params !== 'object') {
            throw new Error(`Client#call Params must be structured data (Array | Object) got ${JSON.stringify(params)}`);
        }
        const id = ++this._nextMessageId;
        const message = { id, method, params, jsonrpc: '2.0' };
        return new Promise((resolve, reject) => {
            try {
                this._responsePromiseMap.set(id, { resolve, reject });
                this._send(message);
            }
            catch (error) {
                return reject(error);
            }
        });
    }
    notify(method, params) {
        if (typeof params !== 'undefined' && typeof params !== 'object') {
            throw new Error(`Client#notify Params must be structured data (Array | Object) got ${JSON.stringify(params)}`);
        }
        this._send({ method, params, jsonrpc: '2.0' });
    }
    didConnect() {
        if (this._connected === false) {
            this._connected = true;
            this._sendQueuedRequests();
        }
    }
    _send(message) {
        if (this.sendEncoding === 'msgpack') {
            this._requestQueue.push(encode(message, { codec }));
        }
        else {
            this._requestQueue.push(JSON.stringify(message));
        }
        this._sendQueuedRequests();
    }
    _sendQueuedRequests() {
        if (this._connected) {
            const queue = this._requestQueue.splice(0, this._requestQueue.length);
            for (let messageStr of queue) {
                this._logMessage(messageStr, 'send');
                this.sendMessage(messageStr);
            }
        }
    }
    _logMessage(message, direction) {
        if (this._consoleLog) {
            console.log(`Client ${direction === 'send' ? '>' : '<'}`, message.toString());
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbW1vbi9qc29uLXJwYy9DbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHlCQUF5QixDQUFBO0FBRXpELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLGNBQWMsQ0FBQTtBQUUxRCxNQUFNLEtBQUssR0FBRyxXQUFXLEVBQUUsQ0FBQTtBQU0zQixNQUFNLGFBQXVCLFNBQVEsZUFBZTtJQVNsRCxZQUFZLElBQTJCO1FBQ3JDLEtBQUssRUFBRSxDQUFBO1FBVFQsaUJBQVksR0FBdUIsTUFBTSxDQUFBO1FBRWpDLHdCQUFtQixHQUFxQyxJQUFJLEdBQUcsRUFBRSxDQUFBO1FBQ2pFLG1CQUFjLEdBQVcsQ0FBQyxDQUFBO1FBQzFCLGdCQUFXLEdBQVksS0FBSyxDQUFBO1FBQzVCLGtCQUFhLEdBQXdCLEVBQUUsQ0FBQTtRQUN2QyxlQUFVLEdBQUcsS0FBSyxDQUFBO1FBSXhCLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDdkIsQ0FBQztJQUlNLGNBQWMsQ0FDbkIsVUFBbUc7UUFFbkcsSUFBSSxPQUFvRCxDQUFBO1FBRXhELElBQUksT0FBTyxVQUFVLEtBQUssUUFBUSxJQUFJLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxFQUFFO1lBQ2xFLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLFNBQVMsQ0FBQyxDQUFBO1lBR3ZDLElBQUk7Z0JBQ0YsT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUE7YUFDakM7WUFBQyxPQUFPLENBQUMsRUFBRTtnQkFDVixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFBO2FBQzdCO1NBQ0Y7YUFBTSxJQUNMLE9BQU8s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O1FBQ0QsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUE7SUFDNUIsQ0FBQztJQUVPLG1CQUFtQjtRQUN6QixJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDbkIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUE7WUFDckUsS0FBSyxJQUFJLFVBQVUsSUFBSSxLQUFLLEVBQUU7Z0JBQzVCLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxDQUFBO2dCQUNwQyxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFBO2FBQzdCO1NBQ0Y7SUFDSCxDQUFDO0lBRU8sV0FBVyxDQUFDLE9BQXdCLEVBQUUsU0FBNkI7UUFDekUsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ3BCLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxTQUFTLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFBO1NBQzlFO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXZlbnREaXNwYXRjaGVyIH0gZnJvbSAnLi4vY29yZS9FdmVudERpc3BhdGNoZXInXG5pbXBvcnQgKiBhcyBKc29uUnBjMiBmcm9tICcuL3R5cGVzJ1xuaW1wb3J0IHsgY3JlYXRlQ29kZWMsIGVuY29kZSwgZGVjb2RlIH0gZnJvbSAnbXNncGFjay1saXRlJ1xuXG5jb25zdCBjb2RlYyA9IGNyZWF0ZUNvZGVjKClcblxuLyoqXG4gKiBDcmVhdGVzIGEgUlBDIENsaWVudC5cbiAqIEl0IGlzIGludGVudGlvbmFsIHRoYXQgQ2xpZW50IGRvZXMgbm90IGNyZWF0ZSBhIFdlYlNvY2tldCBvYmplY3Qgc2luY2Ugd2UgcHJlZmVyIGNvbXBvc2FiaWxpdHlcbiAqL1xuZXhwb3J0IGFic3RyYWN0IGNsYXNzIENsaWVudCBleHRlbmRzIEV2ZW50RGlzcGF0Y2hlciBpbXBsZW1lbnRzIEpzb25ScGMyLklDbGllbnQge1xuICBzZW5kRW5jb2Rpbmc6ICdKU09OJyB8ICdtc2dwYWNrJyA9ICdKU09OJ1xuXG4gIHByaXZhdGUgX3Jlc3BvbnNlUHJvbWlzZU1hcDogTWFwPG51bWJlciwgSnNvblJwYzIuUmVzb2x2YWJsZT4gPSBuZXcgTWFwKClcbiAgcHJpdmF0ZSBfbmV4dE1lc3NhZ2VJZDogbnVtYmVyID0gMFxuICBwcml2YXRlIF9jb25zb2xlTG9nOiBib29sZWFuID0gZmFsc2VcbiAgcHJpdmF0ZSBfcmVxdWVzdFF1ZXVlOiAoc3RyaW5nIHwgQnVmZmVyKVtdID0gW11cbiAgcHJpdmF0ZSBfY29ubmVjdGVkID0gZmFsc2VcblxuICBjb25zdHJ1Y3RvcihvcHRzPzogSnNvblJwYzIuSUNsaWVudE9wdHMpIHtcbiAgICBzdXBlcigpXG4gICAgdGhpcy5zZXRMb2dnaW5nKG9wdHMpXG4gIH1cblxuICBhYnN0cmFjdCBzZW5kTWVzc2FnZShtZXNzYWdlOiBzdHJpbmcgfCBCdWZmZXIpOiB2b2lkXG5cbiAgcHVibGljIHByb2Nlc3NNZXNzYWdlKFxuICAgIG1lc3NhZ2VTdHI6IHN0cmluZyB8IChKc29uUnBjMi5JUmVzcG9uc2UgJiBKc29uUnBjMi5JTm90aWZpY2F0aW9uKSB8IEJ1ZmZlciB8IFVpbnQ4QXJyYXkgfCBudW1iZXJbXVxuICApIHtcbiAgICBsZXQgbWVzc2FnZTogSnNvblJwYzIuSVJlc3BvbnNlICYgSnNvblJwYzIuSU5vdGlmaWNhdGlvblxuXG4gICAgaWYgKHR5cGVvZiBtZXNzYWdlU3RyID09PSAnc3RyaW5nJyAmJiBtZXNzYWdlU3RyLmNoYXJBdCgwKSA9PT0gJ3snKSB7XG4gICAgICB0aGlzLl9sb2dNZXNzYWdlKG1lc3NhZ2VTdHIsICdyZWNlaXZlJylcblxuICAgICAgLy8gRW5zdXJlIEpTT04gaXMgbm90IG1hbGZvcm1lZFxuICAgICAgdHJ5IHtcbiAgICAgICAgbWVzc2FnZSA9IEpTT04ucGFyc2UobWVzc2FnZVN0cilcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZW1pdCgnZXJyb3InLCBlKVxuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoXG4gICAgICB0eXBlb2YgbWVzc2FnZVN0ciA9PT0gJ3N0cmluZycgfHxcbiAgICAgIG1lc3NhZ2VTdHIgaW5zdGFuY2VvZiBVaW50OEFycmF5IC8qIHRzbGludDpkaXNhYmxlLW5leHQtbGluZSAqLyB8fFxuICAgICAgKHR5cGVvZiBCdWZmZXIgIT09ICd1bmRlZmluZWQnICYmIG1lc3NhZ2VTdHIgaW5zdGFuY2VvZiBCdWZmZXIpIHx8XG4gICAgICBtZXNzYWdlU3RyIGluc3RhbmNlb2YgQXJyYXlcbiAgICApIHtcbiAgICAgIG1lc3NhZ2UgPSBkZWNvZGUobWVzc2FnZVN0ciBhcyBhbnksIHsgY29kZWMgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgbWVzc2FnZSA9IG1lc3NhZ2VTdHJcbiAgICB9XG5cbiAgICAvLyBDaGVjayB0aGF0IG1lc3NhZ2VzIGlzIHdlbGwgZm9ybWVkXG4gICAgaWYgKCFtZXNzYWdlKSB7XG4gICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgbmV3IEVycm9yKGBNZXNzYWdlIGNhbm5vdCBiZSBudWxsLCBlbXB0eSBvciB1bmRlZmluZWRgKSlcbiAgICB9IGVsc2UgaWYgKG1lc3NhZ2UuaWQpIHtcbiAgICAgIGlmICh0aGlzLl9yZXNwb25zZVByb21pc2VNYXAuaGFzKG1lc3NhZ2UuaWQpKSB7XG4gICAgICAgIC8vIFJlc29sdmUgcHJvbWlzZSBmcm9tIHBlbmRpbmcgbWVzc2FnZVxuICAgICAgICBjb25zdCBwcm9taXNlID0gdGhpcy5fcmVzcG9uc2VQcm9taXNlTWFwLmdldChtZXNzYWdlLmlkKSBhcyBKc29uUnBjMi5SZXNvbHZhYmxlXG4gICAgICAgIHRoaXMuX3Jlc3BvbnNlUHJvbWlzZU1hcC5kZWxldGUobWVzc2FnZS5pZClcblxuICAgICAgICBpZiAoJ3Jlc3VsdCcgaW4gbWVzc2FnZSkge1xuICAgICAgICAgIHByb21pc2UucmVzb2x2ZShtZXNzYWdlLnJlc3VsdClcbiAgICAgICAgfSBlbHNlIGlmICgnZXJyb3InIGluIG1lc3NhZ2UpIHtcbiAgICAgICAgICBjb25zdCBlcnJvciA9IE9iamVjdC5hc3NpZ24oXG4gICAgICAgICAgICBuZXcgRXJyb3IoJ1JlbW90ZSBlcnJvcicpLFxuICAgICAgICAgICAgbWVzc2FnZS5lcnJvcixcbiAgICAgICAgICAgIChtZXNzYWdlLmVycm9yICYmIG1lc3NhZ2UuZXJyb3IuZGF0YSkgfHwge31cbiAgICAgICAgICApXG4gICAgICAgICAgcHJvbWlzZS5yZWplY3QoZXJyb3IpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcHJvbWlzZS5yZWplY3QoXG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKG5ldyBFcnJvcihgUmVzcG9uc2UgbXVzdCBoYXZlIHJlc3VsdCBvciBlcnJvcjogJHttZXNzYWdlU3RyfWApLCB7XG4gICAgICAgICAgICAgIGNvZGU6IEpzb25ScGMyLkVycm9yQ29kZS5QYXJzZUVycm9yXG4gICAgICAgICAgICB9KVxuICAgICAgICAgIClcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIG5ldyBFcnJvcihgUmVzcG9uc2Ugd2l0aCBpZDoke21lc3NhZ2UuaWR9IGhhcyBubyBwZW5kaW5nIHJlcXVlc3RgKSlcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKG1lc3NhZ2UubWV0aG9kKSB7XG4gICAgICAvLyBTZXJ2ZXIgaGFzIHNlbnQgYSBub3RpZmljYXRpb25cbiAgICAgIHRoaXMuZW1pdChtZXNzYWdlLm1ldGhvZCwgbWVzc2FnZS5wYXJhbXMpXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZW1pdCgnZXJyb3InLCBuZXcgRXJyb3IoYEludmFsaWQgbWVzc2FnZTogJHttZXNzYWdlU3RyfWApKVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgbG9nZ2luZyBmb3IgYWxsIHJlY2VpdmVkIGFuZCBzZW50IG1lc3NhZ2VzXG4gICAqL1xuICBwdWJsaWMgc2V0TG9nZ2luZyh7IGxvZ0NvbnNvbGUgfTogSnNvblJwYzIuSUxvZ09wdHMgPSB7fSkge1xuICAgIHRoaXMuX2NvbnNvbGVMb2cgPSAhIWxvZ0NvbnNvbGVcbiAgfVxuXG4gIGNhbGwobWV0aG9kOiBzdHJpbmcpOiBQcm9taXNlPGFueT5cbiAgY2FsbChtZXRob2Q6IHN0cmluZywgcGFyYW1zOiBzdHJpbmcpOiBuZXZlclxuICBjYWxsKG1ldGhvZDogc3RyaW5nLCBwYXJhbXM6IG51bWJlcik6IG5ldmVyXG4gIGNhbGwobWV0aG9kOiBzdHJpbmcsIHBhcmFtczogYm9vbGVhbik6IG5ldmVyXG4gIGNhbGwobWV0aG9kOiBzdHJpbmcsIHBhcmFtczogbnVsbCk6IG5ldmVyXG4gIGNhbGw8VD4obWV0aG9kOiBzdHJpbmcsIHBhcmFtczogSXRlcmFibGU8VD4pOiBQcm9taXNlPGFueT5cbiAgY2FsbChtZXRob2Q6IHN0cmluZywgcGFyYW1zOiB7IFtrZXk6IHN0cmluZ106IGFueSB9KTogUHJvbWlzZTxhbnk+XG4gIGNhbGwobWV0aG9kOiBzdHJpbmcsIHBhcmFtcz86IGFueSkge1xuICAgIGlmICh0eXBlb2YgcGFyYW1zICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgcGFyYW1zICE9PSAnb2JqZWN0Jykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDbGllbnQjY2FsbCBQYXJhbXMgbXVzdCBiZSBzdHJ1Y3R1cmVkIGRhdGEgKEFycmF5IHwgT2JqZWN0KSBnb3QgJHtKU09OLnN0cmluZ2lmeShwYXJhbXMpfWApXG4gICAgfVxuXG4gICAgY29uc3QgaWQgPSArK3RoaXMuX25leHRNZXNzYWdlSWRcbiAgICBjb25zdCBtZXNzYWdlOiBKc29uUnBjMi5JUmVxdWVzdCA9IHsgaWQsIG1ldGhvZCwgcGFyYW1zLCBqc29ucnBjOiAnMi4wJyB9XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgdGhpcy5fcmVzcG9uc2VQcm9taXNlTWFwLnNldChpZCwgeyByZXNvbHZlLCByZWplY3QgfSlcbiAgICAgICAgdGhpcy5fc2VuZChtZXNzYWdlKVxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgcmV0dXJuIHJlamVjdChlcnJvcilcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgbm90aWZ5KG1ldGhvZDogc3RyaW5nKTogdm9pZFxuICBub3RpZnkobWV0aG9kOiBzdHJpbmcsIHBhcmFtczogc3RyaW5nKTogbmV2ZXJcbiAgbm90aWZ5KG1ldGhvZDogc3RyaW5nLCBwYXJhbXM6IG51bWJlcik6IG5ldmVyXG4gIG5vdGlmeShtZXRob2Q6IHN0cmluZywgcGFyYW1zOiBib29sZWFuKTogbmV2ZXJcbiAgbm90aWZ5KG1ldGhvZDogc3RyaW5nLCBwYXJhbXM6IG51bGwpOiBuZXZlclxuICBub3RpZnk8VD4obWV0aG9kOiBzdHJpbmcsIHBhcmFtczogSXRlcmFibGU8VD4pOiB2b2lkXG4gIG5vdGlmeShtZXRob2Q6IHN0cmluZywgcGFyYW1zOiB7IFtrZXk6IHN0cmluZ106IGFueSB9KTogdm9pZFxuICBub3RpZnkobWV0aG9kOiBzdHJpbmcsIHBhcmFtcz86IGFueSk6IHZvaWQge1xuICAgIGlmICh0eXBlb2YgcGFyYW1zICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgcGFyYW1zICE9PSAnb2JqZWN0Jykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDbGllbnQjbm90aWZ5IFBhcmFtcyBtdXN0IGJlIHN0cnVjdHVyZWQgZGF0YSAoQXJyYXkgfCBPYmplY3QpIGdvdCAke0pTT04uc3RyaW5naWZ5KHBhcmFtcyl9YClcbiAgICB9XG5cbiAgICB0aGlzLl9zZW5kKHsgbWV0aG9kLCBwYXJhbXMsIGpzb25ycGM6ICcyLjAnIH0pXG4gIH1cblxuICBwcm90ZWN0ZWQgZGlkQ29ubmVjdCgpIHtcbiAgICBpZiAodGhpcy5fY29ubmVjdGVkID09PSBmYWxzZSkge1xuICAgICAgdGhpcy5fY29ubmVjdGVkID0gdHJ1ZVxuICAgICAgdGhpcy5fc2VuZFF1ZXVlZFJlcXVlc3RzKClcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9zZW5kKG1lc3NhZ2U6IEpzb25ScGMyLklOb3RpZmljYXRpb24gfCBKc29uUnBjMi5JUmVxdWVzdCkge1xuICAgIGlmICh0aGlzLnNlbmRFbmNvZGluZyA9PT0gJ21zZ3BhY2snKSB7XG4gICAgICB0aGlzLl9yZXF1ZXN0UXVldWUucHVzaChlbmNvZGUobWVzc2FnZSwgeyBjb2RlYyB9KSlcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fcmVxdWVzdFF1ZXVlLnB1c2goSlNPTi5zdHJpbmdpZnkobWVzc2FnZSkpXG4gICAgfVxuICAgIHRoaXMuX3NlbmRRdWV1ZWRSZXF1ZXN0cygpXG4gIH1cblxuICBwcml2YXRlIF9zZW5kUXVldWVkUmVxdWVzdHMoKSB7XG4gICAgaWYgKHRoaXMuX2Nvbm5lY3RlZCkge1xuICAgICAgY29uc3QgcXVldWUgPSB0aGlzLl9yZXF1ZXN0UXVldWUuc3BsaWNlKDAsIHRoaXMuX3JlcXVlc3RRdWV1ZS5sZW5ndGgpXG4gICAgICBmb3IgKGxldCBtZXNzYWdlU3RyIG9mIHF1ZXVlKSB7XG4gICAgICAgIHRoaXMuX2xvZ01lc3NhZ2UobWVzc2FnZVN0ciwgJ3NlbmQnKVxuICAgICAgICB0aGlzLnNlbmRNZXNzYWdlKG1lc3NhZ2VTdHIpXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfbG9nTWVzc2FnZShtZXNzYWdlOiBzdHJpbmcgfCBCdWZmZXIsIGRpcmVjdGlvbjogJ3NlbmQnIHwgJ3JlY2VpdmUnKSB7XG4gICAgaWYgKHRoaXMuX2NvbnNvbGVMb2cpIHtcbiAgICAgIGNvbnNvbGUubG9nKGBDbGllbnQgJHtkaXJlY3Rpb24gPT09ICdzZW5kJyA/ICc+JyA6ICc8J31gLCBtZXNzYWdlLnRvU3RyaW5nKCkpXG4gICAgfVxuICB9XG59XG4iXX0=