import { createCodec, encode, decode } from 'msgpack-lite';
import { EventDispatcher } from '../core/EventDispatcher';
import { isPromiseLike } from '../core/isPromiseLike';
const codec = createCodec();
const errorColumns = { name: 1, message: 1, stack: 1, columnNumber: 1, fileName: 1, lineNumber: 1 };
function sanitizeError(error) {
    if (error instanceof Error) {
        const ret = Object.assign({}, error);
        for (let i in errorColumns) {
            ret[i] = error[i];
        }
        return ret;
    }
    else {
        return error;
    }
}
export class Server extends EventDispatcher {
    constructor(opts = {}) {
        super();
        this.sendEncoding = 'JSON';
        this._exposedMethodsMap = new Map();
        this._consoleLog = false;
        this._isEnabled = false;
        this.setLogging(opts);
    }
    get isEnabled() {
        return this._isEnabled;
    }
    on(method, callback, once) {
        return super.on(method, callback, once);
    }
    once(method, callback) {
        return super.once(method, callback);
    }
    setLogging({ logConsole } = {}) {
        this._consoleLog = !!logConsole;
    }
    expose(method, handler) {
        this._exposedMethodsMap.set(method, handler);
    }
    notify(method, params) {
        if (typeof params !== 'undefined' && typeof params !== 'object') {
            throw new Error(`Server#notify Params must be structured data (Array | Object) got ${JSON.stringify(params)}`);
        }
        const clients = this.getAllClients();
        if (clients) {
            for (let client of clients) {
                this._send(client, { method, params, jsonrpc: '2.0' });
            }
        }
        else {
            throw new Error('Server does not support broadcasting. No "getAllClients: ClientType[]" returned null');
        }
    }
    enable() {
        if (!this._isEnabled) {
            this._isEnabled = true;
            this.notify('RPC.Enabled');
        }
    }
    disable() {
        if (this._isEnabled) {
            this._isEnabled = false;
        }
    }
    processMessage(from, messageStr) {
        this._logMessage(messageStr, 'receive');
        let request;
        try {
            if (typeof messageStr === 'string' && messageStr.charAt(0) === '{') {
                request = JSON.parse(messageStr);
            }
            else if (typeof messageStr === 'string' || messageStr instanceof Uint8Array || messageStr instanceof Array) {
                request = decode(messageStr, { codec });
                this.sendEncoding = 'msgpack';
            }
            else {
                throw new Error(`Unable to parse message ${JSON.stringify(messageStr)}`);
            }
        }
        catch (e) {
            return this._sendError(from, null, -32700, e);
        }
        if (request && request.method && typeof request.method === 'string') {
            if (request.id && typeof request.id === 'number') {
                const handler = this._exposedMethodsMap.get(request.method);
                if (handler) {
                    if (request.params && typeof request.params !== 'object') {
                        this._sendError(from, request, 32602, new Error('params is not an Array or Object'));
                    }
                    else {
                        try {
                            const result = request.params instanceof Array
                                ? handler.apply(this, request.params)
                                : handler.call(this, request.params);
                            if (isPromiseLike(result)) {
                                result
                                    .then((actualResult) => {
                                    this._send(from, {
                                        jsonrpc: '2.0',
                                        id: request.id,
                                        result: typeof actualResult === 'undefined' ? null : actualResult
                                    });
                                })
                                    .catch((error) => {
                                    this._sendError(from, request, -32603, error);
                                });
                            }
                            else {
                                this._send(from, {
                                    jsonrpc: '2.0',
                                    id: request.id,
                                    result: typeof result === 'undefined' ? null : result
                                });
                            }
                        }
                        catch (error) {
                            this._sendError(from, request, -32603, error);
                        }
                    }
                }
                else {
                    this._sendError(from, request, -32601);
                }
            }
            else {
                this.emit(request.method, request.params);
            }
        }
        else {
            this._sendError(from, request, -32600);
        }
    }
    _logMessage(messageStr, direction) {
        if (this._consoleLog) {
            const msg = typeof messageStr === 'object' && (messageStr instanceof Array || messageStr instanceof Uint8Array)
                ? Array.from(messageStr)
                    .map($ => String.fromCharCode($))
                    .join('')
                : messageStr.toString();
            console.log(`${direction === 'send' ? 'Server > Client' : 'Server < Client'}`, msg, typeof messageStr);
        }
    }
    _send(receiver, message) {
        let messageStr;
        if (this.sendEncoding === 'msgpack') {
            messageStr = encode(message, { codec });
        }
        else {
            messageStr = JSON.stringify(message);
        }
        this._logMessage(messageStr, 'send');
        this.sendMessage(receiver, messageStr);
    }
    _sendError(receiver, request, errorCode, error) {
        try {
            this._send(receiver, {
                jsonrpc: '2.0',
                id: (request && request.id) || -1,
                error: this._errorFromCode(errorCode, sanitizeError(error), request && request.method)
            });
        }
        catch (error) {
        }
    }
    _errorFromCode(code, data = null, method = null) {
        let message = '';
        switch (code) {
            case -32603:
                message = `InternalError: Internal Error when calling '${method}'`;
                break;
            case -32601:
                message = `MethodNotFound: '${method}' wasn't found`;
                break;
            case -32600:
                message = 'InvalidRequest: JSON sent is not a valid request object';
                break;
            case -32700:
                message = 'ParseError: invalid JSON received';
                break;
        }
        return { code, message, data };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbW1vbi9qc29uLXJwYy9TZXJ2ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sY0FBYyxDQUFBO0FBSTFELE9BQU8sRUFBRSxlQUFlLEVBQTBCLE1BQU0seUJBQXlCLENBQUE7QUFDakYsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHVCQUF1QixDQUFBO0FBRXJELE1BQU0sS0FBSyxHQUFHLFdBQVcsRUFBRSxDQUFBO0FBRTNCLE1BQU0sWUFBWSxHQUFHLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsWUFBWSxFQUFFLENBQUMsRUFBRSxRQUFRLEVBQUUsQ0FBQyxFQUFFLFVBQVUsRUFBRSxDQUFDLEVBQUUsQ0FBQTtBQUVuRyx1QkFBdUIsS0FBVTtJQUMvQixJQUFJLEtBQUssWUFBWSxLQUFLLEVBQUU7UUFDMUIsTUFBTSxHQUFHLEdBQVEsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUE7UUFFekMsS0FBSyxJQUFJLENBQUMsSUFBSSxZQUFZLEVBQUU7WUFDMUIsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFJLEtBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQTtTQUMzQjtRQUVELE9BQU8sR0FBRyxDQUFBO0tBQ1g7U0FBTTtRQUNMLE9BQU8sS0FBSyxDQUFBO0tBQ2I7QUFDSCxDQUFDO0FBTUQsTUFBTSxhQUF5QyxTQUFRLGVBQWU7SUFXcEUsWUFBWSxPQUE2QixFQUFFO1FBQ3pDLEtBQUssRUFBRSxDQUFBO1FBWFQsaUJBQVksR0FBdUIsTUFBTSxDQUFBO1FBRWpDLHVCQUFrQixHQUE2RCxJQUFJLEdBQUcsRUFBRSxDQUFBO1FBQ3hGLGdCQUFXLEdBQVksS0FBSyxDQUFBO1FB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Q3ZGLENBQUMsQ0FBQTtTQUNIO1FBQUMsT0FBTyxLQUFLLEVBQUU7U0FFZjtJQUNILENBQUM7SUFFTyxjQUFjLENBQUMsSUFBd0IsRUFBRSxPQUFZLElBQUksRUFBRSxTQUF3QixJQUFJO1FBQzdGLElBQUksT0FBTyxHQUFHLEVBQUUsQ0FBQTtRQUVoQixRQUFRLElBQUksRUFBRTtZQUNaO2dCQUNFLE9BQU8sR0FBRywrQ0FBK0MsTUFBTSxHQUFHLENBQUE7Z0JBQ2xFLE1BQUs7WUFDUDtnQkFDRSxPQUFPLEdBQUcsb0JBQW9CLE1BQU0sZ0JBQWdCLENBQUE7Z0JBQ3BELE1BQUs7WUFDUDtnQkFDRSxPQUFPLEdBQUcseURBQXlELENBQUE7Z0JBQ25FLE1BQUs7WUFDUDtnQkFDRSxPQUFPLEdBQUcsbUNBQW1DLENBQUE7Z0JBQzdDLE1BQUs7U0FDUjtRQUVELE9BQU8sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFBO0lBQ2hDLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNyZWF0ZUNvZGVjLCBlbmNvZGUsIGRlY29kZSB9IGZyb20gJ21zZ3BhY2stbGl0ZSdcblxuaW1wb3J0ICogYXMgSnNvblJwYzIgZnJvbSAnLi90eXBlcydcblxuaW1wb3J0IHsgRXZlbnREaXNwYXRjaGVyLCBFdmVudERpc3BhdGNoZXJCaW5kaW5nIH0gZnJvbSAnLi4vY29yZS9FdmVudERpc3BhdGNoZXInXG5pbXBvcnQgeyBpc1Byb21pc2VMaWtlIH0gZnJvbSAnLi4vY29yZS9pc1Byb21pc2VMaWtlJ1xuXG5jb25zdCBjb2RlYyA9IGNyZWF0ZUNvZGVjKClcblxuY29uc3QgZXJyb3JDb2x1bW5zID0geyBuYW1lOiAxLCBtZXNzYWdlOiAxLCBzdGFjazogMSwgY29sdW1uTnVtYmVyOiAxLCBmaWxlTmFtZTogMSwgbGluZU51bWJlcjogMSB9XG5cbmZ1bmN0aW9uIHNhbml0aXplRXJyb3IoZXJyb3I6IGFueSkge1xuICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgIGNvbnN0IHJldDogYW55ID0gT2JqZWN0LmFzc2lnbih7fSwgZXJyb3IpXG5cbiAgICBmb3IgKGxldCBpIGluIGVycm9yQ29sdW1ucykge1xuICAgICAgcmV0W2ldID0gKGVycm9yIGFzIGFueSlbaV1cbiAgICB9XG5cbiAgICByZXR1cm4gcmV0XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGVycm9yXG4gIH1cbn1cblxuLyoqXG4gKiBDcmVhdGVzIGEgUlBDIFNlcnZlci5cbiAqIEl0IGlzIGludGVudGlvbmFsIHRoYXQgU2VydmVyIGRvZXMgbm90IGNyZWF0ZSBhIFdvcmtlciBvYmplY3Qgc2luY2Ugd2UgcHJlZmVyIGNvbXBvc2FiaWxpdHlcbiAqL1xuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFNlcnZlcjxDbGllbnRUeXBlID0gYW55PiBleHRlbmRzIEV2ZW50RGlzcGF0Y2hlciBpbXBsZW1lbnRzIEpzb25ScGMyLklTZXJ2ZXIge1xuICBzZW5kRW5jb2Rpbmc6ICdKU09OJyB8ICdtc2dwYWNrJyA9ICdKU09OJ1xuXG4gIHByaXZhdGUgX2V4cG9zZWRNZXRob2RzTWFwOiBNYXA8c3RyaW5nLCAocGFyYW1zOiBhbnkpID0+IEpzb25ScGMyLlByb21pc2VPck5vdDxhbnk+PiA9IG5ldyBNYXAoKVxuICBwcml2YXRlIF9jb25zb2xlTG9nOiBib29sZWFuID0gZmFsc2VcbiAgcHJpdmF0ZSBfaXNFbmFibGVkID0gZmFsc2VcblxuICBnZXQgaXNFbmFibGVkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLl9pc0VuYWJsZWRcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKG9wdHM6IEpzb25ScGMyLklTZXJ2ZXJPcHRzID0ge30pIHtcbiAgICBzdXBlcigpXG4gICAgdGhpcy5zZXRMb2dnaW5nKG9wdHMpXG4gIH1cblxuICBhYnN0cmFjdCBzZW5kTWVzc2FnZSh0bzogQ2xpZW50VHlwZSwgbWVzc2FnZTogc3RyaW5nIHwgQnVmZmVyKTogdm9pZFxuICBhYnN0cmFjdCBnZXRBbGxDbGllbnRzKCk6IEl0ZXJhYmxlPENsaWVudFR5cGU+XG5cbiAgb24obWV0aG9kOiAnZXJyb3InLCBjYWxsYmFjazogKGVycm9yOiBhbnkpID0+IHZvaWQsIG9uY2U/OiBib29sZWFuKTogRXZlbnREaXNwYXRjaGVyQmluZGluZ1xuICBvbihtZXRob2Q6IHN0cmluZywgY2FsbGJhY2s6IChwYXJhbXM6IGFueSwgc2VuZGVyOiBDbGllbnRUeXBlKSA9PiB2b2lkLCBvbmNlPzogYm9vbGVhbik6IEV2ZW50RGlzcGF0Y2hlckJpbmRpbmdcbiAgb24obWV0aG9kOiBzdHJpbmcsIGNhbGxiYWNrOiAocGFyYW1zOiBhbnksIHNlbmRlcjogQ2xpZW50VHlwZSkgPT4gdm9pZCwgb25jZT86IGJvb2xlYW4pOiBFdmVudERpc3BhdGNoZXJCaW5kaW5nIHtcbiAgICByZXR1cm4gc3VwZXIub24obWV0aG9kLCBjYWxsYmFjaywgb25jZSlcbiAgfVxuXG4gIG9uY2UobWV0aG9kOiAnZXJyb3InLCBjYWxsYmFjazogKGVycm9yOiBhbnkpID0+IHZvaWQpOiBFdmVudERpc3BhdGNoZXJCaW5kaW5nXG4gIG9uY2UobWV0aG9kOiBzdHJpbmcsIGNhbGxiYWNrOiAocGFyYW1zOiBhbnksIHNlbmRlcjogQ2xpZW50VHlwZSkgPT4gdm9pZCk6IEV2ZW50RGlzcGF0Y2hlckJpbmRpbmdcbiAgb25jZShtZXRob2Q6IHN0cmluZywgY2FsbGJhY2s6IChwYXJhbXM6IGFueSwgc2VuZGVyOiBDbGllbnRUeXBlKSA9PiB2b2lkKTogRXZlbnREaXNwYXRjaGVyQmluZGluZyB7XG4gICAgcmV0dXJuIHN1cGVyLm9uY2UobWV0aG9kLCBjYWxsYmFjaylcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgbG9nZ2luZyBmb3IgYWxsIHJlY2VpdmVkIGFuZCBzZW50IG1lc3NhZ2VzXG4gICAqL1xuICBwdWJsaWMgc2V0TG9nZ2luZyh7IGxvZ0NvbnNvbGUgfTogSnNvblJwYzIuSUxvZ09wdHMgPSB7fSkge1xuICAgIHRoaXMuX2NvbnNvbGVMb2cgPSAhIWxvZ0NvbnNvbGVcbiAgfVxuXG4gIGV4cG9zZShtZXRob2Q6IHN0cmluZywgaGFuZGxlcjogKC4uLnBhcmFtczogYW55W10pID0+IFByb21pc2U8YW55Pik6IHZvaWQge1xuICAgIHRoaXMuX2V4cG9zZWRNZXRob2RzTWFwLnNldChtZXRob2QsIGhhbmRsZXIpXG4gIH1cblxuICBub3RpZnkobWV0aG9kOiBzdHJpbmcpOiB2b2lkXG4gIG5vdGlmeShtZXRob2Q6IHN0cmluZywgcGFyYW1zOiBzdHJpbmcpOiBuZXZlclxuICBub3RpZnkobWV0aG9kOiBzdHJpbmcsIHBhcmFtczogbnVtYmVyKTogbmV2ZXJcbiAgbm90aWZ5KG1ldGhvZDogc3RyaW5nLCBwYXJhbXM6IGJvb2xlYW4pOiBuZXZlclxuICBub3RpZnkobWV0aG9kOiBzdHJpbmcsIHBhcmFtczogbnVsbCk6IG5ldmVyXG4gIG5vdGlmeTxUPihtZXRob2Q6IHN0cmluZywgcGFyYW1zOiBJdGVyYWJsZTxUPik6IHZvaWRcbiAgbm90aWZ5KG1ldGhvZDogc3RyaW5nLCBwYXJhbXM/OiBPYmplY3QpOiB2b2lkXG4gIG5vdGlmeShtZXRob2Q6IHN0cmluZywgcGFyYW1zPzogYW55KTogdm9pZCB7XG4gICAgaWYgKHR5cGVvZiBwYXJhbXMgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBwYXJhbXMgIT09ICdvYmplY3QnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFNlcnZlciNub3RpZnkgUGFyYW1zIG11c3QgYmUgc3RydWN0dXJlZCBkYXRhIChBcnJheSB8IE9iamVjdCkgZ290ICR7SlNPTi5zdHJpbmdpZnkocGFyYW1zKX1gKVxuICAgIH1cbiAgICAvLyBCcm9hZGNhc3QgbWVzc2FnZSB0byBhbGwgY2xpZW50c1xuICAgIGNvbnN0IGNsaWVudHMgPSB0aGlzLmdldEFsbENsaWVudHMoKVxuXG4gICAgaWYgKGNsaWVudHMpIHtcbiAgICAgIGZvciAobGV0IGNsaWVudCBvZiBjbGllbnRzKSB7XG4gICAgICAgIHRoaXMuX3NlbmQoY2xpZW50LCB7IG1ldGhvZCwgcGFyYW1zLCBqc29ucnBjOiAnMi4wJyB9KVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NlcnZlciBkb2VzIG5vdCBzdXBwb3J0IGJyb2FkY2FzdGluZy4gTm8gXCJnZXRBbGxDbGllbnRzOiBDbGllbnRUeXBlW11cIiByZXR1cm5lZCBudWxsJylcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRXhlY3V0ZSB0aGlzIG1ldGhvZCBhZnRlciBjb25maWd1cmluZyB0aGUgUlBDIG1ldGhvZHMgYW5kIGxpc3RlbmVycy5cbiAgICogSXQgd2lsbCBzZW5kIGFuIGVtcHR5IG5vdGlmaWNhdGlvbiB0byB0aGUgY2xpZW50LCB0aGVuIGl0ICh0aGUgY2xpZW50KSB3aWxsIHNlbmQgYWxsIHRoZSBlbnF1ZXVlZCBtZXNzYWdlcy5cbiAgICovXG4gIHByb3RlY3RlZCBlbmFibGUoKSB7XG4gICAgaWYgKCF0aGlzLl9pc0VuYWJsZWQpIHtcbiAgICAgIHRoaXMuX2lzRW5hYmxlZCA9IHRydWVcbiAgICAgIHRoaXMubm90aWZ5KCdSUEMuRW5hYmxlZCcpXG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIGRpc2FibGUoKSB7XG4gICAgaWYgKHRoaXMuX2lzRW5hYmxlZCkge1xuICAgICAgdGhpcy5faXNFbmFibGVkID0gZmFsc2VcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgcHJvY2Vzc01lc3NhZ2UoZnJvbTogQ2xpZW50VHlwZSwgbWVzc2FnZVN0cjogc3RyaW5nIHwgQnVmZmVyIHwgVWludDhBcnJheSB8IG51bWJlcltdKTogdm9pZCB7XG4gICAgdGhpcy5fbG9nTWVzc2FnZShtZXNzYWdlU3RyLCAncmVjZWl2ZScpXG4gICAgbGV0IHJlcXVlc3Q6IEpzb25ScGMyLklSZXF1ZXN0XG5cbiAgICB0cnkge1xuICAgICAgaWYgKHR5cGVvZiBtZXNzYWdlU3RyID09PSAnc3RyaW5nJyAmJiBtZXNzYWdlU3RyLmNoYXJBdCgwKSA9PT0gJ3snKSB7XG4gICAgICAgIC8vIEVuc3VyZSBKU09OIGlzIG5vdCBtYWxmb3JtZWRcbiAgICAgICAgcmVxdWVzdCA9IEpTT04ucGFyc2UobWVzc2FnZVN0cilcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG1lc3NhZ2VTdHIgPT09ICdzdHJpbmcnIHx8IG1lc3NhZ2VTdHIgaW5zdGFuY2VvZiBVaW50OEFycmF5IHx8IG1lc3NhZ2VTdHIgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICByZXF1ZXN0ID0gZGVjb2RlKG1lc3NhZ2VTdHIgYXMgYW55LCB7IGNvZGVjIH0pXG4gICAgICAgIHRoaXMuc2VuZEVuY29kaW5nID0gJ21zZ3BhY2snXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBwYXJzZSBtZXNzYWdlICR7SlNPTi5zdHJpbmdpZnkobWVzc2FnZVN0cil9YClcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICByZXR1cm4gdGhpcy5fc2VuZEVycm9yKGZyb20sIG51bGwsIEpzb25ScGMyLkVycm9yQ29kZS5QYXJzZUVycm9yLCBlKVxuICAgIH1cblxuICAgIC8vIEVuc3VyZSBtZXRob2QgaXMgYXRsZWFzdCBkZWZpbmVkXG4gICAgaWYgKHJlcXVlc3QgJiYgcmVxdWVzdC5tZXRob2QgJiYgdHlwZW9mIChyZXF1ZXN0Lm1ldGhvZCBhcyBhbnkpID09PSAnc3RyaW5nJykge1xuICAgICAgaWYgKHJlcXVlc3QuaWQgJiYgdHlwZW9mIChyZXF1ZXN0LmlkIGFzIGFueSkgPT09ICdudW1iZXInKSB7XG4gICAgICAgIGNvbnN0IGhhbmRsZXIgPSB0aGlzLl9leHBvc2VkTWV0aG9kc01hcC5nZXQocmVxdWVzdC5tZXRob2QpXG4gICAgICAgIC8vIEhhbmRsZXIgaXMgZGVmaW5lZCBzbyBsZXRzIGNhbGwgaXRcbiAgICAgICAgaWYgKGhhbmRsZXIpIHtcbiAgICAgICAgICBpZiAocmVxdWVzdC5wYXJhbXMgJiYgdHlwZW9mIHJlcXVlc3QucGFyYW1zICE9PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgdGhpcy5fc2VuZEVycm9yKFxuICAgICAgICAgICAgICBmcm9tLFxuICAgICAgICAgICAgICByZXF1ZXN0LFxuICAgICAgICAgICAgICBKc29uUnBjMi5FcnJvckNvZGUuSW52YWxpZFBhcmFtcyxcbiAgICAgICAgICAgICAgbmV3IEVycm9yKCdwYXJhbXMgaXMgbm90IGFuIEFycmF5IG9yIE9iamVjdCcpXG4gICAgICAgICAgICApXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgIGNvbnN0IHJlc3VsdDogSnNvblJwYzIuUHJvbWlzZU9yTm90PGFueT4gPVxuICAgICAgICAgICAgICAgIHJlcXVlc3QucGFyYW1zIGluc3RhbmNlb2YgQXJyYXlcbiAgICAgICAgICAgICAgICAgID8gaGFuZGxlci5hcHBseSh0aGlzLCByZXF1ZXN0LnBhcmFtcylcbiAgICAgICAgICAgICAgICAgIDogaGFuZGxlci5jYWxsKHRoaXMsIHJlcXVlc3QucGFyYW1zKVxuXG4gICAgICAgICAgICAgIGlmIChpc1Byb21pc2VMaWtlKHJlc3VsdCkpIHtcbiAgICAgICAgICAgICAgICAvLyBSZXN1bHQgaXMgYSBwcm9taXNlLCBzbyBsZXRzIHdhaXQgZm9yIHRoZSByZXN1bHQgYW5kIGhhbmRsZSBhY2NvcmRpbmdseVxuICAgICAgICAgICAgICAgIHJlc3VsdFxuICAgICAgICAgICAgICAgICAgLnRoZW4oKGFjdHVhbFJlc3VsdDogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3NlbmQoZnJvbSwge1xuICAgICAgICAgICAgICAgICAgICAgIGpzb25ycGM6ICcyLjAnLFxuICAgICAgICAgICAgICAgICAgICAgIGlkOiByZXF1ZXN0LmlkLFxuICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDogdHlwZW9mIGFjdHVhbFJlc3VsdCA9PT0gJ3VuZGVmaW5lZCcgPyBudWxsIDogYWN0dWFsUmVzdWx0XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgLmNhdGNoKChlcnJvcjogRXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2VuZEVycm9yKGZyb20sIHJlcXVlc3QsIEpzb25ScGMyLkVycm9yQ29kZS5JbnRlcm5hbEVycm9yLCBlcnJvcilcbiAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gUmVzdWx0IGlzIG5vdCBhIHByb21pc2Ugc28gc2VuZCBpbW1lZGlhdGVseVxuICAgICAgICAgICAgICAgIHRoaXMuX3NlbmQoZnJvbSwge1xuICAgICAgICAgICAgICAgICAganNvbnJwYzogJzIuMCcsXG4gICAgICAgICAgICAgICAgICBpZDogcmVxdWVzdC5pZCxcbiAgICAgICAgICAgICAgICAgIHJlc3VsdDogdHlwZW9mIHJlc3VsdCA9PT0gJ3VuZGVmaW5lZCcgPyBudWxsIDogcmVzdWx0XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgdGhpcy5fc2VuZEVycm9yKGZyb20sIHJlcXVlc3QsIEpzb25ScGMyLkVycm9yQ29kZS5JbnRlcm5hbEVycm9yLCBlcnJvcilcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5fc2VuZEVycm9yKGZyb20sIHJlcXVlc3QsIEpzb25ScGMyLkVycm9yQ29kZS5NZXRob2ROb3RGb3VuZClcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gTWVzc2FnZSBpcyBhIG5vdGlmaWNhdGlvbiwgc28ganVzdCBlbWl0XG4gICAgICAgIHRoaXMuZW1pdChyZXF1ZXN0Lm1ldGhvZCwgcmVxdWVzdC5wYXJhbXMpXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIE5vIG1ldGhvZCBwcm9wZXJ0eSwgc2VuZCBJbnZhbGlkUmVxdWVzdCBlcnJvclxuICAgICAgdGhpcy5fc2VuZEVycm9yKGZyb20sIHJlcXVlc3QsIEpzb25ScGMyLkVycm9yQ29kZS5JbnZhbGlkUmVxdWVzdClcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9sb2dNZXNzYWdlKG1lc3NhZ2VTdHI6IHN0cmluZyB8IEJ1ZmZlciB8IFVpbnQ4QXJyYXkgfCBudW1iZXJbXSwgZGlyZWN0aW9uOiAnc2VuZCcgfCAncmVjZWl2ZScpIHtcbiAgICBpZiAodGhpcy5fY29uc29sZUxvZykge1xuICAgICAgY29uc3QgbXNnID1cbiAgICAgICAgdHlwZW9mIG1lc3NhZ2VTdHIgPT09ICdvYmplY3QnICYmIChtZXNzYWdlU3RyIGluc3RhbmNlb2YgQXJyYXkgfHwgbWVzc2FnZVN0ciBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpXG4gICAgICAgICAgPyBBcnJheS5mcm9tKG1lc3NhZ2VTdHIpXG4gICAgICAgICAgICAgIC5tYXAoJCA9PiBTdHJpbmcuZnJvbUNoYXJDb2RlKCQpKVxuICAgICAgICAgICAgICAuam9pbignJylcbiAgICAgICAgICA6IG1lc3NhZ2VTdHIudG9TdHJpbmcoKVxuXG4gICAgICBjb25zb2xlLmxvZyhgJHtkaXJlY3Rpb24gPT09ICdzZW5kJyA/ICdTZXJ2ZXIgPiBDbGllbnQnIDogJ1NlcnZlciA8IENsaWVudCd9YCwgbXNnLCB0eXBlb2YgbWVzc2FnZVN0cilcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9zZW5kKHJlY2VpdmVyOiBDbGllbnRUeXBlLCBtZXNzYWdlOiBKc29uUnBjMi5JUmVzcG9uc2UgfCBKc29uUnBjMi5JTm90aWZpY2F0aW9uKSB7XG4gICAgbGV0IG1lc3NhZ2VTdHI6IHN0cmluZyB8IEJ1ZmZlclxuXG4gICAgaWYgKHRoaXMuc2VuZEVuY29kaW5nID09PSAnbXNncGFjaycpIHtcbiAgICAgIG1lc3NhZ2VTdHIgPSBlbmNvZGUobWVzc2FnZSwgeyBjb2RlYyB9KVxuICAgIH0gZWxzZSB7XG4gICAgICBtZXNzYWdlU3RyID0gSlNPTi5zdHJpbmdpZnkobWVzc2FnZSlcbiAgICB9XG5cbiAgICB0aGlzLl9sb2dNZXNzYWdlKG1lc3NhZ2VTdHIsICdzZW5kJylcbiAgICB0aGlzLnNlbmRNZXNzYWdlKHJlY2VpdmVyLCBtZXNzYWdlU3RyKVxuICB9XG5cbiAgcHJpdmF0ZSBfc2VuZEVycm9yKFxuICAgIHJlY2VpdmVyOiBDbGllbnRUeXBlLFxuICAgIHJlcXVlc3Q6IEpzb25ScGMyLklSZXF1ZXN0IHwgbnVsbCxcbiAgICBlcnJvckNvZGU6IEpzb25ScGMyLkVycm9yQ29kZSxcbiAgICBlcnJvcj86IEVycm9yXG4gICkge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLl9zZW5kKHJlY2VpdmVyLCB7XG4gICAgICAgIGpzb25ycGM6ICcyLjAnLFxuICAgICAgICBpZDogKHJlcXVlc3QgJiYgcmVxdWVzdC5pZCkgfHwgLTEsXG4gICAgICAgIGVycm9yOiB0aGlzLl9lcnJvckZyb21Db2RlKGVycm9yQ29kZSwgc2FuaXRpemVFcnJvcihlcnJvciksIHJlcXVlc3QgJiYgcmVxdWVzdC5tZXRob2QpXG4gICAgICB9KVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAvLyBTaW5jZSB3ZSBjYW4ndCBldmVuIHNlbmQgZXJyb3JzLCBkbyBub3RoaW5nLiBUaGUgY29ubmVjdGlvbiB3YXMgcHJvYmFibHkgY2xvc2VkLlxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX2Vycm9yRnJvbUNvZGUoY29kZTogSnNvblJwYzIuRXJyb3JDb2RlLCBkYXRhOiBhbnkgPSBudWxsLCBtZXRob2Q6IHN0cmluZyB8IG51bGwgPSBudWxsKTogSnNvblJwYzIuSUVycm9yIHtcbiAgICBsZXQgbWVzc2FnZSA9ICcnXG5cbiAgICBzd2l0Y2ggKGNvZGUpIHtcbiAgICAgIGNhc2UgSnNvblJwYzIuRXJyb3JDb2RlLkludGVybmFsRXJyb3I6XG4gICAgICAgIG1lc3NhZ2UgPSBgSW50ZXJuYWxFcnJvcjogSW50ZXJuYWwgRXJyb3Igd2hlbiBjYWxsaW5nICcke21ldGhvZH0nYFxuICAgICAgICBicmVha1xuICAgICAgY2FzZSBKc29uUnBjMi5FcnJvckNvZGUuTWV0aG9kTm90Rm91bmQ6XG4gICAgICAgIG1lc3NhZ2UgPSBgTWV0aG9kTm90Rm91bmQ6ICcke21ldGhvZH0nIHdhc24ndCBmb3VuZGBcbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2UgSnNvblJwYzIuRXJyb3JDb2RlLkludmFsaWRSZXF1ZXN0OlxuICAgICAgICBtZXNzYWdlID0gJ0ludmFsaWRSZXF1ZXN0OiBKU09OIHNlbnQgaXMgbm90IGEgdmFsaWQgcmVxdWVzdCBvYmplY3QnXG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlIEpzb25ScGMyLkVycm9yQ29kZS5QYXJzZUVycm9yOlxuICAgICAgICBtZXNzYWdlID0gJ1BhcnNlRXJyb3I6IGludmFsaWQgSlNPTiByZWNlaXZlZCdcbiAgICAgICAgYnJlYWtcbiAgICB9XG5cbiAgICByZXR1cm4geyBjb2RlLCBtZXNzYWdlLCBkYXRhIH1cbiAgfVxufVxuIl19