import { TransportBasedServer } from './TransportBasedServer';
const hasSymbol = typeof Symbol === 'function' && Symbol.for;
const apiNameSymbol = hasSymbol ? Symbol('pluginName') : 0xfea2;
const registeredAPIs = {};
var PrivateHelpers;
(function (PrivateHelpers) {
    function _registerAPI(apiName, api) {
        if (apiNameSymbol in api) {
            throw new Error(`The API you are trying to register is already registered`);
        }
        if (apiName in registeredAPIs) {
            throw new Error(`The API ${apiName} is already registered`);
        }
        if (typeof api !== 'function') {
            throw new Error(`The API ${apiName} is not a class, it is of type ${typeof api}`);
        }
        ;
        api[apiNameSymbol] = apiName;
        registeredAPIs[apiName] = api;
    }
    PrivateHelpers._registerAPI = _registerAPI;
    function unmountAPI(api) {
        if (api.apiWillUnmount) {
            const promise = api.apiWillUnmount();
            if (promise && 'catch' in promise) {
                promise.catch(error => console.error('Error unmounting API', { api, error }));
            }
        }
    }
    PrivateHelpers.unmountAPI = unmountAPI;
    function mountAPI(api) {
        if (api.apiDidMount) {
            const promise = api.apiDidMount();
            if (promise && 'catch' in promise) {
                promise.catch(error => console.error('Error mounting API', { api, error }));
            }
        }
    }
    PrivateHelpers.mountAPI = mountAPI;
})(PrivateHelpers || (PrivateHelpers = {}));
export var ScriptingHostEvents;
(function (ScriptingHostEvents) {
    ScriptingHostEvents["systemWillUnmount"] = "systemWillUnmount";
    ScriptingHostEvents["systemWillEnable"] = "systemWillEnable";
    ScriptingHostEvents["systemDidUnmount"] = "systemDidUnmount";
})(ScriptingHostEvents || (ScriptingHostEvents = {}));
export function getAPIName(klass) {
    return klass[apiNameSymbol] || null;
}
export function registerAPI(apiName) {
    return function (api) {
        PrivateHelpers._registerAPI(apiName, api);
    };
}
export class ScriptingHost extends TransportBasedServer {
    constructor(worker) {
        super(worker);
        this.unmounted = false;
        this.apiInstances = new Map();
        this.expose('LoadComponents', this.RPCLoadAPIs.bind(this));
    }
    static async fromTransport(transport) {
        return new ScriptingHost(transport);
    }
    enable() {
        this.emit(ScriptingHostEvents.systemWillEnable);
        this.apiInstances.forEach(PrivateHelpers.mountAPI);
        super.enable();
    }
    getAPIInstance(api) {
        if (typeof api === 'string') {
            if (this.apiInstances.has(api)) {
                return this.apiInstances.get(api);
            }
            if (api in registeredAPIs) {
                return this.initializeAPI(registeredAPIs[api]);
            }
            return null;
        }
        else if (typeof api === 'function') {
            const apiName = getAPIName(api);
            if (apiName !== null) {
                if (this.apiInstances.has(apiName)) {
                    return this.apiInstances.get(apiName);
                }
                return this.initializeAPI(api);
            }
        }
        throw Object.assign(new Error('Cannot get instance of the specified component'), { api });
    }
    unmount() {
        if (this.unmounted)
            return;
        this.notify('SIGKILL');
        this.emit(ScriptingHostEvents.systemWillUnmount);
        try {
            this.apiInstances.forEach(PrivateHelpers.unmountAPI);
            this.apiInstances.clear();
        }
        catch (e) {
            this.emit('error', e);
        }
        this.transport.close();
        this.emit(ScriptingHostEvents.systemDidUnmount);
        this.unmounted = true;
    }
    initializeAPI(ctor) {
        const apiName = getAPIName(ctor);
        if (apiName === null) {
            throw new Error('The plugin is not registered');
        }
        if (this.apiInstances.has(apiName)) {
            return this.apiInstances.get(apiName);
        }
        const apiOptions = {
            apiName,
            on: (event, handler) => this.on(`${apiName}.${event}`, handler),
            notify: (event, params) => this.notify(`${apiName}.${event}`, params),
            expose: (event, handler) => this.expose(`${apiName}.${event}`, handler),
            getAPIInstance: (name) => {
                return this.getAPIInstance(name);
            },
            system: this
        };
        const instance = ctor.factory ? ctor.factory(ctor, apiOptions) : new ctor(apiOptions);
        this.apiInstances.set(apiName, instance);
        return instance;
    }
    async RPCLoadAPIs(apiNames) {
        if (typeof apiNames !== 'object' || !(apiNames instanceof Array)) {
            throw new TypeError('RPCLoadComponents(names) name must be an array of strings');
        }
        const notFound = apiNames
            .map(name => ({ api: this.getAPIInstance(name), name }))
            .filter($ => $.api === null)
            .map($ => $.name);
        if (notFound.length) {
            const message = `Components not found ${notFound.join(',')}`;
            throw new TypeError(message);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2NyaXB0aW5nSG9zdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ob3N0L1NjcmlwdGluZ0hvc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sd0JBQXdCLENBQUE7QUFPN0QsTUFBTSxTQUFTLEdBQUcsT0FBTyxNQUFNLEtBQUssVUFBVSxJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUE7QUFFNUQsTUFBTSxhQUFhLEdBQVEsU0FBUyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQTtBQUVwRSxNQUFNLGNBQWMsR0FBOEIsRUFBRSxDQUFBO0FBRXBELElBQVUsY0FBYyxDQXNDdkI7QUF0Q0QsV0FBVSxjQUFjO0lBQ3RCLHNCQUE2QixPQUFlLEVBQUUsR0FBa0I7UUFDOUQsSUFBSSxhQUFhLElBQUksR0FBRyxFQUFFO1lBQ3hCLE1BQU0sSUFBSSxLQUFLLENBQUMsMERBQTBELENBQUMsQ0FBQTtTQUM1RTtRQUVELElBQUksT0FBTyxJQUFJLGNBQWMsRUFBRTtZQUM3QixNQUFNLElBQUksS0FBSyxDQUFDLFdBQVcsT0FBTyx3QkFBd0IsQ0FBQyxDQUFBO1NBQzVEO1FBRUQsSUFBSSxPQUFRLEdBQVcsS0FBSyxVQUFVLEVBQUU7WUFDdEMsTUFBTSxJQUFJLEtBQUssQ0FBQyxXQUFXLE9BQU8sa0NBQWtDLE9BQU8sR0FBRyxFQUFFLENBQUMsQ0FBQTtTQUNsRjtRQUlELENBQUM7UUFBQyxHQUFXLENBQUMsYUFBYSxDQUFDLEdBQUcsT0FBTyxDQUFBO1FBRXRDLGNBQWMsQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLENBQUE7SUFDL0IsQ0FBQztJQWxCZSwyQkFBWSxlQWtCM0IsQ0FBQTtJQUVELG9CQUEyQixHQUFRO1FBQ2pDLElBQUksR0FBRyxDQUFDLGNBQWMsRUFBRTtZQUN0QixNQUFNLE9BQU8sR0FBRyxHQUFHLENB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LElBQUksQ0FBQyxDQUFDLFFBQVEsWUFBWSxLQUFLLENBQUMsRUFBRTtZQUNoRSxNQUFNLElBQUksU0FBUyxDQUFDLDJEQUEyRCxDQUFDLENBQUE7U0FDakY7UUFFRCxNQUFNLFFBQVEsR0FBRyxRQUFRO2FBQ3RCLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO2FBQ3ZELE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssSUFBSSxDQUFDO2FBQzNCLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUVuQixJQUFJLFFBQVEsQ0FBQyxNQUFNLEVBQUU7WUFDbkIsTUFBTSxPQUFPLEdBQUcsd0JBQXdCLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQTtZQUM1RCxNQUFNLElBQUksU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFBO1NBQzdCO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGljdGlvbmFyeSB9IGZyb20gJy4uL2NvbW1vbi9jb3JlL0V2ZW50RGlzcGF0Y2hlcidcbmltcG9ydCB7IFRyYW5zcG9ydEJhc2VkU2VydmVyIH0gZnJvbSAnLi9UcmFuc3BvcnRCYXNlZFNlcnZlcidcbmltcG9ydCB7IEFQSUNsYXNzLCBBUEksIEFQSU9wdGlvbnMgfSBmcm9tICcuL0FQSSdcbmltcG9ydCB7IFNjcmlwdGluZ1RyYW5zcG9ydCB9IGZyb20gJy4uL2NvbW1vbi9qc29uLXJwYy90eXBlcydcblxuLy8gSWYgdGhlcmUgaXMgbm8gbmF0aXZlIFN5bWJvbFxuLy8gbm9yIHBvbHlmaWxsLCB0aGVuIGEgcGxhaW4gbnVtYmVyIGlzIHVzZWQgZm9yIHBlcmZvcm1hbmNlLlxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lXG5jb25zdCBoYXNTeW1ib2wgPSB0eXBlb2YgU3ltYm9sID09PSAnZnVuY3Rpb24nICYmIFN5bWJvbC5mb3JcblxuY29uc3QgYXBpTmFtZVN5bWJvbDogYW55ID0gaGFzU3ltYm9sID8gU3ltYm9sKCdwbHVnaW5OYW1lJykgOiAweGZlYTJcblxuY29uc3QgcmVnaXN0ZXJlZEFQSXM6IERpY3Rpb25hcnk8QVBJQ2xhc3M8QVBJPj4gPSB7fVxuXG5uYW1lc3BhY2UgUHJpdmF0ZUhlbHBlcnMge1xuICBleHBvcnQgZnVuY3Rpb24gX3JlZ2lzdGVyQVBJKGFwaU5hbWU6IHN0cmluZywgYXBpOiBBUElDbGFzczxBUEk+KSB7XG4gICAgaWYgKGFwaU5hbWVTeW1ib2wgaW4gYXBpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBBUEkgeW91IGFyZSB0cnlpbmcgdG8gcmVnaXN0ZXIgaXMgYWxyZWFkeSByZWdpc3RlcmVkYClcbiAgICB9XG5cbiAgICBpZiAoYXBpTmFtZSBpbiByZWdpc3RlcmVkQVBJcykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgQVBJICR7YXBpTmFtZX0gaXMgYWxyZWFkeSByZWdpc3RlcmVkYClcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIChhcGkgYXMgYW55KSAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgQVBJICR7YXBpTmFtZX0gaXMgbm90IGEgY2xhc3MsIGl0IGlzIG9mIHR5cGUgJHt0eXBlb2YgYXBpfWApXG4gICAgfVxuXG4gICAgLy8gc2F2ZSB0aGUgcmVnaXN0ZXJlZCBuYW1lXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnNlbWljb2xvblxuICAgIDsoYXBpIGFzIGFueSlbYXBpTmFtZVN5bWJvbF0gPSBhcGlOYW1lXG5cbiAgICByZWdpc3RlcmVkQVBJc1thcGlOYW1lXSA9IGFwaVxuICB9XG5cbiAgZXhwb3J0IGZ1bmN0aW9uIHVubW91bnRBUEkoYXBpOiBBUEkpIHtcbiAgICBpZiAoYXBpLmFwaVdpbGxVbm1vdW50KSB7XG4gICAgICBjb25zdCBwcm9taXNlID0gYXBpLmFwaVdpbGxVbm1vdW50KClcbiAgICAgIGlmIChwcm9taXNlICYmICdjYXRjaCcgaW4gcHJvbWlzZSkge1xuICAgICAgICBwcm9taXNlLmNhdGNoKGVycm9yID0+IGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHVubW91bnRpbmcgQVBJJywgeyBhcGksIGVycm9yIH0pKVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGV4cG9ydCBmdW5jdGlvbiBtb3VudEFQSShhcGk6IEFQSSkge1xuICAgIGlmIChhcGkuYXBpRGlkTW91bnQpIHtcbiAgICAgIGNvbnN0IHByb21pc2UgPSBhcGkuYXBpRGlkTW91bnQoKVxuICAgICAgaWYgKHByb21pc2UgJiYgJ2NhdGNoJyBpbiBwcm9taXNlKSB7XG4gICAgICAgIHByb21pc2UuY2F0Y2goZXJyb3IgPT4gY29uc29sZS5lcnJvcignRXJyb3IgbW91bnRpbmcgQVBJJywgeyBhcGksIGVycm9yIH0pKVxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG4vLyBIRVJFIFdFIFNUQVJUIFRIRSBFWFBPUlRTXG5cbmV4cG9ydCBlbnVtIFNjcmlwdGluZ0hvc3RFdmVudHMge1xuICBzeXN0ZW1XaWxsVW5tb3VudCA9ICdzeXN0ZW1XaWxsVW5tb3VudCcsXG4gIHN5c3RlbVdpbGxFbmFibGUgPSAnc3lzdGVtV2lsbEVuYWJsZScsXG4gIHN5c3RlbURpZFVubW91bnQgPSAnc3lzdGVtRGlkVW5tb3VudCdcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEFQSU5hbWUoa2xhc3M6IEFQSUNsYXNzPEFQST4pOiBzdHJpbmcgfCBudWxsIHtcbiAgcmV0dXJuIChrbGFzcyBhcyBhbnkpW2FwaU5hbWVTeW1ib2xdIHx8IG51bGxcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlZ2lzdGVyQVBJKGFwaU5hbWU6IHN0cmluZyk6IChrbGFzczogQVBJQ2xhc3M8QVBJPikgPT4gdm9pZCB7XG4gIHJldHVybiBmdW5jdGlvbihhcGk6IEFQSUNsYXNzPEFQST4pIHtcbiAgICBQcml2YXRlSGVscGVycy5fcmVnaXN0ZXJBUEkoYXBpTmFtZSwgYXBpKVxuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBTY3JpcHRpbmdIb3N0IGV4dGVuZHMgVHJhbnNwb3J0QmFzZWRTZXJ2ZXIge1xuICB1bm1vdW50ZWQgPSBmYWxzZVxuXG4gIGFwaUluc3RhbmNlczogTWFwPHN0cmluZywgQVBJPiA9IG5ldyBNYXAoKVxuXG4gIHByaXZhdGUgY29uc3RydWN0b3Iod29ya2VyOiBTY3JpcHRpbmdUcmFuc3BvcnQpIHtcbiAgICBzdXBlcih3b3JrZXIpXG5cbiAgICB0aGlzLmV4cG9zZSgnTG9hZENvbXBvbmVudHMnLCB0aGlzLlJQQ0xvYWRBUElzLmJpbmQodGhpcykpXG4gIH1cblxuICBzdGF0aWMgYXN5bmMgZnJvbVRyYW5zcG9ydCh0cmFuc3BvcnQ6IFNjcmlwdGluZ1RyYW5zcG9ydCkge1xuICAgIHJldHVybiBuZXcgU2NyaXB0aW5nSG9zdCh0cmFuc3BvcnQpXG4gIH1cblxuICAvKipcbiAgICogVGhpcyBtZXRoZG9kIHNob3VsZCBiZSBjYWxsZWQgb25seSBmcm9tIHRoZSBpbnRlcmZhY2UgdGhhdCBtYW5hZ2VzIHRoZSBTY3JpcHRpbmdIb3N0cy5cbiAgICogSXQgaW5pdGlhbGl6ZXMgdGhlIHN5c3RlbSBhbmQgaXQncyBxdWV1ZWQgY29tcG9uZW50cy4gSXQgYWxzbyBzZW5kcyBhIGZpcnN0IG5vdGlmaWNhdGlvblxuICAgKiB0byB0aGUgaW1wbGVtZW50YXRpb24gb2YgdGhlIHN5c3RlbSB0ZWxsaW5nIGl0IGlzIG5vdyBlbmFibGVkLiBJbiB0aGF0IG1vbWVudCwgdGhlXG4gICAqIGltcGxlbWVudGF0aW9uIHdpbGwgc2VuZCB0aGUgcXVldWVkIG1lc3NhZ2VzIGFuZCBleGVjdXRlIHRoZSBxdWV1ZWQgbWV0aG9kcyBhZ2FpbnN0IHRoZVxuICAgKiBtYXRlcmlhbGl6ZWQgY29tcG9uZW50cy5cbiAgICpcbiAgICogSXQ6XG4gICAqICAxKSBlbWl0cyBhIENvbXBvbmVudFN5c3RlbUV2ZW50cy5zeXN0ZW1XaWxsRW5hYmxlIGV2ZW50XG4gICAqICAyKSBtb3VudHMgYWxsIHRoZSBjb21wb25lbnRzXG4gICAqICAzKSBzZW5kcyB0aGUgbm90aWZpY2F0aW9uIHRvIHRoZSBhY3R1YWwgc3lzdGVtIGltcGxlbWVudGF0aW9uXG4gICAqL1xuICBlbmFibGUoKSB7XG4gICAgdGhpcy5lbWl0KFNjcmlwdGluZ0hvc3RFdmVudHMuc3lzdGVtV2lsbEVuYWJsZSlcbiAgICB0aGlzLmFwaUluc3RhbmNlcy5mb3JFYWNoKFByaXZhdGVIZWxwZXJzLm1vdW50QVBJKVxuICAgIHN1cGVyLmVuYWJsZSgpXG4gIH1cblxuICAvKipcbiAgICogVGhpcyBpcyBhIHNlcnZpY2UgbG9jYXRvciwgaXQgbG9jYXRlcyBvciBpbnN0YW50aWF0ZSB0aGUgcmVxdWVzdGVkIGNvbXBvbmVudFxuICAgKiBmb3IgdGhpcyBpbnN0YW5jZSBvZiBDb21wb25lbnRTeXN0ZW0uXG4gICAqXG4gICAqIEBwYXJhbSBhcGkgQSBjbGFzcyBjb25zdHJ1Y3RvclxuICAgKi9cbiAgZ2V0QVBJSW5zdGFuY2U8WD4oYXBpOiB7IG5ldyAob3B0aW9uczogQVBJT3B0aW9ucyk6IFggfSk6IFhcblxuICAvKipcbiAgICogVGhpcyBpcyBhIHNlcnZpY2UgbG9jYXRvciwgaXQgbG9jYXRlcyBvciBpbnN0YW50aWF0ZSB0aGUgcmVxdWVzdGVkIGNvbXBvbmVudFxuICAgKiBmb3IgdGhpcyBpbnN0YW5jZSBvZiBDb21wb25lbnRTeXN0ZW0uXG4gICAqXG4gICAqIEBwYXJhbSBuYW1lIFRoZSBuYW1lIG9mIHVzZWQgdG8gcmVnaXN0ZXIgdGhlIGNvbXBvbmVudFxuICAgKi9cbiAgZ2V0QVBJSW5zdGFuY2UobmFtZTogc3RyaW5nKTogQVBJIHwgbnVsbFxuXG4gIGdldEFQSUluc3RhbmNlKGFwaTogYW55KSB7XG4gICAgaWYgKHR5cGVvZiBhcGkgPT09ICdzdHJpbmcnKSB7XG4gICAgICBpZiAodGhpcy5hcGlJbnN0YW5jZXMuaGFzKGFwaSkpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBpSW5zdGFuY2VzLmdldChhcGkpXG4gICAgICB9XG4gICAgICBpZiAoYXBpIGluIHJlZ2lzdGVyZWRBUElzKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmluaXRpYWxpemVBUEkocmVnaXN0ZXJlZEFQSXNbYXBpXSlcbiAgICAgIH1cbiAgICAgIHJldHVybiBudWxsXG4gICAgfSBlbHNlIGlmICh0eXBlb2YgYXBpID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBjb25zdCBhcGlOYW1lID0gZ2V0QVBJTmFtZShhcGkpXG5cbiAgICAgIC8vIGlmIGl0IGhhcyBhIG5hbWUsIHVzZSB0aGF0IGluZGlyZWN0aW9uIHRvIGZpbmQgaW4gdGhlIGluc3RhbmNlJ3MgbWFwXG4gICAgICBpZiAoYXBpTmFtZSAhPT0gbnVsbCkge1xuICAgICAgICBpZiAodGhpcy5hcGlJbnN0YW5jZXMuaGFzKGFwaU5hbWUpKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuYXBpSW5zdGFuY2VzLmdldChhcGlOYW1lKVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gSWYgd2UgZG9uJ3QgaGF2ZSBhIGxvY2FsIGluc3RhbmNlLCBjcmVhdGUgdGhlIGluc3RhbmNlIG9mIHRoZSBjb21wb25lbnRcbiAgICAgICAgcmV0dXJuIHRoaXMuaW5pdGlhbGl6ZUFQSShhcGkpXG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhyb3cgT2JqZWN0LmFzc2lnbihuZXcgRXJyb3IoJ0Nhbm5vdCBnZXQgaW5zdGFuY2Ugb2YgdGhlIHNwZWNpZmllZCBjb21wb25lbnQnKSwgeyBhcGkgfSlcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIG1ldGhvZCB1bm1vdW50cyBhbGwgdGhlIGNvbXBvbmVudHMgYW5kIHJlbGVhc2VzIHRoZSBXb3JrZXJcbiAgICovXG4gIHVubW91bnQoKSB7XG4gICAgaWYgKHRoaXMudW5tb3VudGVkKSByZXR1cm5cbiAgICB0aGlzLm5vdGlmeSgnU0lHS0lMTCcpXG5cbiAgICB0aGlzLmVtaXQoU2NyaXB0aW5nSG9zdEV2ZW50cy5zeXN0ZW1XaWxsVW5tb3VudClcblxuICAgIHRyeSB7XG4gICAgICB0aGlzLmFwaUluc3RhbmNlcy5mb3JFYWNoKFByaXZhdGVIZWxwZXJzLnVubW91bnRBUEkpXG4gICAgICB0aGlzLmFwaUluc3RhbmNlcy5jbGVhcigpXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIGUpXG4gICAgfVxuXG4gICAgdGhpcy50cmFuc3BvcnQuY2xvc2UoKVxuXG4gICAgdGhpcy5lbWl0KFNjcmlwdGluZ0hvc3RFdmVudHMuc3lzdGVtRGlkVW5tb3VudClcblxuICAgIHRoaXMudW5tb3VudGVkID0gdHJ1ZVxuICB9XG5cbiAgcHJvdGVjdGVkIGluaXRpYWxpemVBUEk8WCBleHRlbmRzIEFQST4oY3Rvcjoge1xuICAgIG5ldyAob3B0aW9uczogQVBJT3B0aW9ucyk6IFhcbiAgICBmYWN0b3J5PyhjdG9yOiB7IG5ldyAob3B0aW9uczogQVBJT3B0aW9ucyk6IFggfSwgb3B0aW9uczogQVBJT3B0aW9ucyk6IFhcbiAgfSk6IFgge1xuICAgIGNvbnN0IGFwaU5hbWUgPSBnZXRBUElOYW1lKGN0b3IpXG5cbiAgICBpZiAoYXBpTmFtZSA9PT0gbnVsbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGUgcGx1Z2luIGlzIG5vdCByZWdpc3RlcmVkJylcbiAgICB9XG5cbiAgICBpZiAodGhpcy5hcGlJbnN0YW5jZXMuaGFzKGFwaU5hbWUpKSB7XG4gICAgICByZXR1cm4gdGhpcy5hcGlJbnN0YW5jZXMuZ2V0KGFwaU5hbWUpIGFzIFhcbiAgICB9XG5cbiAgICBjb25zdCBhcGlPcHRpb25zOiBBUElPcHRpb25zID0ge1xuICAgICAgYXBpTmFtZSxcbiAgICAgIG9uOiAoZXZlbnQsIGhhbmRsZXIpID0+IHRoaXMub24oYCR7YXBpTmFtZX0uJHtldmVudH1gLCBoYW5kbGVyKSxcbiAgICAgIG5vdGlmeTogKGV2ZW50LCBwYXJhbXM/KSA9PiB0aGlzLm5vdGlmeShgJHthcGlOYW1lfS4ke2V2ZW50fWAsIHBhcmFtcyksXG4gICAgICBleHBvc2U6IChldmVudCwgaGFuZGxlcikgPT4gdGhpcy5leHBvc2UoYCR7YXBpTmFtZX0uJHtldmVudH1gLCBoYW5kbGVyKSxcbiAgICAgIGdldEFQSUluc3RhbmNlOiAobmFtZTogYW55KSA9PiB7XG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZVxuICAgICAgICByZXR1cm4gdGhpcy5nZXRBUElJbnN0YW5jZShuYW1lKSBhcyBhbnlcbiAgICAgIH0sXG4gICAgICBzeXN0ZW06IHRoaXNcbiAgICB9XG5cbiAgICBjb25zdCBpbnN0YW5jZSA9IGN0b3IuZmFjdG9yeSA/IGN0b3IuZmFjdG9yeShjdG9yLCBhcGlPcHRpb25zKSA6IG5ldyBjdG9yKGFwaU9wdGlvbnMpXG5cbiAgICB0aGlzLmFwaUluc3RhbmNlcy5zZXQoYXBpTmFtZSwgaW5zdGFuY2UpXG5cbiAgICByZXR1cm4gaW5zdGFuY2VcbiAgfVxuXG4gIC8qKlxuICAgKiBQcmVsb2FkcyBhIGxpc3Qgb2YgY29tcG9uZW50c1xuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBSUENMb2FkQVBJcyhhcGlOYW1lczogc3RyaW5nW10pIHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmVcbiAgICBpZiAodHlwZW9mIGFwaU5hbWVzICE9PSAnb2JqZWN0JyB8fCAhKGFwaU5hbWVzIGluc3RhbmNlb2YgQXJyYXkpKSB7XG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdSUENMb2FkQ29tcG9uZW50cyhuYW1lcykgbmFtZSBtdXN0IGJlIGFuIGFycmF5IG9mIHN0cmluZ3MnKVxuICAgIH1cblxuICAgIGNvbnN0IG5vdEZvdW5kID0gYXBpTmFtZXNcbiAgICAgIC5tYXAobmFtZSA9PiAoeyBhcGk6IHRoaXMuZ2V0QVBJSW5zdGFuY2UobmFtZSksIG5hbWUgfSkpXG4gICAgICAuZmlsdGVyKCQgPT4gJC5hcGkgPT09IG51bGwpXG4gICAgICAubWFwKCQgPT4gJC5uYW1lKVxuXG4gICAgaWYgKG5vdEZvdW5kLmxlbmd0aCkge1xuICAgICAgY29uc3QgbWVzc2FnZSA9IGBDb21wb25lbnRzIG5vdCBmb3VuZCAke25vdEZvdW5kLmpvaW4oJywnKX1gXG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKG1lc3NhZ2UpXG4gICAgfVxuICB9XG59XG4iXX0=